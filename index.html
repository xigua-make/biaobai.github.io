<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊãºË±ÜÂõæÁ∫∏ÁîüÊàêÂô®-ÂèØÁà±Á≤âÁ∫¢Áâà</title>
    <style>
        /* --- Á≤âÁ∫¢Ëâ≤ÂèØÁà±È£éÊ†ºÂÖ®Â±ÄÊ†∑Âºè --- */
        :root {
            --primary-color: #FF69B4; /* ÁÉ≠ÊÉÖÁ≤âÁ∫¢ */
            --primary-hover: #FF1493; /* Ê∑±Á≤âÁ∫¢ */
            --accent-color: #FFB6C1; /* ÊµÖÁ≤âÁ∫¢ */
            --bg-primary: #FFF0F5; /* Ëñ∞Ë°£ËçâÁ∫¢ËÉåÊôØ */
            --bg-secondary: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #FF69B4;
            --border-color: #FFB6C1;
            --shadow-sm: 0 4px 8px rgba(255, 105, 180, 0.15);
            --shadow-md: 0 8px 16px rgba(255, 105, 180, 0.2);
            --shadow-lg: 0 12px 24px rgba(255, 105, 180, 0.25);
            --radius: 15px;
            --header-height: 70px;
            --tools-height: 15vh;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 50%, #FFD1DC 100%); 
            color: var(--text-primary); 
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        h1, h2, h3 { 
            font-weight: 700; 
            color: var(--primary-color);
            text-shadow: 2px 2px 4px rgba(255, 182, 193, 0.3);
        }
        
        button { 
            cursor: pointer; 
            border: none; 
            border-radius: 25px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            min-height: 44px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn { 
            padding: 0.8rem 1.4rem; 
            font-size: 1rem; 
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); 
            color: white; 
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
        }
        
        .btn:hover { 
            background: linear-gradient(45deg, var(--primary-hover), var(--primary-color)); 
            transform: translateY(-3px) scale(1.05); 
            box-shadow: var(--shadow-md); 
        }
        
        .btn-secondary { 
            background: linear-gradient(45deg, #FFC0CB, #FFB6C1); 
            color: white; 
        }
        
        .btn-icon { 
            background: rgba(255, 255, 255, 0.9); 
            color: var(--primary-color); 
            font-size: 1.2rem; 
            padding: 0.6rem; 
            border-radius: 50%; 
            width: 44px; 
            height: 44px; 
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover { 
            background: var(--accent-color); 
            transform: scale(1.1) rotate(10deg);
        }
        
        .btn-icon.active { 
            background: var(--primary-color); 
            color: white; 
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 105, 180, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0); }
        }

        /* --- ÊøÄÊ¥ªÁïåÈù¢ÂèØÁà±È£éÊ†º --- */
        .activation-screen {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, #FF69B4 0%, #FFB6C1 50%, #FFC0CB 100%);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 10000;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .activation-card {
            background: white; 
            border-radius: 20px; 
            padding: 2.5rem;
            box-shadow: var(--shadow-lg); 
            max-width: 400px; 
            width: 90%;
            text-align: center;
            border: 3px solid var(--accent-color);
            position: relative;
            overflow: hidden;
        }

        .activation-card::before {
            content: 'üå∏';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }
        
        .activation-card h2 { 
            margin-bottom: 1.5rem; 
            color: var(--primary-color); 
            font-size: 1.5rem; 
        }
        
        .activation-input {
            width: 100%; 
            padding: 1rem; 
            border: 3px solid var(--border-color);
            border-radius: 25px; 
            font-size: 1rem; 
            margin-bottom: 1rem;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .activation-input:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 5px rgba(255, 105, 180, 0.2); 
            transform: scale(1.02);
        }
        
        .activation-error {
            color: #FF1493; 
            font-size: 0.9rem; 
            margin-bottom: 1rem;
            display: none; 
            padding: 0.8rem; 
            background: rgba(255, 20, 147, 0.1); 
            border-radius: 15px;
            border: 2px solid #FF1493;
        }
        
        .activation-success {
            color: #FF69B4; 
            font-size: 0.9rem; 
            margin-bottom: 1rem;
            display: none; 
            padding: 0.8rem; 
            background: rgba(255, 105, 180, 0.1); 
            border-radius: 15px;
            border: 2px solid var(--border-color);
        }
        
        .activation-info {
            font-size: 0.85rem; 
            color: var(--text-secondary);
            margin-top: 1.5rem; 
            line-height: 1.5;
            padding: 1rem;
            background: rgba(255, 182, 193, 0.1);
            border-radius: 15px;
        }

        /* --- ‰∏ªÁïåÈù¢ÂèØÁà±È£éÊ†º --- */
        .home-screen {
            display: none;
            min-height: 100vh;
            flex-direction: column;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 50%, #FFD1DC 100%);
            padding: 2rem 1rem;
            position: relative;
            overflow: hidden;
        }

        .home-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="100" fill="rgba(255,255,255,0.05)">üå∏</text></svg>');
            animation: float 20s infinite linear;
        }

        @keyframes float {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .home-header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
            position: relative;
            z-index: 1;
        }
        
        .home-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .home-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .home-upload-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }
        
        .home-upload-area {
            background: white;
            border-radius: 25px; 
            padding: 4rem 3rem;
            text-align: center; 
            box-shadow: var(--shadow-lg); 
            max-width: 500px;
            width: 100%;
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px dashed var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .home-upload-area::before {
            content: 'üì∏';
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            opacity: 0.3;
        }
        
        .home-upload-area:hover {
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 20px 40px rgba(255, 105, 180, 0.3); 
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--primary-hover);
        }
        
        .home-upload-area.dragover {
            background: rgba(255, 105, 180, 0.1); 
            border-color: var(--primary-hover);
            transform: scale(1.05);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            animation: pulse 2s infinite;
        }
        
        .upload-text {
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .upload-subtext {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        /* --- Â∫îÁî®ÁïåÈù¢ÂèØÁà±È£éÊ†º --- */
        .app-screen {
            display: none;
            min-height: 100vh;
            background: var(--bg-primary);
        }
        
        .app-header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--border-color);
            padding: 1rem;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .app-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(255, 105, 180, 0.2);
        }
        
        .app-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            max-width: 400px;
            line-height: 1.3;
        }
        
        .header-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        /* --- Âå∫ÂùóÂèØÁà±È£éÊ†º --- */
        .section {
            background: white;
            border-radius: var(--radius); 
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .section-title::before {
            content: 'üíï';
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        /* --- ‰∏ä‰º†Âå∫ÂüüÂèØÁà±È£éÊ†º --- */
        .upload-area {
            border: 3px dashed var(--primary-color); 
            border-radius: var(--radius); 
            padding: 2rem;
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s;
            background: rgba(255, 182, 193, 0.05);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-area:hover, .upload-area.dragover { 
            background: rgba(255, 105, 180, 0.1); 
            border-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        #file-input { display: none; }
        
        /* --- ÂìÅÁâåÈÄâÊã©Âå∫Âüü --- */
        .brand-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        
        .brand-btn {
            padding: 1rem;
            border: 2px solid var(--border-color);
            background: linear-gradient(45deg, rgba(255, 182, 193, 0.1), rgba(255, 192, 203, 0.1));
            border-radius: 15px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .brand-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 105, 180, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }
        
        .brand-btn:hover::before {
            animation: shimmer 0.5s ease-in-out;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }
        
        .brand-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        
        .brand-btn.active {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: scale(1.05);
        }
        
        /* --- È¢úËâ≤È¢ÑËÆæÂèØÁà±È£éÊ†º --- */
        .preset-buttons { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 0.8rem; 
        }
        
        .preset-btn { 
            padding: 1rem; 
            border: 2px solid var(--border-color); 
            background: linear-gradient(45deg, rgba(255, 182, 193, 0.1), rgba(255, 192, 203, 0.1)); 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 0.95rem; 
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            text-align: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .preset-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 105, 180, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }
        
        .preset-btn:hover::before {
            animation: shimmer 0.5s ease-in-out;
        }
        
        .preset-btn:hover {
            transform: translateY(-3px) scale(1.05); 
            box-shadow: var(--shadow-md); 
            border-color: var(--primary-color);
        }
        
        .preset-btn.active { 
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); 
            color: white; 
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: scale(1.05);
        }
        
        .custom-color-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
            gap: 8px; 
            max-height: 200px; 
            overflow-y: auto;
            border: 2px solid var(--border-color); 
            padding: 1rem; 
            border-radius: var(--radius); 
            margin-top: 1rem;
        }
        
        .color-swatch {
            width: 32px; 
            height: 32px; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid #fff; 
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .color-swatch:hover {
            transform: scale(1.2) rotate(5deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .color-swatch.active { 
            box-shadow: 0 0 0 3px var(--primary-color); 
            transform: scale(1.15);
        }
        
        /* --- ËÆæÁΩÆÂå∫ÂüüÂèØÁà±È£éÊ†º --- */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .setting-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* ‰øÆÂ§çÔºöÊªëÂä®Êù°ÂÆπÂô®Ê†∑Âºè - ÁßªÈô§Ëøá‰∫é‰∏•Ê†ºÁöÑËß¶Êë∏ÈôêÂà∂ */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        /* ‰øÆÂ§çÔºöÊªëÂä®Êù°Ê†∑Âºè - ÁßªÈô§Ëøá‰∫é‰∏•Ê†ºÁöÑËß¶Êë∏ÈôêÂà∂ */
        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(255, 105, 180, 0.3);
            transition: all 0.3s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(255, 105, 180, 0.3);
            transition: all 0.3s;
        }
        
        .slider-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
            background: rgba(255, 105, 180, 0.1);
            padding: 0.5rem;
            border-radius: 15px;
        }
        
        /* Êñ∞Â¢ûÔºöÊâãÂä®ËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .slider-input {
            width: 80px;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-color);
            transition: all 0.3s;
            /* ‰øÆÂ§çÔºöÁßªÂä®Á´ØÂ≠ó‰ΩìÂ§ßÂ∞èÈò≤Ê≠¢Áº©Êîæ */
            font-size: 16px !important;
            /* ÁßªÈô§Âπ≤Êâ∞Â±ûÊÄß */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .slider-input:focus {
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
            transform: scale(1.02);
        }
        
        .size-inputs { 
            display: grid; 
            grid-template-columns: 1fr auto 1fr; 
            gap: 0.5rem; 
            align-items: center;
        }
        
        .size-inputs input { 
            padding: 0.8rem; 
            border: 2px solid var(--border-color); 
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            /* ‰øÆÂ§çÔºöÁßªÂä®Á´ØÂ≠ó‰ΩìÂ§ßÂ∞èÈò≤Ê≠¢Áº©Êîæ */
            font-size: 16px !important;
        }
        
        .size-inputs input:focus {
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
        }
        
        .size-inputs .separator {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        /* --- Á∫øÊù°Â¢ûÂº∫ÂäüËÉΩÊ†∑Âºè --- */
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .checkbox-option:hover {
            background: rgba(255, 105, 180, 0.1);
            transform: scale(1.02);
        }
        
        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-option label {
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        /* --- ÁîªÂ∏ÉÂå∫ÂüüÂèØÁà±È£éÊ†º --- */
        .canvas-section {
            background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
            border-radius: var(--radius); 
            padding: 2rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .canvas-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: sparkle 3s linear infinite;
        }

        @keyframes sparkle {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* ‰øÆÂ§çÔºöÂÖ®Êñ∞ÁöÑÂõæÁ∫∏È¢ÑËßàUIËÆæËÆ° - Ëß£ÂÜ≥Áº©ÊîæÂíåÊòæÁ§∫ÈóÆÈ¢ò */
        .canvas-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 0.8rem 1rem;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .zoom-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 36px;
            font-size: 0.9rem;
        }
        
        .zoom-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }
        
        .zoom-value {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--primary-color);
            background: rgba(255, 105, 180, 0.1);
            padding: 0.5rem;
            border-radius: 10px;
        }
        
        /* ‰øÆÂ§çÔºöËßÜÂè£ÂÆπÂô®Ê†∑Âºè - Ëß£ÂÜ≥Áº©ÊîæÂíåÊãñÊãΩÈóÆÈ¢ò */
        .canvas-viewport {
            position: relative;
            flex: 1;
            overflow: auto;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            background: #fff;
            border: 2px solid var(--accent-color);
            /* Á°Æ‰øùÂú®ÁßªÂä®Á´ØÂèØ‰ª•Ê≠£Â∏∏ÊªöÂä® */
            -webkit-overflow-scrolling: touch;
            cursor: grab;
            /* ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - ËÆæÁΩÆÂõ∫ÂÆöÂ∞∫ÂØ∏ÈÅøÂÖçÁ©∫ÁôΩÂå∫ÂüüÈóÆÈ¢ò */
            width: 100%;
            height: 500px;
            max-width: 100%;
            max-height: 70vh;
        }
        
        .canvas-viewport.dragging {
            cursor: grabbing;
        }
        
        .canvas-content {
            position: relative;
            display: inline-block;
            transform-origin: 0 0;
            transition: transform 0.2s ease;
            /* ‰øÆÂ§çÔºöÁ°Æ‰øùÂÜÖÂÆπ‰∏ç‰ºöË¢´Êà™Êñ≠ */
            min-width: 100%;
            min-height: 100%;
        }
        
        #pattern-canvas { 
            display: block; 
            border-radius: var(--radius); 
            cursor: crosshair; 
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges; 
            image-rendering: crisp-edges;
        }
        
        /* --- ÁºñËæëÊ®°ÂºèÂèØÁà±È£éÊ†º --- */
        .edit-mode-screen {
            display: none;
            min-height: 100vh;
            background: var(--bg-primary);
            flex-direction: column;
        }
        
        .edit-mode-header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--border-color);
            padding: 1rem;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .edit-mode-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .edit-mode-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .edit-mode-canvas-container {
            flex: 1;
            background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            height: calc(85vh - var(--header-height));
        }
        
        .edit-mode-tools {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            border-top: 2px solid var(--border-color);
            padding: 1rem;
            z-index: 998;
            box-shadow: 0 -4px 20px rgba(255, 105, 180, 0.15);
            backdrop-filter: blur(10px);
            height: var(--tools-height);
            max-height: 15vh;
            overflow-y: auto;
        }
        
        .edit-tools-grid {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: start;
        }
        
        .edit-tool-group {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .edit-tool-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .checkbox-group { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.8rem; 
        }
        
        .checkbox-group label { 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
            font-size: 0.9rem;
            transition: all 0.3s;
            padding: 0.5rem;
            border-radius: 10px;
        }
        
        .checkbox-group label:hover {
            background: rgba(255, 105, 180, 0.1);
            transform: scale(1.02);
        }
        
        .checkbox-group input[type="checkbox"] { 
            margin-right: 0.5rem; 
            width: 18px; 
            height: 18px;
            cursor: pointer;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
        }
        
        .action-btn {
            padding: 0.8rem;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        .action-btn.highlight {
            background: linear-gradient(45deg, var(--accent-color), var(--primary-color));
            color: white;
        }
        
        .action-btn.hide {
            background: linear-gradient(45deg, #FFC0CB, #FFB6C1);
            color: white;
        }
        
        .action-btn.clear {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .action-btn.download {
            background: linear-gradient(45deg, #FF69B4, #FF1493);
            color: white;
            grid-column: span 3;
        }
        
        .action-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* --- ‰∏ãËΩΩÂå∫ÂüüÂèØÁà±È£éÊ†º --- */
        .download-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .status-display {
            background: rgba(255, 182, 193, 0.1);
            border-radius: var(--radius);
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .status-label {
            color: var(--text-secondary);
        }
        
        .status-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* --- ËøõÂ∫¶Êù°ÂèØÁà±È£éÊ†º --- */
        .progress-container {
            margin-top: 1rem;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 6px;
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        /* --- Ë¥≠Áâ©Ê∏ÖÂçïÂèØÁà±È£éÊ†º --- */
        .shopping-list {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0;
            background: rgba(255, 255, 255, 0.98); 
            border-radius: var(--radius) var(--radius) 0 0; 
            box-shadow: 0 -4px 20px rgba(255, 105, 180, 0.15);
            padding: 1.5rem; 
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 997; 
            max-height: 50vh; 
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .shopping-list.visible { transform: translateY(0); }
        
        .shopping-list h3 { 
            font-size: 1.1rem; 
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .list-items { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 0.8rem; 
        }
        
        .list-item { 
            display: flex; 
            align-items: center; 
            gap: 0.6rem; 
            font-size: 0.85rem; 
            padding: 8px; 
            background: rgba(255, 182, 193, 0.1);
            border-radius: 10px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        
        .list-item:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .list-swatch { 
            width: 20px; 
            height: 20px; 
            border-radius: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* --- ÊµÆÂä®ÂÖÉÁ¥†ÂèØÁà±È£éÊ†º --- */
        .tooltip {
            position: fixed; 
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); 
            color: white; 
            padding: 12px 16px; 
            border-radius: 15px;
            font-size: 0.85rem; 
            pointer-events: none; 
            z-index: 1000; 
            white-space: nowrap;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            max-width: 200px;
        }
        
        .coordinate-display {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98); 
            padding: 20px; 
            border-radius: 20px;
            box-shadow: var(--shadow-lg); 
            z-index: 1002; 
            display: none;
            border: 3px solid var(--primary-color);
            backdrop-filter: blur(10px);
            max-width: 90%;
            width: 300px;
        }
        
        .coordinate-display h4 { margin-bottom: 12px; color: var(--primary-color); font-size: 1.1rem; }
        .coordinate-display p { margin: 8px 0; font-size: 0.95rem; }
        .color-preview { 
            display: inline-block; 
            width: 24px; 
            height: 24px; 
            border-radius: 4px; 
            vertical-align: middle; 
            margin-left: 8px; 
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* --- È¢úËâ≤ÈÄâÊã©Âô®ÂèØÁà±È£éÊ†º --- */
        .color-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1003;
            padding: 1rem;
        }
        
        .color-picker-content {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            width: 800px;
            box-shadow: var(--shadow-lg);
        }
        
        .color-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .color-picker-header h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
        }
        
        .color-picker-close {
            background: transparent;
            color: var(--text-secondary);
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .color-picker-close:hover {
            background: rgba(255, 182, 193, 0.1);
        }
        
        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
        }
        
        .color-picker-item {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .color-picker-item:hover {
            transform: scale(1.1) rotate(5deg);
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .color-picker-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
            transform: scale(1.05);
        }
        
        .color-picker-color {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .color-picker-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 4px;
            text-align: center;
        }

        /* --- È¢úËâ≤Êõ¥Êç¢ÂäüËÉΩÂºÄÂÖ≥Ê†∑Âºè --- */
        .color-replace-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem;
            background: rgba(255, 182, 193, 0.1);
            border-radius: 15px;
            margin-bottom: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--primary-color);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .toggle-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: opacity 0.3s;
        }

        /* --- iOS‰∏ãËΩΩÊèêÁ§∫Ê†∑Âºè --- */
        .ios-download-hint {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 2rem;
        }
        
        .ios-download-hint.visible {
            display: flex;
        }
        
        .ios-hint-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .ios-hint-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: 700;
        }
        
        .ios-hint-text {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .ios-hint-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border-color);
        }
        
        .ios-hint-steps {
            text-align: left;
            background: rgba(255, 182, 193, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .ios-hint-steps ol {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .ios-hint-steps li {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .ios-hint-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .ios-hint-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 44px;
        }
        
        .ios-hint-btn.primary {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            color: white;
        }
        
        .ios-hint-btn.secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .ios-hint-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* --- ÂìçÂ∫îÂºèËÆæËÆ° --- */
        @media (max-width: 768px) {
            .home-header h1 {
                font-size: 2rem;
            }
            
            .home-upload-area {
                padding: 2rem 1.5rem;
            }
            
            .app-header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .app-title {
                font-size: 1.2rem;
            }
            
            .content-grid {
                gap: 1.5rem;
            }
            
            .section {
                padding: 1rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .brand-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .edit-tools-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .download-buttons {
                grid-template-columns: 1fr;
            }
            
            .size-inputs {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .size-inputs .separator {
                display: none;
            }
            
            .custom-color-grid {
                grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
            }
            
            .color-swatch {
                width: 28px;
                height: 28px;
            }
            
            .color-picker-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
                gap: 8px;
            }
            
            .color-picker-item {
                width: 45px;
                height: 45px;
            }
            
            .color-picker-color {
                width: 30px;
                height: 30px;
            }
            
            .edit-mode-tools {
                height: 20vh;
                max-height: 20vh;
            }
            
            /* ‰øÆÂ§çÔºöÁßªÂä®Á´ØÁº©ÊîæÊéßÂà∂‰ºòÂåñ */
            .canvas-controls {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
            }
            
            .zoom-controls {
                order: 2;
            }
        }
        
        @media (max-width: 480px) {
            .home-header h1 {
                font-size: 1.5rem;
            }
            
            .home-upload-area {
                padding: 1.5rem 1rem;
            }
            
            .upload-icon {
                font-size: 3rem;
            }
            
            .upload-text {
                font-size: 1.1rem;
            }
            
            .main-content {
                padding: 1rem 0.5rem;
            }
            
            .section {
                padding: 0.75rem;
            }
            
            .canvas-section {
                padding: 1rem;
            }
            
            .edit-mode-canvas-container {
                padding: 1rem;
                height: calc(80vh - var(--header-height));
            }
            
            .edit-mode-tools {
                height: 20vh;
                max-height: 20vh;
                padding: 0.8rem;
            }
            
            .edit-tools-grid {
                gap: 0.6rem;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .zoom-controls {
                padding: 0.6rem;
            }
            
            .zoom-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
                min-height: 32px;
            }
            
            /* ÁßªÂä®Á´ØÊâãÂä®ËæìÂÖ•Ê°ÜÊ†∑ÂºèË∞ÉÊï¥ */
            .slider-input {
                width: 70px;
                font-size: 16px !important; /* ‰øùÊåÅ16pxÈò≤Ê≠¢iOSÁº©Êîæ */
                padding: 0.4rem;
            }
        }

        /* --- ÂÉèÁ¥†È£éË£ÖÈ•∞ÂÖÉÁ¥† --- */
        .pixel-decoration {
            position: absolute;
            font-size: 20px;
            opacity: 0.1;
            pointer-events: none;
            animation: pixelFloat 6s infinite ease-in-out;
        }

        @keyframes pixelFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }

        .pixel-decoration:nth-child(1) { top: 10%; left: 5%; animation-delay: 0s; }
        .pixel-decoration:nth-child(2) { top: 20%; right: 10%; animation-delay: 1s; }
        .pixel-decoration:nth-child(3) { bottom: 15%; left: 8%; animation-delay: 2s; }
        .pixel-decoration:nth-child(4) { bottom: 25%; right: 5%; animation-delay: 3s; }
        .pixel-decoration:nth-child(5) { top: 50%; left: 50%; animation-delay: 4s; }

        /* ‰øÆÂ§çÔºöÂ¢ûÂº∫ÁßªÂä®Á´ØÊªëÂä®Êù°Ë°®Áé∞ */
        @media (pointer: coarse) {
            .slider {
                height: 12px;
            }
            
            .slider::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }
            
            .slider::-moz-range-thumb {
                width: 28px;
                height: 28px;
                border: 2px solid white;
            }
        }
        
        /* Ê∑ªÂä†ÈúáÂä®Âä®Áîª */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

<!-- ÂÉèÁ¥†È£éË£ÖÈ•∞ÂÖÉÁ¥† -->
<div class="pixel-decoration">üå∏</div>
<div class="pixel-decoration">üå∑</div>
<div class="pixel-decoration">üåπ</div>
<div class="pixel-decoration">üå∫</div>
<div class="pixel-decoration">üåº</div>

<!-- Activation Screen -->
<div class="activation-screen" id="activation-screen">
    <div class="activation-card">
        <h2>üîê ÊøÄÊ¥ªÈ™åËØÅ</h2>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary); font-size: 0.95rem;">ËØ∑ËæìÂÖ•ÊøÄÊ¥ªÁ†Å‰ª•‰ΩøÁî®ÊãºË±ÜÂõæÁ∫∏ÁîüÊàêÂô®</p>
        <input type="password" class="activation-input" id="activation-code" placeholder="ËØ∑ËæìÂÖ•ÊøÄÊ¥ªÁ†Å" maxlength="6">
        <div class="activation-error" id="activation-error">ÊøÄÊ¥ªÁ†ÅÈîôËØØÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•</div>
        <div class="activation-success" id="activation-success">ÊøÄÊ¥ªÊàêÂäüÔºÅÊ≠£Âú®ËøõÂÖ•...</div>
        <button class="btn btn-primary" id="activate-btn" style="width: 100%;">ÊøÄÊ¥ª‰ΩøÁî®</button>
        <div class="activation-info">
            Â¶ÇÈúÄËé∑ÂèñÊøÄÊ¥ªÁ†ÅÔºåËØ∑ËÅîÁ≥ª<br>
            <strong>Ê∑òÂÆùÂ∫óÈì∫ÔºöÂ§ßÂ∏àÁ≤æÂìÅËµÑÊñô</strong>
        </div>
    </div>
</div>

<!-- iOS‰∏ãËΩΩÊèêÁ§∫ÂºπÁ™ó -->
<div class="ios-download-hint" id="ios-download-hint">
    <div class="ios-hint-content">
        <h3 class="ios-hint-title">üì± iOS‰∏ãËΩΩÊèêÁ§∫</h3>
        <p class="ios-hint-text">Áî±‰∫éiOSÁ≥ªÁªüÈôêÂà∂ÔºåËØ∑Êåâ‰ª•‰∏ãÊ≠•È™§‰øùÂ≠òÂõæÁ∫∏Ôºö</p>
        
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 200'%3E%3Crect width='300' height='200' fill='%23f0f0f0'/%3E%3Ctext x='150' y='100' text-anchor='middle' font-size='14' fill='%23666'%3EÈïøÊåâÂõæÁâá‰øùÂ≠òÂà∞Áõ∏ÂÜå%3C/text%3E%3C/svg%3E" alt="‰øùÂ≠òÊèêÁ§∫" class="ios-hint-image">
        
        <div class="ios-hint-steps">
            <ol>
                <li>ÁÇπÂáª‰∏ãÊñπ"Êü•ÁúãÂõæÁâá"ÊåâÈíÆ</li>
                <li>Âú®Êñ∞È°µÈù¢‰∏≠ÈïøÊåâÂõæÁâá</li>
                <li>ÈÄâÊã©"Â≠òÂÇ®Âà∞Áõ∏ÂÜå"</li>
                <li>Âú®Áõ∏ÂÜå‰∏≠ÊâæÂà∞‰øùÂ≠òÁöÑÂõæÁ∫∏</li>
            </ol>
        </div>
        
        <div class="ios-hint-buttons">
            <button class="ios-hint-btn secondary" id="ios-hint-close">ÂÖ≥Èó≠</button>
            <button class="ios-hint-btn primary" id="ios-hint-view">Êü•ÁúãÂõæÁâá</button>
        </div>
    </div>
</div>

<!-- Home Screen (Upload Only) -->
<div class="home-screen" id="home-screen">
    <div class="home-header">
        <h1>üå∏ ÊãºË±ÜÂõæÁ∫∏ÁîüÊàêÂô®-Ë•øÁìúÂì•Âà∂‰Ωú üå∏</h1>
        <p>‰∏ì‰∏öÁöÑÊãºË±ÜÂõæÊ°àÂà∂‰ΩúÂ∑•ÂÖ∑ÔºåÈõÜÂ∏ÇÈù¢È°∂Â∞ñÊãºË±ÜËΩ¨Êç¢ÊäÄÊúØ‰∫é‰∏Ä‰ΩìÁöÑÁ®ãÂ∫è</p>
    </div>
    <div class="home-upload-container">
        <div class="home-upload-area" id="home-upload-area">
            <div class="upload-icon">üì∏</div>
            <div class="upload-text">ÁÇπÂáª‰∏ä‰º†ÂõæÁâá</div>
            <div class="upload-subtext">ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF Ê†ºÂºèÔºåÊàñÊãñÊãΩÂõæÁâáÂà∞Ê≠§Â§Ñ</div>
            <input type="file" id="home-file-input" accept="image/*">
        </div>
    </div>
</div>

<!-- Main App Screen -->
<div class="app-screen" id="app-screen">
    <header class="app-header">
        <div class="app-header-content">
            <div>
                <div class="app-title">ÊãºË±ÜÂõæÁ∫∏ÁîüÊàêÂô®-Ë•øÁìúÂì•Âà∂‰Ωú</div>
                <div class="app-subtitle">ÁõÆÂâç‰ªÖÊéàÊùÉ‰∫éÊ∑òÂÆùÂ∫óÈì∫ÔºöÂ§ßÂ∏àÁ≤æÂìÅËµÑÊñô ÁâàÊùÉÂùáÂ∑≤ÁôªËÆ∞ Â¶ÇÊúâÂèëÁé∞ÂÄíÂçñËÄÖÔºåËØ∑ËÅîÁ≥ªÊàë‰ª¨</div>
            </div>
            <div class="header-controls">
                <button class="btn-icon" id="new-image-btn" title="‰∏ä‰º†Êñ∞ÂõæÁâá">üì∑</button>
                <button class="btn-icon" id="edit-mode-btn" title="ÁÇπÂáªËøõÂÖ•ÁºñËæëÊ®°Âºè">‚úèÔ∏è</button>
                <button class="btn-icon" id="help-btn" title="Â∏ÆÂä©">‚ùì</button>
            </div>
        </div>
    </header>
    
    <main class="main-content">
        <div class="content-grid">
            <!-- Upload Section -->
            <section class="section">
                <h2 class="section-title">üì∑ ‰∏ä‰º†ÂõæÁâá</h2>
                <div class="upload-area" id="upload-area">
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">üìÅ ÁÇπÂáªÊàñÊãñÊãΩÂõæÁâáÂà∞Ê≠§Â§Ñ</p>
                    <p style="font-size:0.9rem; color:var(--text-secondary);">ÊîØÊåÅ JPG, PNG, GIF Ê†ºÂºè</p>
                    <input type="file" id="file-input" accept="image/*">
                </div>
            </section>

            <!-- Brand Selection Section -->
            <section class="section">
                <h2 class="section-title">üè∑Ô∏è Ëâ≤Âè∑ÈÄâÊã©</h2>
                <div class="brand-buttons" id="brand-buttons"></div>
            </section>

            <!-- Color Presets Section -->
            <section class="section">
                <h2 class="section-title">üé® È¢úËâ≤È¢ÑËÆæ</h2>
                <div class="preset-buttons" id="preset-buttons"></div>
                <div id="custom-color-section" style="display:none; margin-top: 1.5rem;">
                    <label style="font-size:0.95rem; font-weight: 500;">Ëá™ÂÆö‰πâÈ¢úËâ≤ (ÁÇπÂáªÈÄâÊã©):</label>
                    <div class="custom-color-grid" id="custom-color-grid"></div>
                    <button class="btn btn-primary" id="save-custom-palette" style="margin-top:1rem; width:100%;">‰øùÂ≠òËá™ÂÆö‰πâËâ≤Êùø</button>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="section">
                <h2 class="section-title">üìê ÂõæÁ∫∏ËÆæÁΩÆ</h2>
                <div class="settings-grid">
                    <!-- Á∫øÊù°Â¢ûÂº∫ÈÄâÈ°π -->
                    <div class="setting-group">
                        <div class="checkbox-option">
                            <input type="checkbox" id="useLineEnhance">
                            <label for="useLineEnhance">üñäÔ∏è Á∫øÊù°Â¢ûÂº∫ÔºàÈÄÇÂêàÂç°ÈÄö„ÄÅÂä®Êº´ÂõæÁâáÔºâ</label>
                        </div>
                    </div>
                    
                    <!-- Á∫øÊù°Âº∫Â∫¶ÊªëÂùó -->
                    <div class="setting-group" id="lineStrengthSection" style="display: none;">
                        <label class="setting-label">üéöÔ∏è Á∫øÊù°Âº∫Â∫¶Ôºö<span id="lineStrengthValue">3</span></label>
                        <div class="slider-container">
                            <input type="range" id="lineStrength" class="slider" min="1" max="10" value="3">
                            <span class="slider-value" id="lineStrengthDisplay">3</span>
                        </div>
                        <!-- Êñ∞Â¢ûÔºöÊâãÂä®ËæìÂÖ•Ê°Ü -->
                        <div class="slider-container">
                            <label style="font-size: 0.8rem; color: var(--text-secondary); min-width: 60px;">ÊâãÂä®ËæìÂÖ•:</label>
                            <input type="tel" id="lineStrengthInput" class="slider-input" min="1" max="10" value="3">
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #999; margin-top: 0.3rem;">
                            <span>ÁªÜÁ∫øÊù°</span>
                            <span>Á≤óÁ∫øÊù°</span>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">Áõ∏‰ººÂ∫¶ÈòàÂÄº (ÊéßÂà∂È¢úËâ≤ÂêàÂπ∂)</label>
                        <div class="slider-container">
                            <input type="range" id="similarity-threshold" class="slider" min="10" max="100" value="30">
                            <span class="slider-value" id="threshold-display">30</span>
                        </div>
                        <!-- Êñ∞Â¢ûÔºöÊâãÂä®ËæìÂÖ•Ê°Ü -->
                        <div class="slider-container">
                            <label style="font-size: 0.8rem; color: var(--text-secondary); min-width: 60px;">ÊâãÂä®ËæìÂÖ•:</label>
                            <input type="tel" id="similarityThresholdInput" class="slider-input" min="10" max="100" value="30">
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">ÂõæÁ∫∏Â∞∫ÂØ∏ÔºàÁΩëÊ†ºÁ≤íÂ∫¶/ÊéßÂà∂ÁªÜËäÇÁ®ãÂ∫¶Ôºâ</label>
                        <div class="size-inputs">
                            <input type="tel" id="width-input" value="64" min="10" max="200" placeholder="ÂÆΩÂ∫¶">
                            <span class="separator">√ó</span>
                            <input type="tel" id="height-input" value="64" min="10" max="200" placeholder="È´òÂ∫¶">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="generate-btn" style="width:100%; margin-top:1.5rem; font-size: 1.1rem; padding: 1rem;">‚ú® ÁîüÊàêÂõæÁ∫∏</button>
                
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Â§ÑÁêÜ‰∏≠...</div>
                </div>
            </section>

            <!-- Canvas Section -->
            <section class="section">
                <h2 class="section-title">üñºÔ∏è ÂõæÁ∫∏È¢ÑËßà</h2>
                <div class="canvas-section" id="canvas-section">
                    <p style="color: var(--text-secondary); text-align: center;">ËØ∑‰∏ä‰º†ÂõæÁâáÂπ∂ÁÇπÂáªÁîüÊàêÂõæÁ∫∏</p>
                </div>
            </section>

            <!-- Download Section -->
            <section class="section">
                <h2 class="section-title">üíæ ‰∏ãËΩΩÂØºÂá∫</h2>
                <div class="download-buttons">
                    <button class="btn btn-primary" id="download-btn">üíæ ‰∏ãËΩΩÈ´òÊ∏ÖÂõæÁ∫∏</button>
                    <button class="btn btn-secondary" id="download-stats-btn">üìä ‰∏ãËΩΩÁªüËÆ°Âõæ</button>
                    <button class="btn btn-secondary" id="toggle-list-btn">üì¶ Êü•ÁúãÊùêÊñôÊ∏ÖÂçï</button>
                </div>
                
                <div class="status-display">
                    <div class="status-item">
                        <span class="status-label">Â§ÑÁêÜÊ®°Âºè:</span>
                        <span class="status-value" id="processing-mode">Êú™Â§ÑÁêÜ</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Âå∫ÂüüÂêàÂπ∂:</span>
                        <span class="status-value" id="merged-regions">0‰∏™Âå∫Âüü</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ËÉåÊôØÁßªÈô§:</span>
                        <span class="status-value" id="background-removed">Êú™ÊâßË°å</span>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<!-- Edit Mode Screen -->
<div class="edit-mode-screen" id="edit-mode-screen">
    <header class="edit-mode-header">
        <div class="edit-mode-header-content">
            <div class="edit-mode-title">üîß ÁºñËæëÊ®°Âºè</div>
            <div class="header-controls">
                <button class="btn-icon" id="back-to-main-btn" title="ËøîÂõû‰∏ªÁïåÈù¢">üîô</button>
                <button class="btn-icon" id="help-edit-btn" title="Â∏ÆÂä©">‚ùì</button>
            </div>
        </div>
    </header>
    
    <div class="edit-mode-canvas-container" id="edit-mode-canvas-container">
        <p style="color: var(--text-secondary); text-align: center;">ËØ∑ÂÖàÂú®‰∏ªÁïåÈù¢ÁîüÊàêÂõæÁ∫∏</p>
    </div>
    
    <div class="edit-mode-tools">
        <div class="edit-tools-grid">
            <!-- Á∫øÊù°Â¢ûÂº∫ÈÄâÈ°π -->
            <div class="edit-tool-group">
                <div class="edit-tool-label">üñäÔ∏è Á∫øÊù°Â¢ûÂº∫</div>
                <div class="checkbox-option">
                    <input type="checkbox" id="edit-useLineEnhance">
                    <label for="edit-useLineEnhance">ÂêØÁî®Á∫øÊù°Â¢ûÂº∫</label>
                </div>
                <div id="edit-lineStrengthSection" style="display: none; margin-top: 0.5rem;">
                    <label>Á∫øÊù°Âº∫Â∫¶Ôºö<span id="edit-lineStrengthValue">3</span></label>
                    <div class="slider-container">
                        <input type="range" id="edit-lineStrength" class="slider" min="1" max="10" value="3">
                        <span class="slider-value" id="edit-lineStrengthDisplay">3</span>
                    </div>
                    <!-- Êñ∞Â¢ûÔºöÊâãÂä®ËæìÂÖ•Ê°Ü -->
                    <div class="slider-container">
                        <label style="font-size: 0.8rem; color: var(--text-secondary); min-width: 60px;">ÊâãÂä®ËæìÂÖ•:</label>
                        <input type="tel" id="edit-lineStrengthInput" class="slider-input" min="1" max="10" value="3">
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #999; margin-top: 0.3rem;">
                        <span>ÁªÜÁ∫øÊù°</span>
                        <span>Á≤óÁ∫øÊù°</span>
                    </div>
                </div>
            </div>
            
            <!-- Áõ∏‰ººÂ∫¶ÈòàÂÄºÊéßÂà∂ -->
            <div class="edit-tool-group">
                <div class="edit-tool-label">üéØ Áõ∏‰ººÂ∫¶ÈòàÂÄº</div>
                <div class="slider-container">
                    <input type="range" id="edit-similarity-threshold" class="slider" min="10" max="100" value="30">
                    <span class="slider-value" id="edit-threshold-display">30</span>
                </div>
                <!-- Êñ∞Â¢ûÔºöÊâãÂä®ËæìÂÖ•Ê°Ü -->
                <div class="slider-container">
                    <label style="font-size: 0.8rem; color: var(--text-secondary); min-width: 60px;">ÊâãÂä®ËæìÂÖ•:</label>
                    <input type="tel" id="edit-similarityThresholdInput" class="slider-input" min="10" max="100" value="30">
                </div>
            </div>
            
            <!-- ‰øÆÂ§çÔºöÊ∑ªÂä†È¢úËâ≤Êõ¥Êç¢ÂäüËÉΩÂºÄÂÖ≥ -->
            <div class="edit-tool-group">
                <div class="edit-tool-label">üé® È¢úËâ≤Êõ¥Êç¢Ê®°Âºè</div>
                <!-- È¢úËâ≤Êõ¥Êç¢ÂäüËÉΩÂºÄÂÖ≥ -->
                <div class="color-replace-toggle" id="color-replace-toggle">
                    <div class="toggle-switch" id="color-replace-switch">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="toggle-label" style="font-weight: bold;">ÂÖ≥Èó≠</span>
                    <span class="toggle-label" style="opacity: 0.5;">ÂºÄÂêØ</span>
                </div>
            </div>
            
            <div class="edit-tool-group">
                <div class="edit-tool-label">ÊòæÁ§∫ÈÄâÈ°π</div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="edit-show-grid" checked>
                        <span>ÊòæÁ§∫ÁΩëÊ†º</span>
                    </label>
                    <label>
                        <input type="checkbox" id="edit-show-coords" checked>
                        <span>ÊòæÁ§∫ÂùêÊ†á</span>
                    </label>
                    <label>
                        <input type="checkbox" id="edit-show-colors" checked>
                        <span>ÊòæÁ§∫Ëâ≤Âè∑</span>
                    </label>
                </div>
            </div>
            
            <div class="edit-tool-group">
                <div class="edit-tool-label">È¢úËâ≤Êìç‰Ωú</div>
                <div class="action-buttons">
                    <button class="action-btn highlight" id="edit-highlight-btn">üîÜ È´ò‰∫Æ</button>
                    <button class="action-btn hide" id="edit-hide-btn">üëÅÔ∏è ÈöêËóè</button>
                    <button class="action-btn clear" id="edit-clear-highlight-btn">üîÑ Ê∏ÖÈô§</button>
                </div>
            </div>
            
            <div class="edit-tool-group">
                <div class="edit-tool-label">üíæ ‰∏ãËΩΩÂõæÁ∫∏</div>
                <button class="action-btn download" id="edit-download-btn">üíæ ‰∏ãËΩΩÈ´òÊ∏ÖÂõæÁ∫∏</button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Elements -->
<div class="tooltip" id="tooltip" style="display:none;"></div>
<div class="coordinate-display" id="coordinate-display">
    <h4>üé® Áè†Â≠ê‰ø°ÊÅØ</h4>
    <p>‰ΩçÁΩÆ: <span id="coord-position"></span></p>
    <p>ÂùêÊ†á: <span id="coord-alphabet"></span></p>
    <p>Ëâ≤Âè∑: <span id="coord-color"></span></p>
    <p>È¢úËâ≤: <span id="coord-hex"></span><span class="color-preview" id="coord-preview"></span></span></p>
    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
        <button class="btn btn-primary" id="replace-color-btn" style="flex: 1;">Êõ¥Êç¢È¢úËâ≤</button>
    </div>
</div>
<div class="shopping-list" id="shopping-list">
    <h3>üì¶ ÊùêÊñôÊ∏ÖÂçï</h3>
    <div class="list-items" id="list-items"></div>
</div>

<!-- Color Picker Modal -->
<div class="color-picker-modal" id="color-picker-modal">
    <div class="color-picker-content">
        <div class="color-picker-header">
            <h3>ÈÄâÊã©Êñ∞È¢úËâ≤</h3>
            <button class="color-picker-close" id="color-picker-close">√ó</button>
        </div>
        <div class="color-picker-grid" id="color-picker-grid"></div>
    </div>
</div>

<script>
// --- Activation System - ‰øÆÂ§çÁâà ---
const CORRECT_CODE = '884832';

// ‰øÆÂ§çÔºöÊøÄÊ¥ªÂáΩÊï∞ - ÈáçÂÜôÁ°Æ‰øùÊ≠£Â∏∏Â∑•‰Ωú
function activateApp() {
    console.log('=== ÂºÄÂßãÊøÄÊ¥ªÊµÅÁ®ã ===');
    
    const input = document.getElementById('activation-code');
    const errorDiv = document.getElementById('activation-error');
    const successDiv = document.getElementById('activation-success');
    const activateBtn = document.getElementById('activate-btn');
    
    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
    if (!input || !errorDiv || !successDiv || !activateBtn) {
        console.error('ÊøÄÊ¥ªÁ≥ªÁªüÂÖÉÁ¥†Êú™ÊâæÂà∞', {
            input: !!input,
            errorDiv: !!errorDiv,
            successDiv: !!successDiv,
            activateBtn: !!activateBtn
        });
        alert('ÊøÄÊ¥ªÁ≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        return;
    }
    
    const inputValue = input.value ? input.value.trim() : '';
    console.log('ËæìÂÖ•ÁöÑÊøÄÊ¥ªÁ†Å:', inputValue, 'ÈïøÂ∫¶:', inputValue.length);
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÁä∂ÊÄÅ
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    if (!inputValue) {
        errorDiv.textContent = 'ËØ∑ËæìÂÖ•ÊøÄÊ¥ªÁ†Å';
        errorDiv.style.display = 'block';
        console.error('ÈîôËØØÔºöÊøÄÊ¥ªÁ†Å‰∏∫Á©∫');
        input.focus();
        return;
    }
    
    if (inputValue === CORRECT_CODE) {
        console.log('‚úÖ ÊøÄÊ¥ªÁ†ÅÈ™åËØÅÈÄöËøá');
        
        // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
        successDiv.textContent = 'ÊøÄÊ¥ªÊàêÂäüÔºÅÊ≠£Âú®ËøõÂÖ•...';
        successDiv.style.display = 'block';
        activateBtn.textContent = 'ÊøÄÊ¥ªÊàêÂäü';
        
        // Á´ãÂç≥‰øùÂ≠òÊøÄÊ¥ªÁä∂ÊÄÅ
        try {
            localStorage.setItem('activated', 'true');
            localStorage.setItem('activation_time', new Date().toISOString());
            console.log('ÊøÄÊ¥ªÁä∂ÊÄÅÂ∑≤‰øùÂ≠òÂà∞localStorage');
        } catch (e) {
            console.error('‰øùÂ≠òÊøÄÊ¥ªÁä∂ÊÄÅÂ§±Ë¥•:', e);
        }
        
        // Á¶ÅÁî®ËæìÂÖ•ÂíåÊåâÈíÆ
        input.disabled = true;
        activateBtn.disabled = true;
        
        // Âª∂ËøüÂàáÊç¢ÁïåÈù¢ÔºåÁ°Æ‰øùÁî®Êà∑ÁúãÂà∞ÊàêÂäüÊèêÁ§∫
        setTimeout(() => {
            try {
                console.log('ÂºÄÂßãÂàáÊç¢Âà∞‰∏ªÁïåÈù¢...');
                
                // ÂÖàÈöêËóèÊøÄÊ¥ªÁïåÈù¢
                document.getElementById('activation-screen').style.display = 'none';
                
                // ÊòæÁ§∫‰∏ªÁïåÈù¢
                const homeScreen = document.getElementById('home-screen');
                if (homeScreen) {
                    homeScreen.style.display = 'flex';
                    console.log('‚úÖ È°µÈù¢ÂàáÊç¢ÊàêÂäü');
                    
                    // ÂèØÈÄâÔºöÊ∏ÖÈô§ËæìÂÖ•Ê°ÜÂÜÖÂÆπ
                    input.value = '';
                } else {
                    console.error('‰∏ªÁïåÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞');
                    alert('È°µÈù¢ÂàáÊç¢Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
                }
            } catch (error) {
                console.error('È°µÈù¢ÂàáÊç¢Âá∫Èîô:', error);
                alert('È°µÈù¢ÂàáÊç¢Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }, 1000); // Âª∂Ëøü1ÁßíÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÊàêÂäüÊèêÁ§∫
        
    } else {
        console.log('‚ùå ÊøÄÊ¥ªÁ†ÅÈ™åËØÅÂ§±Ë¥•');
        
        errorDiv.textContent = `ÊøÄÊ¥ªÁ†ÅÈîôËØØÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•`;
        errorDiv.style.display = 'block';
        
        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂ÈáçÊñ∞ËÅöÁÑ¶
        input.value = '';
        input.focus();
        
        // Ê∑ªÂä†ÈúáÂä®ÊïàÊûúÊèêÁ§∫ÈîôËØØ
        input.style.animation = 'shake 0.5s';
        setTimeout(() => {
            input.style.animation = '';
        }, 500);
        
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 3000);
    }
}

// ‰øÆÂ§çÔºöÂàùÂßãÂåñÊøÄÊ¥ªÁ≥ªÁªü - ÈáçÂÜôÁ°Æ‰øù‰∫ã‰ª∂Ê≠£Á°ÆÁªëÂÆö
function initializeActivation() {
    console.log('=== ÂàùÂßãÂåñÊøÄÊ¥ªÁ≥ªÁªü ===');
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊøÄÊ¥ª
    try {
        if (localStorage.getItem('activated') === 'true') {
            console.log('Áî®Êà∑Â∑≤ÊøÄÊ¥ªÔºåÁõ¥Êé•ËøõÂÖ•‰∏ªÂ∫îÁî®');
            document.getElementById('activation-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
            return;
        }
    } catch (e) {
        console.error('Ê£ÄÊü•ÊøÄÊ¥ªÁä∂ÊÄÅÂ§±Ë¥•:', e);
    }
    
    // Ëé∑ÂèñÊøÄÊ¥ªÁõ∏ÂÖ≥ÂÖÉÁ¥†
    const activateBtn = document.getElementById('activate-btn');
    const activationInput = document.getElementById('activation-code');
    
    if (!activateBtn || !activationInput) {
        console.error('ÊøÄÊ¥ªÊåâÈíÆÊàñËæìÂÖ•Ê°ÜÊú™ÊâæÂà∞ÔºåÂª∂ËøüÈáçËØï...');
        // Âª∂ËøüÈáçËØï
        setTimeout(initializeActivation, 100);
        return;
    }
    
    console.log('ÊâæÂà∞ÊøÄÊ¥ªÂÖÉÁ¥†ÔºåÂºÄÂßãÁªëÂÆö‰∫ã‰ª∂...');
    
    // ‰øÆÂ§çÔºöÁõ¥Êé•ÁªëÂÆö‰∫ã‰ª∂Ôºå‰∏ç‰ΩøÁî®cloneNode
    function handleActivate(event) {
        console.log('ÊøÄÊ¥ªÊåâÈíÆË¢´ÁÇπÂáª', event);
        event.preventDefault();
        event.stopPropagation();
        activateApp();
    }
    
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            console.log('ÂõûËΩ¶ÈîÆÊøÄÊ¥ª');
            event.preventDefault();
            event.stopPropagation();
            activateApp();
        }
    }
    
    // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÊúâÔºâ
    activateBtn.removeEventListener('click', handleActivate);
    activationInput.removeEventListener('keypress', handleKeyPress);
    
    // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
    activateBtn.addEventListener('click', handleActivate);
    activationInput.addEventListener('keypress', handleKeyPress);
    
    // Ê∑ªÂä†ÊåâÈíÆËßÜËßâÂèçÈ¶à
    activateBtn.addEventListener('mousedown', function() {
        this.style.transform = 'scale(0.98)';
    });
    
    activateBtn.addEventListener('mouseup', function() {
        this.style.transform = 'scale(1)';
    });
    
    activateBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });
    
    // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
    setTimeout(() => {
        activationInput.focus();
    }, 100);
    
    console.log('‚úÖ ÊøÄÊ¥ªÁ≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');
}

// ‰øÆÂ§çÔºöÁ°Æ‰øùDOMÂä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMÂÜÖÂÆπÂä†ËΩΩÂÆåÊàê ===');
    initializeActivation();
});

// È¢ùÂ§ñÁöÑÂ§áÁî®ÂàùÂßãÂåñ
window.addEventListener('load', function() {
    console.log('=== È°µÈù¢ÂÆåÂÖ®Âä†ËΩΩÂÆåÊàê ===');
    
    // Ê£ÄÊü•ÊøÄÊ¥ªÁ≥ªÁªüÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú
    const activateBtn = document.getElementById('activate-btn');
    const activationInput = document.getElementById('activation-code');
    
    if (activateBtn && activationInput) {
        // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const hasClickListener = activateBtn.onclick || activateBtn.hasAttribute('data-click-bound');
        if (!hasClickListener) {
            console.log('Ê£ÄÊµãÂà∞ÊøÄÊ¥ªÁ≥ªÁªüÊú™Ê≠£Á°ÆÂàùÂßãÂåñÔºåÈáçÊñ∞ÂàùÂßãÂåñ...');
            initializeActivation();
            activateBtn.setAttribute('data-click-bound', 'true');
        }
    } else {
        console.error('ÊøÄÊ¥ªÁ≥ªÁªüÂÖÉÁ¥†‰ªçÊú™ÊâæÂà∞ÔºåÂèØËÉΩÂ≠òÂú®HTMLÈóÆÈ¢ò');
    }
});

// ‰øÆÂ§çÔºöÊ∑ªÂä†ÊâãÂä®ÈáçÁΩÆÊøÄÊ¥ªÁä∂ÊÄÅÁöÑÂäüËÉΩÔºàÂºÄÂèëË∞ÉËØïÁî®Ôºâ
window.resetActivation = function() {
    try {
        localStorage.removeItem('activated');
        localStorage.removeItem('activation_time');
        location.reload();
    } catch (e) {
        console.error('ÈáçÁΩÆÊøÄÊ¥ªÁä∂ÊÄÅÂ§±Ë¥•:', e);
    }
};

// --- iOS ‰∏ãËΩΩ‰øÆÂ§çÂáΩÊï∞ ---

// Ê£ÄÊµãÊòØÂê¶‰∏∫iOSËÆæÂ§á
function isIOS() {
    return [
        'iPad Simulator',
        'iPhone Simulator',
        'iPod Simulator',
        'iPad',
        'iPhone',
        'iPod'
    ].includes(navigator.platform) ||
    (navigator.userAgent.includes("Mac") && "ontouchend" in document) ||
    (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad') || navigator.userAgent.includes('iPod'));
}

// iOS‰∏ãËΩΩÂáΩÊï∞ - ‰øÆÂ§çÁâàÊú¨
function downloadPatternForIOS(canvas, filename) {
    console.log('‰ΩøÁî®iOS‰∏ãËΩΩÊñπÊ≥ï');
    
    // ‰ΩøÁî®toBlobÁîüÊàêBlobÂØπË±°
    canvas.toBlob(function(blob) {
        if (!blob) {
            console.error('ÁîüÊàêBlobÂ§±Ë¥•');
            alert('ÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            return;
        }
        
        // ÂàõÂª∫‰∏¥Êó∂URL
        const url = URL.createObjectURL(blob);
        
        // ÊòæÁ§∫iOS‰∏ãËΩΩÊèêÁ§∫
        const iosHint = document.getElementById('ios-download-hint');
        const viewBtn = document.getElementById('ios-hint-view');
        const closeBtn = document.getElementById('ios-hint-close');
        
        // ËÆæÁΩÆÊü•ÁúãÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
        viewBtn.onclick = function() {
            // Âú®Êñ∞Á™óÂè£‰∏≠ÊâìÂºÄÂõæÁâá
            window.open(url, '_blank');
            
            // ÂÖ≥Èó≠ÊèêÁ§∫
            iosHint.classList.remove('visible');
            
            // Âª∂ËøüÊ∏ÖÁêÜURLÔºåÁªôÁî®Êà∑Ë∂≥Â§üÊó∂Èó¥Êü•Áúã
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 10000);
        };
        
        // ËÆæÁΩÆÂÖ≥Èó≠ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
        closeBtn.onclick = function() {
            iosHint.classList.remove('visible');
            URL.revokeObjectURL(url);
        };
        
        // ÊòæÁ§∫ÊèêÁ§∫
        iosHint.classList.add('visible');
        
    }, 'image/png', 0.95);
}

// ÈÄöÁî®‰∏ãËΩΩÂáΩÊï∞ - ÊîØÊåÅÊâÄÊúâÂπ≥Âè∞
function downloadPatternUniversal(canvas, filename) {
    console.log('‰ΩøÁî®ÈÄöÁî®‰∏ãËΩΩÊñπÊ≥ï');
    
    // Ê£ÄÊµãiOSËÆæÂ§á
    if (isIOS()) {
        downloadPatternForIOS(canvas, filename);
        return;
    }
    
    // ÈùûiOSËÆæÂ§á‰ΩøÁî®Ê†áÂáÜ‰∏ãËΩΩÊñπÊ≥ï
    try {
        canvas.toBlob(function(blob) {
            if (!blob) {
                console.error('ÁîüÊàêBlobÂ§±Ë¥•');
                alert('ÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                return;
            }
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            
            // Á°Æ‰øùÈìæÊé•Ë¢´Ê∑ªÂä†Âà∞DOM‰∏≠
            document.body.appendChild(link);
            
            // Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂
            link.click();
            
            // Ê∏ÖÁêÜ
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
            
        }, 'image/png', 0.95);
        
    } catch (error) {
        console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
        alert('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
}

// --- Data & Configuration (All Brand Palettes) ---

// MARDËâ≤Êùø
const MARD_COLORS_FULL = {
    "A1": "#FAF4C8", "A2": "#FFFFD5", "A3": "#FEFF8B", "A4": "#FBED56", "A5": "#F4D738", "A6": "#FEAC4C", "A7": "#FE8B4C", "A8": "#FFDA45", "A9": "#FF995B", "A10": "#F77C31", "A11": "#FFDD99", "A12": "#FE9F72", "A13": "#FFC365", "A14": "#FD543D", "A15": "#FFF365", "A16": "#FFFF9F", "A17": "#FFE36E", "A18": "#FEBE7D", "A19": "#FD7C72", "A20": "#FFD568", "A21": "#FFE395", "A22": "#F4F57D", "A23": "#E6C9B7", "A24": "#F7F8A2", "A25": "#FFD67D", "A26": "#FFC830",
    "B1": "#E6EE31", "B2": "#63F347", "B3": "#9EF780", "B4": "#5DE035", "B5": "#35E352", "B6": "#65E2A6", "B7": "#3DAF80", "B8": "#1C9C4F", "B9": "#27523A", "B10": "#95D3C2", "B11": "#5D722A", "B12": "#166F41", "B13": "#CAEB7B", "B14": "#ADE946", "B15": "#2E5132", "B16": "#C5ED9C", "B17": "#9BB13A", "B18": "#E6EE49", "B19": "#24B88C", "B20": "#C2F0CC", "B21": "#156A6B", "B22": "#0B3C43", "B23": "#303A21", "B24": "#EEFCA5", "B25": "#4E846D", "B26": "#8D7A35", "B27": "#CCE1AF", "B28": "#9EE5B9", "B29": "#C5E254", "B30": "#E2FCB1", "B31": "#B0E792", "B32": "#9CAB5A",
    "C1": "#E8FFE7", "C2": "#A9F9FC", "C3": "#A0E2FB", "C4": "#41CCFF", "C5": "#01ACEB", "C6": "#50AAF0", "C7": "#3677D2", "C8": "#0F54C0", "C9": "#324BCA", "C10": "#3EBCE2", "C11": "#28DDDE", "C12": "#1C334D", "C13": "#CDE8FF", "C14": "#D5FDFF", "C15": "#22C4C6", "C16": "#1557A8", "C17": "#04D1F6", "C18": "#1D3344", "C19": "#1887A2", "C20": "#176DAF", "C21": "#BEDDFF", "C22": "#67B4BE", "C23": "#C8E2FF", "C24": "#7CC4FF", "C25": "#A9E5E5", "C26": "#3CAED8", "C27": "#D3DFFA", "C28": "#BBCFED", "C29": "#34488E",
    "D1": "#AEB4F2", "D2": "#858EDD", "D3": "#2F54AF", "D4": "#182A84", "D5": "#B843C5", "D6": "#AC7BDE", "D7": "#8854B3", "D8": "#E2D3FF", "D9": "#D5B9F8", "D10": "#361B51", "D11": "#B9BAE1", "D12": "#DE9AD4", "D13": "#B90095", "D14": "#8B279B", "D15": "#2F1F90", "D16": "#E3E1EE", "D17": "#C4D4F6", "D18": "#A45EC7", "D19": "#D8C3D7", "D20": "#9C32B2", "D21": "#9A009B", "D22": "#333A95", "D23": "#EBDAFC", "D24": "#7786E5", "D25": "#494FC7", "D26": "#DFC2F8",
    "E1": "#FDD3CC", "E2": "#FEC0DF", "E3": "#FFB7E7", "E4": "#E8649E", "E5": "#F551A2", "E6": "#F13D74", "E7": "#C63478", "E8": "#FFDBE9", "E9": "#E970CC", "E10": "#D33793", "E11": "#FCDDD2", "E12": "#F78FC3", "E13": "#B5006D", "E14": "#FFD1BA", "E15": "#F8C7C9", "E16": "#FFF3EB", "E17": "#FFE2EA", "E18": "#FFC7DB", "E19": "#FEBAD5", "E20": "#D8C7D1", "E21": "#BD9DA1", "E22": "#B785A1", "E23": "#937A8D", "E24": "#FFFF00",
    "F1": "#FD957B", "F2": "#FC3D46", "F3": "#F74941", "F4": "#FC283C", "F5": "#E7002F", "F6": "#943630", "F7": "#971937", "F8": "#BC0028", "F9": "#E2677A", "F10": "#8A4526", "F11": "#5A2121", "F12": "#FD4E6A", "F13": "#F35744", "F14": "#FFA9AD", "F15": "#D30022", "F16": "#FEC2A6", "F17": "#E69C79", "F18": "#D37C46", "F19": "#C1444A", "F20": "#CD9391", "F21": "#F7B4C6", "F22": "#FDC0D0", "F23": "#F67E66", "F24": "#E698AA", "F25": "#E54B4F",
    "G1": "#FFE2CE", "G2": "#FFC4AA", "G3": "#F4C3A5", "G4": "#E1B383", "G5": "#EDB045", "G6": "#E99C17", "G7": "#9D5B3E", "G8": "#753B32", "G9": "#E6B483", "G10": "#D98C39", "G11": "#E0C593", "G12": "#FFC890", "G13": "#B7714A", "G14": "#8D614C", "G15": "#FCF9E0", "G16": "#F2D9BA", "G17": "#7B524B", "G18": "#FFE4CC", "G19": "#E07935", "G20": "#A94023", "G21": "#B88558",
    "H1": "#FDFBFF", "H2": "#FEFFFF", "H3": "#B6B1BA", "H4": "#89858C", "H5": "#48464E", "H6": "#2F2B2F", "H7": "#000000", "H8": "#E7D6DB", "H9": "#EDEDED", "H10": "#EEE9EA", "H11": "#CECDD5", "H12": "#FFF5ED", "H13": "#F5ECD2", "H14": "#CFD7D3", "H15": "#98A6A8", "H16": "#1D1414", "H17": "#F1EDED", "H18": "#FFFDF0", "H19": "#F6EFE2", "H20": "#949FA3", "H21": "#FFFBE1", "H22": "#CACAD4", "H23": "#9A9D94",
    "M1": "#BCC6B8", "M2": "#8AA386", "M3": "#697D80", "M4": "#E3D2BC", "M5": "#D0CCAA", "M6": "#B0A782", "M7": "#B4A497", "M8": "#B38281", "M9": "#A58767", "M10": "#C5B2BC", "M11": "#9F7594", "M12": "#644749", "M13": "#D19066", "M14": "#C77362", "M15": "#757D7B",
    "P1": "#FCF7F8", "P2": "#B0A9AC", "P3": "#AFDCAB", "P4": "#FEA49F", "P5": "#EE8C3E", "P6": "#5FD0A7", "P7": "#EB9270", "P8": "#F0D958", "P9": "#D9D9D9", "P10": "#D9C7EA", "P11": "#F3ECC9", "P12": "#E6EEF2", "P13": "#AACBEF", "P14": "#3376B0", "P15": "#668575", "P16": "#FEBF45", "P17": "#FEA324", "P18": "#FEB89F", "P19": "#FFE0E9", "P20": "#FEBECF", "P21": "#ECBEBF", "P22": "#E4A89F", "P23": "#A56268",
    "Q1": "#F2A5E8", "Q2": "#E9EC91", "Q3": "#FFFF00", "Q4": "#FFEBFA", "Q5": "#76CEDE",
    "R1": "#D50D21", "R2": "#F92F83", "R3": "#FD8324", "R4": "#F8EC31", "R5": "#35C75B", "R6": "#23B891", "R7": "#19779D", "R8": "#1A60C3", "R9": "#9A56B4", "R10": "#FFDB4C", "R11": "#FFEBFA", "R12": "#D8D5CE", "R13": "#55514C", "R14": "#9FE4DF", "R15": "#77CEE9", "R16": "#3ECFCA", "R17": "#4A867A", "R18": "#7FCD9D", "R19": "#CDE55D", "R20": "#E8C7B4", "R21": "#AD6F3C", "R22": "#6C372F", "R23": "#FEB872", "R24": "#F3C1C0", "R25": "#C9675E", "R26": "#D293BE", "R27": "#EA8CB1", "R28": "#9C87D6",
    "T1": "#FFFFFF",
    "Y1": "#FD6FB4", "Y2": "#F24B94", "Y3": "#D7FAA0", "Y4": "#8BDBFA", "Y5": "#E987EA",
    "ZG1": "#DAABB3", "ZG2": "#D6AA87", "ZG3": "#C1BD8D", "ZG4": "#96B69F", "ZG5": "#849DC6", "ZG6": "#94BFE2", "ZG7": "#E2A9D2", "ZG8": "#AB91C0"
};

// ‰øÆÂ§çÔºöÂÖ∂‰ªñÂìÅÁâåËâ≤Êùø - ÈáçÊñ∞Êï¥ÁêÜÊï∞ÊçÆÊ†ºÂºèÔºåÁ°Æ‰øùÊ≤°ÊúâÈáçÂ§çÂíåÈîôËØØ
const BRAND_COLORS = {
    'MARD': MARD_COLORS_FULL,
    'COCO': {
        "E02": "#FAF4C8", "E01": "#FFFFD5", "E05": "#FEFF8B", "E07": "#FBED56", "E08": "#F4D738", 
        "E06": "#FEAC4C", "E04": "#FE8B4C", "E09": "#FFDA45", "E10": "#FF995B", "E03": "#F77C31", 
        "E11": "#FFDD99", "A18": "#FE9F72", "B13": "#FFC365", "B14": "#FD543D", "B15": "#FFF365", 
        "IC04": "#FFFF9F", "IC9": "#FFE36E", "IC14": "#FEBE7D", "IC15": "#FD7C72", "Q6": "#FFD568", 
        "R07": "#FFE395", "R06": "#F4F57D", "R08": "#E6C9B7", "G3": "#F7F8A2", "G4": "#FFD67D", 
        "G5": "#FFC830", "C1": "#E6EE31", "C2": "#63F347", "C7": "#9EF780", "C3": "#5DE035", 
        "C4": "#35E352", "C9": "#65E2A6", "C10": "#3DAF80", "C5": "#1C9C4F", "C6": "#27523A", 
        "C11": "#95D3C2", "C12": "#5D722A", "C13": "#166F41", "C14": "#CAEB7B", "C15": "#ADE946", 
        "C16": "#2E5132", "C17": "#C5ED9C", "C18": "#9BB13A", "C19": "#E6EE49", "DH15": "#24B88C", 
        "DH10": "#C2F0CC", "DH2": "#156A6B", "DH7": "#0B3C43", "DH12": "#303A21", "IC5": "#EEFCA5", 
        "Q13": "#4E846D", "Q7": "#8D7A35", "R10": "#CCE1AF", "R11": "#9EE5B9", "R09": "#C5E254", 
        "G6": "#E2FCB1", "G7": "#B0E792", "G12": "#9CAB5A", "C8": "#E8FFE7", "D1": "#A9F9FC", 
        "D2": "#A0E2FB", "D3": "#41CCFF", "D7": "#01ACEB", "D4": "#50AAF0", "D9": "#0F54C0", 
        "N5": "#324BCA", "D25": "#3EBCE2", "D28": "#28DDDE", "D26": "#1C334D", "D30": "#CDE8FF", 
        "D29": "#D5FDFF", "D31": "#22C4C6", "D32": "#1557A8", "D36": "#04D1F6", "DH6": "#1D3344", 
        "DH9": "#1887A2", "DH14": "#176DAF", "IC3": "#BEDDFF", "Q11": "#67B4BE", "R13": "#C8E2FF", 
        "R14": "#7CC4FF", "R12": "#A9E5E5", "R15": "#3CAED8", "G13": "#D3DFFA", "G14": "#BBCFED", 
        "G15": "#34488E", "D5": "#AEB4F2", "D6": "#858EDD", "D10": "#2F54AF", "D11": "#182A84", 
        "D13": "#B843C5", "D14": "#AC7BDE", "D16": "#8854B3", "D17": "#E2D3FF", "D19": "#D5B9F8", 
        "D15": "#361B51", "D20": "#B9BAE1", "D21": "#DE9AD4", "D22": "#B90095", "D23": "#8B279B", 
        "D24": "#2F1F90", "D18": "#E3E1EE", "D27": "#C4D4F6", "D33": "#A45EC7", "D34": "#D8C3D7", 
        "D35": "#9C32B2", "DH1": "#9A009B", "DH8": "#333A95", "IC8": "#EBDAFC", "Q14": "#7786E5", 
        "Q15": "#494FC7", "R01": "#DFC2F8", "K03": "#FDD3CC", "K17": "#FEC0DF", "K21": "#FFB7E7", 
        "K19": "#E8649E", "K25": "#F551A2", "K22": "#F13D74", "K12": "#C63478", "K18": "#FFDBE9", 
        "K23": "#E970CC", "K16": "#D33793", "K02": "#FCDDD2", "K08": "#F78FC3", "K24": "#B5006D", 
        "K05": "#FFD1BA", "K04": "#F8C7C9", "K01": "#FFF3EB", "K11": "#FFE2EA", "K13": "#FFC7DB", 
        "K14": "#FEBAD5", "K26": "#D8C7D1", "K27": "#BD9DA1", "K28": "#B785A1", "K29": "#937A8D", 
        "K30": "#FFFF00", "K08": "#FD957B", "C02": "#FC3D46", "C03": "#F74941", "C06": "#FC283C", 
        "C07": "#E7002F", "C09": "#943630", "C10": "#971937", "C11": "#BC0028", "C08": "#E2677A", 
        "C05": "#8A4526", "C01": "#5A2121", "K12": "#FD4E6A", "C04": "#F35744", "C09": "#FFA9AD", 
        "C10": "#D30022", "K18": "#FEC2A6", "K19": "#E69C79", "K20": "#D37C46", "K21": "#C1444A", 
        "K22": "#CD9391", "K23": "#F7B4C6", "K24": "#FDC0D0", "K25": "#F67E66", "K26": "#E698AA", 
        "K27": "#E54B4F", "Z02": "#FFE2CE", "Z05": "#FFC4AA", "Z06": "#F4C3A5", "Z08": "#E1B383", 
        "Z10": "#EDB045", "Z11": "#E99C17", "Z18": "#9D5B3E", "Z22": "#753B32", "Z09": "#E6B483", 
        "Z15": "#D98C39", "Z07": "#E0C593", "Z13": "#FFC890", "Z14": "#B7714A", "Z17": "#8D614C", 
        "Z04": "#FCF9E0", "Z03": "#F2D9BA", "Z16": "#7B524B", "Z01": "#FFE4CC", "Z12": "#E07935", 
        "Z19": "#A94023", "Z24": "#B88558", "A02": "#FDFBFF", "A01": "#FEFFFF", "B03": "#B6B1BA", 
        "B05": "#89858C", "B06": "#48464E", "B07": "#2F2B2F", "B09": "#000000", "B01": "#E7D6DB", 
        "B02": "#EDEDED", "B04": "#EEE9EA", "B08": "#CECDD5", "A04": "#FFF5ED", "A03": "#F5ECD2", 
        "A06": "#CFD7D3", "A05": "#98A6A8", "A07": "#1D1414", "A01": "#F1EDED", "A03": "#FFFDF0", 
        "A05": "#F6EFE2", "A06": "#949FA3", "A07": "#FFFBE1", "A08": "#CACAD4", "A09": "#9A9D94", 
        "Y01": "#BCC6B8", "Y02": "#8AA386", "Y03": "#697D80", "Y04": "#E3D2BC", "Y05": "#D0CCAA", 
        "Y06": "#B0A782", "Y07": "#B4A497", "Y08": "#B38281", "Y09": "#A58767", "Y10": "#C5B2BC", 
        "Y11": "#9F7594", "Y12": "#644749", "Y13": "#D19066", "Y14": "#C77362", "Y15": "#757D7B", 
        "M01": "#FCF7F8", "M02": "#B0A9AC", "M03": "#AFDCAB", "M04": "#FEA49F", "M05": "#EE8C3E", 
        "M06": "#5FD0A7", "M07": "#EB9270", "M08": "#F0D958", "M09": "#D9D9D9", "M10": "#D9C7EA", 
        "M11": "#F3ECC9", "M12": "#E6EEF2", "M13": "#AACBEF", "M14": "#3376B0", "M15": "#668575", 
        "M16": "#FEBF45", "M17": "#FEA324", "M18": "#FEB89F", "M19": "#FFE0E9", "M20": "#FEBECF", 
        "M21": "#ECBEBF", "M22": "#E4A89F", "M23": "#A56268", "W3": "#F2A5E8", "W4": "#E9EC91", 
        "W1": "#FFFF00", "W2": "#FFEBFA", "W5": "#76CEDE", "T1": "#D50D21", "N1": "#F92F83", 
        "N2": "#FD8324", "N3": "#F8EC31", "N4": "#35C75B", "T4": "#23B891", "T5": "#19779D", 
        "T3": "#1A60C3", "T2": "#9A56B4", "T6": "#FFDB4C", "L2": "#FFEBFA", "L7": "#D8D5CE", 
        "L7": "#55514C", "S1": "#9FE4DF", "S5": "#77CEE9", "S4": "#3ECFCA", "S11": "#4A867A", 
        "S13": "#7FCD9D", "S6": "#CDE55D", "S8": "#E8C7B4", "S15": "#AD6F3C", "S12": "#6C372F", 
        "S14": "#FEB872", "S9": "#F3C1C0", "S4": "#C9675E", "S11": "#D293BE", "S8": "#EA8CB1", 
        "S10": "#9C87D6", "L06": "#FFFFFF", "N01": "#FD6FB4", "N02": "#F24B94", "N03": "#D7FAA0", 
        "N04": "#8BDBFA", "N05": "#E987EA", "GB1": "#DAABB3", "GB2": "#D6AA87", "GB3": "#C1BD8D", 
        "GB4": "#96B69F", "GB5": "#849DC6", "GB6": "#94BFE2", "GB7": "#E2A9D2", "GB8": "#AB91C0"
    },
    'Êº´Êº´': {
        "E2": "#FAF4C8", "B1": "#FFFFD5", "B2": "#FEFF8B", "B3": "#FBED56", "B4": "#F4D738", 
        "B5": "#FEAC4C", "B6": "#FE8B4C", "B10": "#FFDA45", "B11": "#FF995B", "B12": "#F77C31", 
        "E11": "#FFDD99", "A18": "#FE9F72", "B13": "#FFC365", "B14": "#FD543D", "B15": "#FFF365", 
        "IC04": "#FFFF9F", "IC9": "#FFE36E", "IC14": "#FEBE7D", "IC15": "#FD7C72", "Q6": "#FFD568", 
        "R07": "#FFE395", "R06": "#F4F57D", "R08": "#E6C9B7", "G3": "#F7F8A2", "G4": "#FFD67D", 
        "G5": "#FFC830", "C1": "#E6EE31", "C2": "#63F347", "C7": "#9EF780", "C3": "#5DE035", 
        "C4": "#35E352", "C9": "#65E2A6", "C10": "#3DAF80", "C5": "#1C9C4F", "C6": "#27523A", 
        "C11": "#95D3C2", "C12": "#5D722A", "C13": "#166F41", "C14": "#CAEB7B", "C15": "#ADE946", 
        "C16": "#2E5132", "C17": "#C5ED9C", "C18": "#9BB13A", "C19": "#E6EE49", "DH15": "#24B88C", 
        "DH10": "#C2F0CC", "DH2": "#156A6B", "DH7": "#0B3C43", "DH12": "#303A21", "IC5": "#EEFCA5", 
        "Q13": "#4E846D", "Q7": "#8D7A35", "R10": "#CCE1AF", "R11": "#9EE5B9", "R09": "#C5E254", 
        "G6": "#E2FCB1", "G7": "#B0E792", "G12": "#9CAB5A", "C8": "#E8FFE7", "D1": "#A9F9FC", 
        "D2": "#A0E2FB", "D3": "#41CCFF", "D7": "#01ACEB", "D4": "#50AAF0", "D9": "#0F54C0", 
        "N5": "#324BCA", "D25": "#3EBCE2", "D28": "#28DDDE", "D26": "#1C334D", "D30": "#CDE8FF", 
        "D29": "#D5FDFF", "D31": "#22C4C6", "D32": "#1557A8", "D36": "#04D1F6", "DH6": "#1D3344", 
        "DH9": "#1887A2", "DH14": "#176DAF", "IC3": "#BEDDFF", "Q11": "#67B4BE", "R13": "#C8E2FF", 
        "R14": "#7CC4FF", "R12": "#A9E5E5", "R15": "#3CAED8", "G13": "#D3DFFA", "G14": "#BBCFED", 
        "G15": "#34488E", "D5": "#AEB4F2", "D6": "#858EDD", "D10": "#2F54AF", "D11": "#182A84", 
        "D13": "#B843C5", "D14": "#AC7BDE", "D16": "#8854B3", "D17": "#E2D3FF", "D19": "#D5B9F8", 
        "D15": "#361B51", "D20": "#B9BAE1", "D21": "#DE9AD4", "D22": "#B90095", "D23": "#8B279B", 
        "D24": "#2F1F90", "D18": "#E3E1EE", "D27": "#C4D4F6", "D33": "#A45EC7", "D34": "#D8C3D7", 
        "D35": "#9C32B2", "DH1": "#9A009B", "DH8": "#333A95", "IC8": "#EBDAFC", "Q14": "#7786E5", 
        "Q15": "#494FC7", "R01": "#DFC2F8", "E1": "#FDD3CC", "E9": "#FEC0DF", "E10": "#FFB7E7", 
        "E21": "#E8649E", "E15": "#F551A2", "E16": "#F13D74", "E17": "#C63478", "E18": "#FFDBE9", 
        "E19": "#E970CC", "E20": "#D33793", "E23": "#FCDDD2", "E24": "#F78FC3", "E25": "#B5006D", 
        "E26": "#FFD1BA", "E27": "#F8C7C9", "E28": "#FFF3EB", "E29": "#FFE2EA", "E30": "#FFC7DB", 
        "E31": "#FEBAD5", "E32": "#D8C7D1", "E33": "#BD9DA1", "E34": "#B785A1", "E35": "#937A8D", 
        "E36": "#FFFF00", "A1": "#FD957B", "A2": "#FC3D46", "A3": "#F74941", "A4": "#FC283C", 
        "A5": "#E7002F", "A6": "#943630", "A7": "#971937", "A8": "#BC0028", "A9": "#E2677A", 
        "A10": "#8A4526", "A11": "#5A2121", "A12": "#FD4E6A", "A13": "#F35744", "A14": "#FFA9AD", 
        "A15": "#D30022", "A16": "#FEC2A6", "A17": "#E69C79", "A18": "#D37C46", "A19": "#C1444A", 
        "A20": "#CD9391", "A21": "#F7B4C6", "A22": "#FDC0D0", "A23": "#F67E66", "A24": "#E698AA", 
        "A25": "#E54B4F", "E3": "#FFE2CE", "E4": "#FFC4AA", "E5": "#F4C3A5", "E6": "#E1B383", 
        "E7": "#EDB045", "E8": "#E99C17", "E9": "#9D5B3E", "E10": "#753B32", "E12": "#E6B483", 
        "E13": "#D98C39", "E14": "#E0C593", "E15": "#FFC890", "E16": "#B7714A", "E17": "#8D614C", 
        "E18": "#FCF9E0", "E19": "#F2D9BA", "E20": "#7B524B", "E21": "#FFE4CC", "E22": "#E07935", 
        "E23": "#A94023", "E24": "#B88558", "F1": "#FDFBFF", "F2": "#FEFFFF", "F3": "#B6B1BA", 
        "F4": "#89858C", "F5": "#48464E", "F6": "#2F2B2F", "F7": "#000000", "F8": "#E7D6DB", 
        "F9": "#EDEDED", "F10": "#EEE9EA", "F11": "#CECDD5", "F12": "#FFF5ED", "F13": "#F5ECD2", 
        "F14": "#CFD7D3", "F15": "#98A6A8", "F16": "#1D1414", "F17": "#F1EDED", "F18": "#FFFDF0", 
        "F19": "#F6EFE2", "F20": "#949FA3", "F21": "#FFFBE1", "F22": "#CACAD4", "F23": "#9A9D94", 
        "YX11": "#BCC6B8", "YX12": "#8AA386", "YX2": "#697D80", "YX15": "#E3D2BC", "YX6": "#D0CCAA", 
        "YX1": "#B0A782", "YX13": "#B4A497", "YX14": "#B38281", "YX10": "#A58767", "YX9": "#C5B2BC", 
        "YX4": "#9F7594", "YX5": "#644749", "YX8": "#D19066", "YX3": "#C77362", "YX7": "#757D7B", 
        "P1": "#FCF7F8", "P2": "#B0A9AC", "P4": "#AFDCAB", "P5": "#FEA49F", "P3": "#EE8C3E", 
        "P8": "#5FD0A7", "P6": "#EB9270", "P7": "#F0D958", "P13": "#D9D9D9", "P18": "#D9C7EA", 
        "P9": "#F3ECC9", "P12": "#E6EEF2", "P17": "#AACBEF", "P22": "#3376B0", "P23": "#668575", 
        "P14": "#FEBF45", "P19": "#FEA324", "P11": "#FEB89F", "P10": "#FFE0E9", "P15": "#FEBECF", 
        "P20": "#ECBEBF", "P16": "#E4A89F", "P21": "#A56268", "W3": "#F2A5E8", "W4": "#E9EC91", 
        "W1": "#FFFF00", "W2": "#FFEBFA", "W5": "#76CEDE", "T1": "#D50D21", "N1": "#F92F83", 
        "N2": "#FD8324", "N3": "#F8EC31", "N4": "#35C75B", "T4": "#23B891", "T5": "#19779D", 
        "T3": "#1A60C3", "T2": "#9A56B4", "T6": "#FFDB4C", "L2": "#FFEBFA", "L7": "#D8D5CE", 
        "L7": "#55514C", "S1": "#9FE4DF", "S5": "#77CEE9", "S4": "#3ECFCA", "S11": "#4A867A", 
        "S13": "#7FCD9D", "S6": "#CDE55D", "S8": "#E8C7B4", "S15": "#AD6F3C", "S12": "#6C372F", 
        "S14": "#FEB872", "S9": "#F3C1C0", "S4": "#C9675E", "S11": "#D293BE", "S8": "#EA8CB1", 
        "S10": "#9C87D6", "L6": "#FFFFFF", "Y1": "#FD6FB4", "Y2": "#F24B94", "Y3": "#D7FAA0", 
        "Y4": "#8BDBFA", "Y5": "#E987EA", "ZG1": "#DAABB3", "ZG2": "#D6AA87", "ZG3": "#C1BD8D", 
        "ZG4": "#96B69F", "ZG5": "#849DC6", "ZG6": "#94BFE2", "ZG7": "#E2A9D2", "ZG8": "#AB91C0"
    },
    'ÁõºÁõº': {
        "65": "#FAF4C8", "2": "#FFFFD5", "28": "#FEFF8B", "3": "#FBED56", "79": "#F4D738", 
        "29": "#FEAC4C", "4": "#FE8B4C", "98": "#FFDA45", "96": "#FF995B", "97": "#F77C31", 
        "109": "#FFDD99", "110": "#FE9F72", "116": "#FFC365", "135": "#FD543D", "150": "#FFF365", 
        "150A": "#FFFF9F", "213": "#FFE36E", "208": "#FEBE7D", "218": "#FD7C72", "242": "#FFD568", 
        "261": "#FFE395", "255": "#F4F57D", "259": "#E6C9B7", "273": "#F7F8A2", "274": "#FFD67D", 
        "275": "#FFC830", "48": "#E6EE31", "33": "#63F347", "26": "#9EF780", "78": "#5DE035", 
        "82": "#35E352", "11": "#65E2A6", "44": "#3DAF80", "10": "#1C9C4F", "84": "#27523A", 
        "103": "#95D3C2", "106": "#5D722A", "111": "#166F41", "119": "#CAEB7B", "117": "#ADE946", 
        "122": "#2E5132", "113": "#C5ED9C", "141": "#9BB13A", "133": "#E6EE49", "174": "#24B88C", 
        "175": "#C2F0CC", "194": "#156A6B", "193": "#0B3C43", "192": "#303A21", "207": "#EEFCA5", 
        "191": "#4E846D", "178": "#8D7A35", "180": "#CCE1AF", "188": "#9EE5B9", "187": "#C5E254", 
        "185": "#E2FCB1", "179": "#B0E792", "176": "#9CAB5A", "76": "#E8FFE7", "30": "#A9F9FC", 
        "75": "#A0E2FB", "80": "#41CCFF", "34": "#01ACEB", "25": "#50AAF0", "9": "#3677D2", 
        "52": "#0F54C0", "71": "#324BCA", "42": "#3EBCE2", "76A": "#28DDDE", "80A": "#1C334D", 
        "82": "#CDE8FF", "93": "#D5FDFF", "90": "#22C4C6", "97": "#1557A8", "99": "#04D1F6", 
        "106": "#1D3344", "111": "#1887A2", "104": "#176DAF", "105": "#BEDDFF", "121": "#67B4BE", 
        "130": "#C8E2FF", "122": "#7CC4FF", "113": "#A9E5E5", "127": "#3CAED8", "126": "#D3DFFA", 
        "112": "#BBCFED", "118": "#34488E", "46": "#AEB4F2", "36": "#858EDD", "8": "#2F54AF", 
        "75A": "#182A84", "32": "#B843C5", "27": "#AC7BDE", "7": "#8854B3", "92": "#E2D3FF", 
        "91": "#D5B9F8", "105A": "#361B51", "104A": "#B9BAE1", "106A": "#DE9AD4", "111A": "#B90095", 
        "108A": "#8B279B", "118A": "#2F1F90", "126A": "#E3E1EE", "125A": "#C4D4F6", "128A": "#A45EC7", 
        "119A": "#D8C3D7", "131A": "#9C32B2", "136A": "#9A009B", "134A": "#333A95", "139A": "#EBDAFC", 
        "136B": "#7786E5", "141B": "#494FC7", "133B": "#DFC2F8", "18": "#FDD3CC", "38": "#FEC0DF", 
        "62": "#FFB7E7", "74A": "#E8649E", "40": "#F551A2", "41": "#F13D74", "20": "#C63478", 
        "84A": "#FFDBE9", "103": "#E970CC", "94": "#D33793", "95": "#FCDDD2", "87": "#F78FC3", 
        "102": "#B5006D", "115": "#FFD1BA", "114": "#F8C7C9", "123": "#FFF3EB", "121": "#FFE2EA", 
        "130": "#FFC7DB", "124": "#FEBAD5", "131": "#D8C7D1", "116": "#BD9DA1", "115": "#B785A1", 
        "118": "#937A8D", "143": "#FFFF00", "35": "#FD957B", "31": "#FC3D46", "53": "#F74941", 
        "54": "#FC283C", "73": "#E7002F", "79A": "#943630", "84A": "#971937", "103A": "#BC0028", 
        "106A": "#E2677A", "78A": "#8A4526", "83A": "#5A2121", "94A": "#FD4E6A", "89A": "#F35744", 
        "96A": "#FFA9AD", "100A": "#D30022", "109A": "#FEC2A6", "110A": "#E69C79", "112A": "#D37C46", 
        "118A": "#C1444A", "126A": "#CD9391", "131A": "#F7B4C6", "124A": "#FDC0D0", "134A": "#F67E66", 
        "138A": "#E698AA", "135A": "#E54B4F", "76B": "#FFE2CE", "81": "#FFC4AA", "92": "#F4C3A5", 
        "100B": "#E1B383", "109B": "#EDB045", "110B": "#E99C17", "116B": "#9D5B3E", "115B": "#753B32", 
        "99B": "#E6B483", "106B": "#D98C39", "102B": "#E0C593", "109B": "#FFC890", "117B": "#B7714A", 
        "129B": "#8D614C", "149": "#FCF9E0", "147": "#F2D9BA", "151": "#7B524B", "154": "#FFE4CC", 
        "116B": "#E07935", "135B": "#A94023", "139B": "#B88558", "15": "#FDFBFF", "1": "#FEFFFF", 
        "13": "#B6B1BA", "78B": "#89858C", "83B": "#48464E", "85": "#2F2B2F", "86": "#000000", 
        "45": "#E7D6DB", "51": "#EDEDED", "70": "#EEE9EA", "69": "#CECDD5", "123": "#FFF5ED", 
        "121": "#F5ECD2", "130": "#CFD7D3", "122": "#98A6A8", "144": "#1D1414", "142": "#F1EDED", 
        "141": "#FFFDF0", "143": "#F6EFE2", "132": "#949FA3", "146": "#FFFBE1", "145": "#CACAD4", 
        "140": "#9A9D94", "168": "#BCC6B8", "172": "#8AA386", "166": "#697D80", "167": "#E3D2BC", 
        "159": "#D0CCAA", "169": "#B0A782", "171": "#B4A497", "177": "#B38281", "170": "#A58767", 
        "164": "#C5B2BC", "161": "#9F7594", "173": "#644749", "160": "#D19066", "162": "#C77362", 
        "163": "#757D7B", "71": "#FCF7F8", "62": "#B0A9AC", "66": "#AFDCAB", "64": "#FEA49F", 
        "63": "#EE8C3E", "65": "#5FD0A7", "68": "#EB9270", "67": "#F0D958", "70": "56/56", 
        "65A": "157/70", "68A": "159/68", "67A": "158/67", "195": "#D9D9D9", "187": "#D9C7EA", 
        "185": "#F3ECC9", "190": "#E6EEF2", "193": "#AACBEF", "183": "#3376B0", "184": "#668575", 
        "182": "#FEBF45", "179": "#FEA324", "180": "#FEB89F", "188": "#FFE0E9", "186": "#FEBECF", 
        "189": "#ECBEBF", "180": "#E4A89F", "181": "#A56268", "109": "#F2A5E8", "111": "#E9EC91", 
        "107": "#FFFF00", "110": "#FFEBFA", "108": "#76CEDE", "67": "#D50D21", "52": "#F92F83", 
        "54": "#FD8324", "56": "#F8EC31", "55": "#35C75B", "69": "#23B891", "55A": "#19779D", 
        "54A": "#1A60C3", "56A": "#9A56B4", "151": "#FFDB4C", "152": "#FFEBFA", "151A": "#D8D5CE", 
        "152A": "#55514C", "231": "#9FE4DF", "237": "#77CEE9", "224": "#3ECFCA", "233": "#4A867A", 
        "222": "#7FCD9D", "227": "#CDE55D", "230": "#E8C7B4", "221": "#AD6F3C", "226": "#6C372F", 
        "219": "#FEB872", "228": "#F3C1C0", "225": "#C9675E", "232": "#D293BE", "221A": "#EA8CB1", 
        "227A": "#9C87D6", "155": "#FFFFFF", "59": "#FD6FB4", "60": "#F24B94", "57": "#D7FAA0", 
        "58": "#8BDBFA", "61": "#E987EA", "254": "#DAABB3", "255": "#D6AA87", "256": "#C1BD8D", 
        "257": "#96B69F", "258": "#849DC6", "259": "#94BFE2", "260": "#E2A9D2", "261": "#AB91C0"
    },
    'Âí™Â∞èÁ™ù': {
        "77": "#FAF4C8", "2": "#FFFFD5", "28": "#FEFF8B", "3": "#FBED56", "79": "#F4D738", 
        "29": "#FEAC4C", "4": "#FE8B4C", "98": "#FFDA45", "96": "#FF995B", "97": "#F77C31", 
        "109": "#FFDD99", "110": "#FE9F72", "116": "#FFC365", "135": "#FD543D", "150": "#FFF365", 
        "150A": "#FFFF9F", "213": "#FFE36E", "208": "#FEBE7D", "218": "#FD7C72", "242": "#FFD568", 
        "261": "#FFE395", "255": "#F4F57D", "259": "#E6C9B7", "273": "#F7F8A2", "274": "#FFD67D", 
        "275": "#FFC830", "48": "#E6EE31", "33": "#63F347", "26": "#9EF780", "78": "#5DE035", 
        "82": "#35E352", "11": "#65E2A6", "44": "#3DAF80", "10": "#1C9C4F", "84": "#27523A", 
        "103": "#95D3C2", "106": "#5D722A", "111": "#166F41", "119": "#CAEB7B", "117": "#ADE946", 
        "122": "#2E5132", "113": "#C5ED9C", "141": "#9BB13A", "133": "#E6EE49", "174": "#24B88C", 
        "175": "#C2F0CC", "194": "#156A6B", "193": "#0B3C43", "192": "#303A21", "207": "#EEFCA5", 
        "191": "#4E846D", "178": "#8D7A35", "180": "#CCE1AF", "188": "#9EE5B9", "187": "#C5E254", 
        "185": "#E2FCB1", "179": "#B0E792", "176": "#9CAB5A", "76": "#E8FFE7", "30": "#A9F9FC", 
        "75": "#A0E2FB", "80": "#41CCFF", "34": "#01ACEB", "25": "#50AAF0", "9": "#3677D2", 
        "52": "#0F54C0", "71": "#324BCA", "42": "#3EBCE2", "76A": "#28DDDE", "80A": "#1C334D", 
        "82": "#CDE8FF", "93": "#D5FDFF", "90": "#22C4C6", "97": "#1557A8", "99": "#04D1F6", 
        "106": "#1D3344", "111": "#1887A2", "104": "#176DAF", "105": "#BEDDFF", "121": "#67B4BE", 
        "130": "#C8E2FF", "122": "#7CC4FF", "113": "#A9E5E5", "127": "#3CAED8", "126": "#D3DFFA", 
        "112": "#BBCFED", "118": "#34488E", "46": "#AEB4F2", "36": "#858EDD", "8": "#2F54AF", 
        "75A": "#182A84", "32": "#B843C5", "27": "#AC7BDE", "7": "#8854B3", "92": "#E2D3FF", 
        "91": "#D5B9F8", "105A": "#361B51", "104A": "#B9BAE1", "106A": "#DE9AD4", "111A": "#B90095", 
        "108A": "#8B279B", "118A": "#2F1F90", "126A": "#E3E1EE", "125A": "#C4D4F6", "128A": "#A45EC7", 
        "119A": "#D8C3D7", "131A": "#9C32B2", "136A": "#9A009B", "134A": "#333A95", "139A": "#EBDAFC", 
        "136B": "#7786E5", "141B": "#494FC7", "133B": "#DFC2F8", "18": "#FDD3CC", "38": "#FEC0DF", 
        "62": "#FFB7E7", "74A": "#E8649E", "40": "#F551A2", "41": "#F13D74", "20": "#C63478", 
        "84A": "#FFDBE9", "103": "#E970CC", "94": "#D33793", "95": "#FCDDD2", "87": "#F78FC3", 
        "102": "#B5006D", "115": "#FFD1BA", "114": "#F8C7C9", "123": "#FFF3EB", "121": "#FFE2EA", 
        "130": "#FFC7DB", "124": "#FEBAD5", "131": "#D8C7D1", "116": "#BD9DA1", "115": "#B785A1", 
        "118": "#937A8D", "143": "#FFFF00", "35": "#FD957B", "31": "#FC3D46", "53": "#F74941", 
        "54": "#FC283C", "73": "#E7002F", "79A": "#943630", "84A": "#971937", "103A": "#BC0028", 
        "106A": "#E2677A", "78A": "#8A4526", "83A": "#5A2121", "94A": "#FD4E6A", "89A": "#F35744", 
        "96A": "#FFA9AD", "100A": "#D30022", "109A": "#FEC2A6", "110A": "#E69C79", "112A": "#D37C46", 
        "118A": "#C1444A", "126A": "#CD9391", "131A": "#F7B4C6", "124A": "#FDC0D0", "134A": "#F67E66", 
        "138A": "#E698AA", "135A": "#E54B4F", "76B": "#FFE2CE", "81": "#FFC4AA", "92": "#F4C3A5", 
        "100B": "#E1B383", "109B": "#EDB045", "110B": "#E99C17", "116B": "#9D5B3E", "115B": "#753B32", 
        "99B": "#E6B483", "106B": "#D98C39", "102B": "#E0C593", "109B": "#FFC890", "117B": "#B7714A", 
        "129B": "#8D614C", "149": "#FCF9E0", "147": "#F2D9BA", "151": "#7B524B", "154": "#FFE4CC", 
        "116B": "#E07935", "135B": "#A94023", "139B": "#B88558", "15": "#FDFBFF", "1": "#FEFFFF", 
        "13": "#B6B1BA", "78B": "#89858C", "83B": "#48464E", "85": "#2F2B2F", "86": "#000000", 
        "45": "#E7D6DB", "51": "#EDEDED", "70": "#EEE9EA", "69": "#CECDD5", "123": "#FFF5ED", 
        "121": "#F5ECD2", "130": "#CFD7D3", "122": "#98A6A8", "144": "#1D1414", "142": "#F1EDED", 
        "141": "#FFFDF0", "143": "#F6EFE2", "132": "#949FA3", "146": "#FFFBE1", "145": "#CACAD4", 
        "140": "#9A9D94", "168": "#BCC6B8", "172": "#8AA386", "166": "#697D80", "167": "#E3D2BC", 
        "159": "#D0CCAA", "169": "#B0A782", "171": "#B4A497", "177": "#B38281", "170": "#A58767", 
        "164": "#C5B2BC", "161": "#9F7594", "173": "#644749", "160": "#D19066", "162": "#C77362", 
        "163": "#757D7B", "71": "#FCF7F8", "62": "#B0A9AC", "66": "#AFDCAB", "64": "#FEA49F", 
        "63": "#EE8C3E", "65": "#5FD0A7", "68": "#EB9270", "67": "#F0D958", "70": "56/56", 
        "65A": "157/70", "68A": "159/68", "67A": "158/67", "195": "#D9D9D9", "187": "#D9C7EA", 
        "185": "#F3ECC9", "190": "#E6EEF2", "193": "#AACBEF", "183": "#3376B0", "184": "#668575", 
        "182": "#FEBF45", "179": "#FEA324", "180": "#FEB89F", "188": "#FFE0E9", "186": "#FEBECF", 
        "189": "#ECBEBF", "180": "#E4A89F", "181": "#A56268", "109": "#F2A5E8", "111": "#E9EC91", 
        "107": "#FFFF00", "110": "#FFEBFA", "108": "#76CEDE", "67": "#D50D21", "52": "#F92F83", 
        "54": "#FD8324", "56": "#F8EC31", "55": "#35C75B", "69": "#23B891", "55A": "#19779D", 
        "54A": "#1A60C3", "56A": "#9A56B4", "151": "#FFDB4C", "152": "#FFEBFA", "151A": "#D8D5CE", 
        "152A": "#55514C", "231": "#9FE4DF", "237": "#77CEE9", "224": "#3ECFCA", "233": "#4A867A", 
        "222": "#7FCD9D", "227": "#CDE55D", "230": "#E8C7B4", "221": "#AD6F3C", "226": "#6C372F", 
        "219": "#FEB872", "228": "#F3C1C0", "225": "#C9675E", "232": "#D293BE", "221A": "#EA8CB1", 
        "227A": "#9C87D6", "155": "#FFFFFF", "59": "#FD6FB4", "60": "#F24B94", "57": "#D7FAA0", 
        "58": "#8BDBFA", "61": "#E987EA", "254": "#DAABB3", "255": "#D6AA87", "256": "#C1BD8D", 
        "257": "#96B69F", "258": "#849DC6", "259": "#94BFE2", "260": "#E2A9D2", "261": "#AB91C0"
    }
};

// Background colors to be removed
const BACKGROUND_COLOR_KEYS = ['T1', 'H1', 'H2'];

// Get all color keys for each brand
const ALL_COLOR_KEYS = {
    'MARD': Object.keys(MARD_COLORS_FULL),
    'COCO': Object.keys(BRAND_COLORS.COCO),
    'Êº´Êº´': Object.keys(BRAND_COLORS.Êº´Êº´),
    'ÁõºÁõº': Object.keys(BRAND_COLORS.ÁõºÁõº),
    'Âí™Â∞èÁ™ù': Object.keys(BRAND_COLORS.Âí™Â∞èÁ™ù)
};

// Color presets for MARD brand only
const MARD_COLOR_PRESETS = {
    'ÂÖ•Èó®10Ëâ≤': ['H7', 'A6', 'B1', 'C3', 'D6', 'E3', 'F5', 'G1', 'H17', 'R1'],
    'Ê†áÂáÜ20Ëâ≤': ['H7', 'A6', 'B1', 'C3', 'D6', 'E3', 'F5', 'G1', 'H17', 'R1', 'A13', 'B5', 'C5', 'D9', 'E9', 'F13', 'P1', 'Y1', 'Y4'],
    'ËøõÈò∂30Ëâ≤': ['H7', 'A6', 'B1', 'C3', 'D6', 'E3', 'F5', 'G1', 'H17', 'R1', 'A13', 'B5', 'C5', 'D9', 'E9', 'F13', 'P1', 'Y1', 'Y4', 'A1','B2','C4','D7','E2','F4','G2','M1','R2'],
    '‰∏ì‰∏ö50Ëâ≤': ['H7', 'A6', 'B1', 'C3', 'D6', 'E3', 'F5', 'G1', 'H17', 'R1', 'A13', 'B5', 'C5', 'D9', 'E9', 'F13', 'P1', 'Y1', 'Y4', 'A1','B2','C4','D7','E2','F4','G2','M1','R2', 'A2','B3','C6','D8','E4','F6','G3','M2','R3','P2','A3','B4','C7','D9','E5','F7','G4','M3','R4','P4'],
    'Â§ßÂ∏à100Ëâ≤': ['T1', 'H7', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'H8', 'H9', 'A1', 'A2', "A3", "A4", "A5", "A6", "A7", "A8", "A9", "A10", "A11", "A12", "A13", "A14", "A15", "B1", "B2", "B3", "B4", "B5", "B6", "B7", "B8", "B9", "B10", "B11", "B12", "B13", "B14", "B15", "B16", "B17", "B18", "B19", "B20", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9", "D10", "D11", "D12", "D13", "D14", "D15"],
    'Ê†áÂáÜ221Ëâ≤': ['A1', 'A2', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'A9', 'A10', 'A11', 'A12', 'A13', 'A14', 'A15', 'A16', 'A17', 'A18', 'A19', 'A20', 'A21', 'A22', 'A23', 'A24', 'A25', 'A26', 'B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B9', 'B10', 'B11', 'B12', 'B13', 'B14', 'B15', 'B16', 'B17', 'B18', 'B19', 'B20', 'B21', 'B22', 'B23', 'B24', 'B25', 'B26', 'B27', 'B28', 'B29', 'B30', 'B31', 'B32', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'C7', 'C8', 'C9', 'C10', 'C11', 'C12', 'C13', 'C14', 'C15', 'C16', 'C17', 'C18', 'C19', 'C20', 'C21', 'C22', 'C23', 'C24', 'C25', 'C26', 'C27', 'C28', 'C29', 'D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8', 'D9', 'D10', 'D11', 'D12', 'D13', 'D14', 'D15', 'D16', 'D17', 'D18', 'D19', 'D20', 'D21', 'D22', 'D23', 'D24', 'D25', 'D26', 'E1', 'E2', 'E3', 'E4', 'E5', 'E6', 'E7', 'E8', 'E9', 'E10', 'E11', 'E12', 'E13', 'E14', 'E15', 'E16', 'E17', 'E18', 'E19', 'E20', 'E21', 'E22', 'E23', 'E24', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'F13', 'F14', 'F15', 'F16', 'F17', 'F18', 'F19', 'F20', 'F21', 'F22', 'F23', 'F24', 'F25', 'G1', 'G2', 'G3', 'G4', 'G5', 'G6', 'G7', 'G8', 'G9', 'G10', 'G11', 'G12', 'G13', 'G14', 'G15', 'G16', 'G17', 'G18', 'G19', 'G20', 'G21', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'H7', 'H8', 'H9', 'H10', 'H11', 'H12', 'H13', 'H14', 'H15', 'H16', 'H17', 'H18', 'H19', 'H20', 'H21', 'H22', 'H23', 'M1', 'M2', 'M3', 'M4', 'M5', 'M6', 'M7', 'M8', 'M9', 'M10', 'M11', 'M12', 'M13', 'M14', 'M15'],
    'ÂÖ®Ëâ≤Á≥ª291Ëâ≤': ALL_COLOR_KEYS.MARD
};

// --- State Management ---
let state = {
    originalImage: null,
    currentBrand: 'MARD', // ÈªòËÆ§ÈÄâÊã©MARDÂìÅÁâå
    activePalette: MARD_COLOR_PRESETS['ÂÖ®Ëâ≤Á≥ª291Ëâ≤'],
    customPalette: new Set(),
    excludedColors: new Set(),
    colorData: [], // 2D array of color codes
    initialMappedData: [], // Initial mapping data
    mergedData: [], // Data after region merging
    externalBackground: [], // Background cells marked as external
    colorCounts: {},
    highlightedColor: null,
    hiddenColors: new Set(),
    selectedColor: null,
    selectedCell: null, // {x, y, color} for color replacement
    zoomLevel: 100,
    showGrid: true,
    showCoords: true,
    showColors: true,
    showBackground: true,
    similarityThreshold: 30,
    processingMode: 'Êú™Â§ÑÁêÜ',
    mergedRegions: 0,
    backgroundRemoved: 'Êú™ÊâßË°å',
    isEditMode: false,
    isReplaceMode: false, // È¢úËâ≤Êõ¥Êç¢ÂäüËÉΩÂºÄÂÖ≥Áä∂ÊÄÅ
    isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
    // Êñ∞Â¢ûÔºöÁ¶ÅÁî®È¢ÑËßàÊ†ºÂ≠êËâ≤Âè∑Ê°ÜÁöÑÂºÄÂÖ≥
    disablePreview: false,
    // ÊãñÊãΩÁä∂ÊÄÅ
    isDragging: false,
    dragStart: { x: 0, y: 0 },
    dragOffset: { x: 0, y: 0 },
    canvasTransform: { x: 0, y: 0, scale: 1 },
    // CanvasÁä∂ÊÄÅ
    canvas: null,
    ctx: null,
    cellSize: 25,
    actualWidth: 0,
    actualHeight: 0,
    minX: 0,
    minY: 0,
    maxX: 0,
    maxY: 0,
    // Êñ∞Â¢ûÔºöÊô∫ËÉΩÁä∂ÊÄÅÁÆ°ÁêÜ
    viewportState: {
        scrollLeft: 0,
        scrollTop: 0,
        zoomLevel: 100,
        containerWidth: 0,
        containerHeight: 0
    },
    // Êñ∞Â¢ûÔºöÁº©ÊîæÁä∂ÊÄÅÊåÅ‰πÖÂåñ
    zoomState: {
        level: 100,
        min: 10,
        max: 500,
        step: 10
    },
    // Á∫øÊù°Â¢ûÂº∫Áä∂ÊÄÅ
    lineEnhance: false,
    lineStrength: 3
};

// --- Core Algorithms ---

// ‰øÆÂ§çÔºöÊ≠£Á°ÆÁöÑÁ∫øÊù°Â¢ûÂº∫Â§ÑÁêÜÂáΩÊï∞ - ÈíàÂØπËæπÁºò/Á∫øÊù°ËøõË°åÂ¢ûÂº∫
const applyLineEnhancement = (imageData, strength) => {
    console.log(`Â∫îÁî®Á∫øÊù°Â¢ûÂº∫ÔºåÂº∫Â∫¶: ${strength}`);
    
    // ÂàõÂª∫ÂõæÂÉèÊï∞ÊçÆÁöÑÂâØÊú¨
    const enhancedData = new ImageData(
        new Uint8ClampedArray(imageData.data),
        imageData.width,
        imageData.height
    );
    
    // ËæπÁºòÊ£ÄÊµãÂíåÂ¢ûÂº∫ÁÆóÊ≥ï
    const width = imageData.width;
    const height = imageData.height;
    const data = enhancedData.data;
    const originalData = imageData.data;
    
    // SobelÁÆóÂ≠ê
    const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
    const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
    
    // ÂàõÂª∫ËæπÁºòÂõæ
    const edgeMap = new Uint8ClampedArray(width * height);
    
    // ËÆ°ÁÆóËæπÁºòÂº∫Â∫¶
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            let pixelX = 0;
            let pixelY = 0;
            
            // Â∫îÁî®SobelÁÆóÂ≠ê
            for (let j = -1; j <= 1; j++) {
                for (let i = -1; i <= 1; i++) {
                    const idx = ((y + j) * width + (x + i)) * 4;
                    const gray = originalData[idx] * 0.299 + originalData[idx + 1] * 0.587 + originalData[idx + 2] * 0.114;
                    const kernelIdx = (j + 1) * 3 + (i + 1);
                    pixelX += gray * sobelX[kernelIdx];
                    pixelY += gray * sobelY[kernelIdx];
                }
            }
            
            // ËÆ°ÁÆóÊ¢ØÂ∫¶ÂπÖÂÄº
            const magnitude = Math.sqrt(pixelX * pixelX + pixelY * pixelY);
            const idx = y * width + x;
            edgeMap[idx] = Math.min(255, magnitude);
        }
    }
    
    // Â∫îÁî®Á∫øÊù°Â¢ûÂº∫
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            const idx = (y * width + x) * 4;
            const edgeIdx = y * width + x;
            
            // Ëé∑ÂèñÂéüÂßãÈ¢úËâ≤
            const r = originalData[idx];
            const g = originalData[idx + 1];
            const b = originalData[idx + 2];
            
            // ËÆ°ÁÆóÂéüÂßãÁÅ∞Â∫¶ÂÄº
            const gray = r * 0.299 + g * 0.587 + b * 0.114;
            
            // Ëé∑ÂèñËæπÁºòÂº∫Â∫¶
            const edgeStrength = edgeMap[edgeIdx];
            
            // Ê†πÊçÆÂº∫Â∫¶Ë∞ÉÊï¥È¢úËâ≤
            if (edgeStrength > 30) { // ËæπÁºòÈòàÂÄº
                // Â¢ûÂº∫ËæπÁºò - ‰ΩøËæπÁºòÊõ¥Èªë
                const edgeFactor = Math.max(0.3, 1 - (edgeStrength / 255) * (strength / 10));
                data[idx] = r * edgeFactor;
                data[idx + 1] = g * edgeFactor;
                data[idx + 2] = b * edgeFactor;
            } else {
                // ‰øùÊåÅÈùûËæπÁºòÂå∫Âüü‰∏çÂèòÊàñÁ®çÂæÆÂèò‰∫Æ
                const nonEdgeFactor = Math.min(1.2, 1 + (strength / 100));
                data[idx] = Math.min(255, r * nonEdgeFactor);
                data[idx + 1] = Math.min(255, g * nonEdgeFactor);
                data[idx + 2] = Math.min(255, b * nonEdgeFactor);
            }
        }
    }
    
    return enhancedData;
};

// Euclidean distance between two RGB colors
const getDistance = (c1, c2) => {
    return Math.sqrt((c1.r - c2.r) ** 2 + (c1.g - c2.g) ** 2 + (c1.b - c2.b) ** 2);
};

// Find dominant color in a region using improved sampling
const findDominantColor = (imageData, startX, startY, width, height, imageWidth) => {
    const colorCount = {};
    let totalPixels = 0;
    
    for (let y = startY; y < startY + height; y++) {
        for (let x = startX; x < startX + width; x++) {
            if (x >= imageWidth || y * imageWidth + x >= imageData.length / 4) continue;
            
            const i = (y * imageWidth + x) * 4;
            const r = imageData[i];
            const g = imageData[i + 1];
            const b = imageData[i + 2];
            const a = imageData[i + 3];
            
            // Skip transparent/semi-transparent pixels
            if (a < 128) continue;
            
            totalPixels++;
            
            // Create color key with some quantization to group similar colors
            const qr = Math.round(r / 8) * 8;
            const qg = Math.round(g / 8) * 8;
            const qb = Math.round(b / 8) * 8;
            const key = `${qr},${qg},${qb}`;
            colorCount[key] = (colorCount[key] || 0) + 1;
        }
    }
    
    // If no valid pixels, return null
    if (totalPixels === 0) return null;
    
    // Find color with maximum frequency
    let maxCount = 0;
    let dominantColorKey = null;
    
    for (const [colorKey, count] of Object.entries(colorCount)) {
        if (count > maxCount) {
            maxCount = count;
            dominantColorKey = colorKey;
        }
    }
    
    if (dominantColorKey) {
        const [r, g, b] = dominantColorKey.split(',').map(Number);
        return { r, g, b };
    }
    
    return null;
};

// Find closest color in palette
const findClosestColor = (targetRgb, palette) => {
    if (!targetRgb || palette.length === 0) return null;
    
    let minDistance = Infinity;
    let closestColor = null;
    
    try {
        for (const colorKey of palette) {
            // Á°Æ‰øùÈ¢úËâ≤ÈîÆÂ≠òÂú®
            if (!colorKey) continue;
            
            const color = BRAND_COLORS[state.currentBrand][colorKey];
            if (!color) {
                console.warn(`È¢úËâ≤ ${colorKey} Âú®ÂìÅÁâå ${state.currentBrand} ‰∏≠‰∏çÂ≠òÂú®`);
                continue;
            }
            
            const rgb = hexToRgb(color);
            if (!rgb) {
                console.warn(`Êó†Ê≥ïËß£ÊûêÈ¢úËâ≤ ${colorKey} ÁöÑÂçÅÂÖ≠ËøõÂà∂ÂÄº: ${color}`);
                continue;
            }
            
            const distance = getDistance(targetRgb, rgb);
            
            if (distance < minDistance) {
                minDistance = distance;
                closestColor = colorKey;
            }
        }
    } catch (error) {
        console.error('Âú®Êü•ÊâæÊúÄËøëÈ¢úËâ≤Êó∂Âá∫Èîô:', error);
    }
    
    return closestColor;
};

// Hex to RGB conversion
const hexToRgb = (hex) => {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
};

// Convert numeric coordinates
const toAlphaCoord = (x, y) => {
    return `${x + 1},${y + 1}`;
};

// BFS for region merging
const mergeSimilarRegions = (data, width, height, threshold) => {
    const visited = Array(height).fill(null).map(() => Array(width).fill(false));
    const result = data.map(row => [...row]);
    const regions = [];
    let regionCount = 0;
    
    const directions = [[0, 1], [1, 0], [0, -1], [-1, 0]];
    
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            if (visited[y][x]) continue;
            
            const currentColor = data[y][x];
            const region = [];
            const queue = [[x, y]];
            visited[y][x] = true;
            
            // BFS to find connected region
            while (queue.length > 0) {
                const [cx, cy] = queue.shift();
                region.push([cx, cy]);
                
                for (const [dx, dy] of directions) {
                    const nx = cx + dx;
                    const ny = cy + dy;
                    
                    if (nx >= 0 && nx < width && ny >= 0 && ny < height && 
                        !visited[ny][nx] && data[ny][nx] === currentColor) {
                        visited[ny][nx] = true;
                        queue.push([nx, ny]);
                    }
                }
            }
            
            // If region is small enough, merge with surrounding colors
            if (region.length > 1) {
                regionCount++;
                
                // Check similarity with adjacent regions
                const adjacentColors = {};
                
                for (const [cx, cy] of region) {
                    for (const [dx, dy] of directions) {
                        const nx = cx + dx;
                        const ny = cy + dy;
                        
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            const adjacentColor = data[ny][nx];
                            if (adjacentColor !== currentColor) {
                                const color1 = hexToRgb(BRAND_COLORS[state.currentBrand][currentColor]);
                                const color2 = hexToRgb(BRAND_COLORS[state.currentBrand][adjacentColor]);
                                const distance = getDistance(color1, color2);
                                
                                if (distance < threshold) {
                                    adjacentColors[adjacentColor] = (adjacentColors[adjacentColor] || 0) + 1;
                                }
                            }
                        }
                    }
                }
                
                // Find most similar adjacent color
                let maxAdjacency = 0;
                let dominantAdjacentColor = currentColor;
                
                for (const [color, count] of Object.entries(adjacentColors)) {
                    if (count > maxAdjacency) {
                        maxAdjacency = count;
                        dominantAdjacentColor = color;
                    }
                }
                
                // Merge if similar enough
                if (dominantAdjacentColor !== currentColor && maxAdjacency > 0) {
                    for (const [cx, cy] of region) {
                        result[cy][cx] = dominantAdjacentColor;
                    }
                }
            }
        }
    }
    
    return { result, regionCount };
};

// Flood fill for background removal
const removeBackground = (data, width, height) => {
    const isExternal = Array(height).fill(null).map(() => Array(width).fill(false));
    const visited = Array(height).fill(null).map(() => Array(width).fill(false));
    
    // Start from all boundary cells
    const queue = [];
    
    // Add all boundary cells
    for (let x = 0; x < width; x++) {
        queue.push([x, 0]);
        queue.push([x, height - 1]);
    }
    for (let y = 1; y < height - 1; y++) {
        queue.push([0, y]);
        queue.push([width - 1, y]);
    }
    
    const directions = [[0, 1], [1, 0], [0, -1], [-1, 0]];
    
    while (queue.length > 0) {
        const [cx, cy] = queue.shift();
        
        if (visited[cy][cx]) continue;
        visited[cy][cx] = true;
        
        const color = data[cy][cx];
        
        // Check if this is a background color
        if (BACKGROUND_COLOR_KEYS.includes(color)) {
            isExternal[cy][cx] = true;
            
            // Add adjacent cells to queue
            for (const [dx, dy] of directions) {
                const nx = cx + dx;
                const ny = cy + dy;
                
                if (nx >= 0 && nx < width && ny >= 0 && ny < height && !visited[ny][nx]) {
                    queue.push([nx, ny]);
                }
            }
        }
    }
    
    return isExternal;
};

// Remap excluded colors
const remapExcludedColors = (data, excludedColors, availableColors) => {
    if (excludedColors.size === 0) return data;
    
    const result = data.map(row => [...row]);
    
    for (const excludedColor of excludedColors) {
        const targetPalette = availableColors.filter(color => !excludedColors.has(color));
        
        if (targetPalette.length === 0) {
            console.warn('No available colors after exclusion');
            continue;
        }
        
        for (let y = 0; y < result.length; y++) {
            for (let x = 0; x < result[y].length; x++) {
                if (result[y][x] === excludedColor) {
                    // Find closest color from target palette
                    const excludedRgb = hexToRgb(BRAND_COLORS[state.currentBrand][excludedColor]);
                    const newColor = findClosestColor(excludedRgb, targetPalette);
                    if (newColor) {
                        result[y][x] = newColor;
                    }
                }
            }
        }
    }
    
    return result;
};

// --- Main Processing Pipeline ---

// Step 1: Initial Color Mapping with Max Pooling
const performInitialMapping = (imageData, width, height, imageWidth, imageHeight) => {
    const cellWidth = Math.floor(imageWidth / width);
    const cellHeight = Math.floor(imageHeight / height);
    const mappedData = [];
    
    console.log(`ÂºÄÂßãÂàùÂßãÊò†Â∞Ñ: ${width}x${height}, ÂçïÂÖÉÊ†ºÂ§ßÂ∞è: ${cellWidth}x${cellHeight}`);
    
    for (let y = 0; y < height; y++) {
        const row = [];
        const startY = Math.floor(y * cellHeight);
        
        for (let x = 0; x < width; x++) {
            const startX = Math.floor(x * cellWidth);
            
            // Find dominant color in this cell
            const dominantColor = findDominantColor(
                imageData, startX, startY, 
                cellWidth, cellHeight, imageWidth
            );
            
            if (dominantColor) {
                // Map to closest color in active palette
                const colorKey = findClosestColor(dominantColor, state.activePalette);
                if (colorKey) {
                    row.push(colorKey);
                } else {
                    // Use first available color as fallback
                    row.push(state.activePalette[0]);
                }
            } else {
                // Use first available color as fallback
                row.push(state.activePalette[0]);
            }
        }
        mappedData.push(row);
    }
    
    console.log('ÂàùÂßãÊò†Â∞ÑÂÆåÊàêÔºåÊò†Â∞ÑÊï∞ÊçÆË°åÊï∞:', mappedData.length);
    return mappedData;
};

// Step 2: Region Color Merging
const performRegionMerging = (data) => {
    const { result, regionCount } = mergeSimilarRegions(
        data, data[0].length, data.length, state.similarityThreshold
    );
    
    state.processingMode = 'Âå∫ÂüüÂêàÂπ∂';
    state.mergedRegions = regionCount;
    updateStatus();
    
    console.log(`Âå∫ÂüüÂêàÂπ∂ÂÆåÊàêÔºåÂêàÂπ∂‰∫Ü ${regionCount} ‰∏™Âå∫Âüü`);
    return result;
};

// Step 3: Background Removal
const performBackgroundRemoval = (data) => {
    const isExternal = removeBackground(data, data[0].length, data.length);
    
    state.processingMode = 'ËÉåÊôØÁßªÈô§';
    state.backgroundRemoved = `${isExternal.flat().filter(x => x).length}‰∏™ÂçïÂÖÉÊ†º`;
    updateStatus();
    
    console.log(`ËÉåÊôØÁßªÈô§ÂÆåÊàêÔºåÊ†áËÆ∞‰∫Ü ${isExternal.flat().filter(x => x).length} ‰∏™ËÉåÊôØÂçïÂÖÉÊ†º`);
    return isExternal;
};

// Step 4: Color Exclusion and Remapping
const performColorExclusion = (data, excludedColors) => {
    if (excludedColors.size === 0) return data;
    
    const availableColors = state.activePalette.filter(color => !excludedColors.has(color));
    console.log(`È¢úËâ≤ÊéíÈô§Â§ÑÁêÜÔºåÊéíÈô§È¢úËâ≤Êï∞: ${excludedColors.size}, ÂèØÁî®È¢úËâ≤Êï∞: ${availableColors.length}`);
    return remapExcludedColors(data, excludedColors, availableColors);
};

// Complete processing pipeline
const processImage = async () => {
    if (!state.originalImage) {
        alert("ËØ∑ÂÖà‰∏ä‰º†ÂõæÁâáÔºÅ");
        return;
    }
    
    console.log('ÂºÄÂßãÂ§ÑÁêÜÂõæÁâá...');
    
    // Show progress
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    progressContainer.style.display = 'block';
    progressFill.style.width = '0%';
    progressText.textContent = 'ÂàùÂßãÂåñ...';
    
    try {
        // Ê£ÄÊü•ÂΩìÂâçÂìÅÁâåÂíåËâ≤Êùø
        console.log('ÂΩìÂâçÂìÅÁâå:', state.currentBrand);
        console.log('Ê¥ªÂä®Ëâ≤ÊùøÂ§ßÂ∞è:', state.activePalette.length);
        
        // È™åËØÅÊ¥ªÂä®Ëâ≤Êùø
        if (!state.activePalette || state.activePalette.length === 0) {
            throw new Error('Ê¥ªÂä®Ëâ≤Êùø‰∏∫Á©∫');
        }
        
        // È™åËØÅÂìÅÁâåÈ¢úËâ≤Êï∞ÊçÆ
        if (!BRAND_COLORS[state.currentBrand]) {
            throw new Error(`ÂìÅÁâå ${state.currentBrand} ÁöÑÈ¢úËâ≤Êï∞ÊçÆ‰∏çÂ≠òÂú®`);
        }
        
        // Create canvas for image data
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const width = parseInt(document.getElementById('width-input').value);
        const height = parseInt(document.getElementById('height-input').value);
        
        // Set canvas to actual image dimensions for processing
        canvas.width = state.originalImage.width;
        canvas.height = state.originalImage.height;
        ctx.drawImage(state.originalImage, 0, 0);
        
        let fullImageData = ctx.getImageData(0, 0, state.originalImage.width, state.originalImage.height);
        
        // Â∫îÁî®Á∫øÊù°Â¢ûÂº∫
        if (state.lineEnhance) {
            progressFill.style.width = '10%';
            progressText.textContent = 'Â∫îÁî®Á∫øÊù°Â¢ûÂº∫...';
            fullImageData = applyLineEnhancement(fullImageData, state.lineStrength);
        }
        
        // Step 1: Initial Mapping
        progressFill.style.width = '25%';
        progressText.textContent = 'Ê≠•È™§1: ÂàùÂßãÈ¢úËâ≤Êò†Â∞Ñ...';
        
        try {
            state.initialMappedData = performInitialMapping(
                fullImageData.data, width, height, 
                state.originalImage.width, state.originalImage.height
            );
            
            // È™åËØÅÂàùÂßãÊò†Â∞ÑÁªìÊûú
            if (!state.initialMappedData || state.initialMappedData.length === 0) {
                throw new Error('ÂàùÂßãÈ¢úËâ≤Êò†Â∞ÑÂ§±Ë¥•');
            }
        } catch (error) {
            console.error('ÂàùÂßãÈ¢úËâ≤Êò†Â∞ÑÂá∫Èîô:', error);
            throw new Error(`ÂàùÂßãÈ¢úËâ≤Êò†Â∞ÑÂ§±Ë¥•: ${error.message}`);
        }
        
        // Step 2: Region Merging
        progressFill.style.width = '50%';
        progressText.textContent = 'Ê≠•È™§2: Âå∫ÂüüÈ¢úËâ≤ÂêàÂπ∂...';
        
        try {
            state.mergedData = performRegionMerging(state.initialMappedData);
            
            // È™åËØÅÂå∫ÂüüÂêàÂπ∂ÁªìÊûú
            if (!state.mergedData || state.mergedData.length === 0) {
                throw new Error('Âå∫ÂüüÈ¢úËâ≤ÂêàÂπ∂Â§±Ë¥•');
            }
        } catch (error) {
            console.error('Âå∫ÂüüÈ¢úËâ≤ÂêàÂπ∂Âá∫Èîô:', error);
            throw new Error(`Âå∫ÂüüÈ¢úËâ≤ÂêàÂπ∂Â§±Ë¥•: ${error.message}`);
        }
        
        // Step 3: Background Removal
        progressFill.style.width = '75%';
        progressText.textContent = 'Ê≠•È™§3: ËÉåÊôØÁßªÈô§...';
        
        try {
            state.externalBackground = performBackgroundRemoval(state.mergedData);
            
            // È™åËØÅËÉåÊôØÁßªÈô§ÁªìÊûú
            if (!state.externalBackground || state.externalBackground.length === 0) {
                throw new Error('ËÉåÊôØÁßªÈô§Â§±Ë¥•');
            }
        } catch (error) {
            console.error('ËÉåÊôØÁßªÈô§Âá∫Èîô:', error);
            throw new Error(`ËÉåÊôØÁßªÈô§Â§±Ë¥•: ${error.message}`);
        }
        
        // Step 4: Color Exclusion
        progressFill.style.width = '90%';
        progressText.textContent = 'Ê≠•È™§4: È¢úËâ≤ÊéíÈô§Â§ÑÁêÜ...';
        
        try {
            state.colorData = performColorExclusion(state.mergedData, state.excludedColors);
            
            // È™åËØÅÈ¢úËâ≤ÊéíÈô§ÁªìÊûú
            if (!state.colorData || state.colorData.length === 0) {
                throw new Error('È¢úËâ≤ÊéíÈô§Â§ÑÁêÜÂ§±Ë¥•');
            }
        } catch (error) {
            console.error('È¢úËâ≤ÊéíÈô§Â§ÑÁêÜÂá∫Èîô:', error);
            throw new Error(`È¢úËâ≤ÊéíÈô§Â§ÑÁêÜÂ§±Ë¥•: ${error.message}`);
        }
        
        // Update color counts
        state.colorCounts = {};
        for (let y = 0; y < state.colorData.length; y++) {
            for (let x = 0; x < state.colorData[y].length; x++) {
                if (!state.externalBackground[y][x]) {
                    const key = state.colorData[y][x];
                    state.colorCounts[key] = (state.colorCounts[key] || 0) + 1;
                }
            }
        }
        
        progressFill.style.width = '100%';
        progressText.textContent = 'ÂÆåÊàêÔºÅ';
        
        console.log('ÂõæÁâáÂ§ÑÁêÜÂÆåÊàêÔºåÈ¢úËâ≤ÁªüËÆ°:', state.colorCounts);
        
        setTimeout(() => {
            progressContainer.style.display = 'none';
        }, 1000);
        
        renderCanvas();
        renderShoppingList();
        
    } catch (error) {
        console.error('Â§ÑÁêÜÂõæÁâáÊó∂Âá∫Èîô:', error);
        progressText.textContent = `Â§ÑÁêÜÂ§±Ë¥•: ${error.message}`;
        
        setTimeout(() => {
            progressContainer.style.display = 'none';
        }, 3000);
    }
};

// --- Rendering Functions ---

// ‰øÆÂ§çÔºöÂÖ®Êñ∞ÁöÑÂõæÁ∫∏È¢ÑËßàÊ∏≤ÊüìÂáΩÊï∞ - Ëß£ÂÜ≥Áº©ÊîæÂíåÊòæÁ§∫ÈóÆÈ¢ò
const renderCanvas = (isEditMode = false, preserveZoom = false) => {
    if (!state.colorData || state.colorData.length === 0) {
        console.log('Ê≤°ÊúâÈ¢úËâ≤Êï∞ÊçÆÂèØ‰ª•Ê∏≤Êüì');
        return;
    }
    
    // ‰øùÂ≠òÂΩìÂâçËßÜÂè£Áä∂ÊÄÅ
    let viewportState = null;
    if (preserveZoom) {
        const viewport = document.getElementById(isEditMode ? 'edit-canvas-viewport' : 'canvas-viewport');
        if (viewport) {
            viewportState = {
                scrollLeft: viewport.scrollLeft,
                scrollTop: viewport.scrollTop,
                width: viewport.style.width,
                height: viewport.style.height
            };
            console.log('‰øùÂ≠òËßÜÂè£Áä∂ÊÄÅ:', viewportState);
        }
    }
    
    // ËÆ°ÁÆóÂÆûÈôÖÂÜÖÂÆπËæπÁïå - ‰ºòÂåñËæπÁïåËÆ°ÁÆóÂáèÂ∞ëÁ©∫ÁôΩ
    state.minX = state.colorData[0].length;
    state.maxX = 0;
    state.minY = state.colorData.length;
    state.maxY = 0;
    let hasContent = false;
    
    for(let y = 0; y < state.colorData.length; y++) {
        for(let x = 0; x < state.colorData[y].length; x++) {
            const key = state.colorData[y][x];
            if (!key) continue;
            
            // Âè™ÊúâÈùûËÉåÊôØ‰∏îÈùûÈöêËóèÁöÑÈ¢úËâ≤ËÆ°ÂÖ•ËæπÁïå
            if (!(state.externalBackground[y] && state.externalBackground[y][x]) && 
                !state.hiddenColors.has(key)) {
                hasContent = true;
                state.minX = Math.min(state.minX, x);
                state.maxX = Math.max(state.maxX, x);
                state.minY = Math.min(state.minY, y);
                state.maxY = Math.max(state.maxY, y);
            }
        }
    }
    
    // Â¶ÇÊûúÊ≤°ÊúâÂÜÖÂÆπÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
    if (!hasContent) {
        state.minX = 0;
        state.minY = 0;
        state.maxX = Math.min(10, state.colorData[0].length - 1);
        state.maxY = Math.min(10, state.colorData.length - 1);
    } else {
        // ÂáèÂ∞ë‰∏çÂøÖË¶ÅÁöÑËæπÁïåÊâ©Â±ï - Âè™Âú®ËæπÁïå‰∏çÊòØËæπÁºòÊó∂ÊâçÊâ©Â±ï
        if (state.minX > 0) state.minX = Math.max(0, state.minX);
        if (state.minY > 0) state.minY = Math.max(0, state.minY);
        if (state.maxX < state.colorData[0].length - 1) state.maxX = Math.min(state.colorData[0].length - 1, state.maxX);
        if (state.maxY < state.colorData.length - 1) state.maxY = Math.min(state.colorData.length - 1, state.maxY);
    }
    
    state.actualWidth = state.maxX - state.minX + 1;
    state.actualHeight = state.maxY - state.minY + 1;
    
    // ‰ΩøÁî®Âõ∫ÂÆöÂçïÂÖÉÊ†ºÂ§ßÂ∞èÔºå‰∏çÈöèÁº©ÊîæÂèòÂåñ
    const baseCellSize = 25;
    const scale = state.zoomLevel / 100;
    
    // ÂáèÂ∞ëÂùêÊ†áÂíåÂÜÖËæπË∑ùÂç†Áî®Á©∫Èó¥
    const coordSize = state.showCoords ? 30 : 10;
    const padding = state.showCoords ? 40 : 15;
    
    // ÂàõÂª∫ÁîªÂ∏É
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.id = 'pattern-canvas';
    
    // ‰ΩøÁî®Âü∫Á°ÄÂçïÂÖÉÊ†ºÂ§ßÂ∞èËÆ°ÁÆóÁîªÂ∏ÉÂ∞∫ÂØ∏ÔºåÁ°Æ‰øùÂÜÖÂÆπÂÆåÊï¥
    canvas.width = state.actualWidth * baseCellSize + padding;
    canvas.height = state.actualHeight * baseCellSize + padding;
    
    // ‰øùÂ≠òÁîªÂ∏ÉÂºïÁî®
    state.canvas = canvas;
    state.ctx = ctx;
    
    ctx.imageSmoothingEnabled = false;
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // ÁªòÂà∂ÂùêÊ†áÊ†áÁ≠æ - ÂáèÂ∞èÂ≠ó‰ΩìÂíåÈó¥Ë∑ù
    if (state.showCoords) {
        ctx.font = `bold 12px Arial`; 
        ctx.textAlign = 'center'; 
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#333';
        
        for(let x = state.minX; x <= state.maxX; x++) {
            const label = (x + 1).toString();
            const xPos = (x - state.minX) * baseCellSize + baseCellSize/2 + padding/2;
            ctx.fillText(label, xPos, padding/2 - 10);
        }
        
        for(let y = state.minY; y <= state.maxY; y++) {
            const label = (y + 1).toString();
            const yPos = (y - state.minY) * baseCellSize + baseCellSize/2 + padding/2;
            ctx.fillText(label, padding/2 - 10, yPos);
        }
    }

    // ÁªòÂà∂ÁΩëÊ†ºÂíåÁè†Â≠ê
    const offsetX = state.showCoords ? padding/2 : 10;
    const offsetY = state.showCoords ? padding/2 : 10;
    
    for(let y = state.minY; y <= state.maxY; y++) {
        for(let x = state.minX; x <= state.maxX; x++) {
            const key = state.colorData[y][x];
            if (!key) continue;
            
            // ‰ΩøÁî®Âü∫Á°ÄÂçïÂÖÉÊ†ºÂ§ßÂ∞èËÆ°ÁÆó‰ΩçÁΩÆ
            const px = (x - state.minX) * baseCellSize + offsetX;
            const py = (y - state.minY) * baseCellSize + offsetY;
            
            // Ë∑≥ËøáÈöêËóèÁöÑÈ¢úËâ≤
            if (state.hiddenColors.has(key)) {
                ctx.fillStyle = '#f8f8f8';
                ctx.fillRect(px, py, baseCellSize, baseCellSize);
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                ctx.strokeRect(px, py, baseCellSize, baseCellSize);
                continue;
            }
            
            // Ë∑≥ËøáÂ§ñÈÉ®ËÉåÊôØÔºàÂ¶ÇÊûú‰∏çÊòæÁ§∫ËÉåÊôØÔºâ
            if (!state.showBackground && state.externalBackground[y] && state.externalBackground[y][x]) {
                continue;
            }
            
            // ÁªòÂà∂Áè†Â≠ê
            if (state.externalBackground[y] && state.externalBackground[y][x]) {
                ctx.fillStyle = '#f0f0f0';
            } else {
                const color = BRAND_COLORS[state.currentBrand][key];
                if (!color) {
                    console.warn(`È¢úËâ≤ ${key} Âú®ÂìÅÁâå ${state.currentBrand} ‰∏≠‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®ÈªòËÆ§È¢úËâ≤`);
                    ctx.fillStyle = '#ccc';
                } else {
                    ctx.fillStyle = color;
                }
            }
            ctx.fillRect(px, py, baseCellSize, baseCellSize);
            
            // ÁªòÂà∂ÁΩëÊ†º
            if (state.showGrid) {
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.strokeRect(px, py, baseCellSize, baseCellSize);
            }
            
            // È´ò‰∫ÆÁõ∏ÂêåÈ¢úËâ≤
            if (state.highlightedColor === key) {
                ctx.fillStyle = 'rgba(255, 200, 0, 0.4)';
                ctx.fillRect(px, py, baseCellSize, baseCellSize);
                ctx.strokeStyle = '#ff9500';
                ctx.lineWidth = 3;
                ctx.strokeRect(px, py, baseCellSize, baseCellSize);
                ctx.lineWidth = 1;
            }
            
            // ÁªòÂà∂Ëâ≤Âè∑
            if (state.showColors && !(state.externalBackground[y] && state.externalBackground[y][x])) {
                const color = BRAND_COLORS[state.currentBrand][key];
                if (color) {
                    const rgb = hexToRgb(color);
                    const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                    ctx.fillStyle = brightness > 140 ? '#000' : '#fff';
                    
                    const fontSize = Math.min(baseCellSize * 0.4, 18);
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle';
                    
                    const text = key;
                    ctx.fillText(text, px + baseCellSize/2, py + baseCellSize/2);
                }
            }
        }
    }
    
    // ËÆæÁΩÆÁõÆÊ†áÂå∫Âüü
    const targetSection = isEditMode ? 
        document.getElementById('edit-mode-canvas-container') : 
        document.getElementById('canvas-section');
    
    // ‰øÆÂ§çÔºö‰øùÂ≠òÂéüÊúâÁöÑÁº©ÊîæÊéß‰ª∂Áä∂ÊÄÅ
    let zoomValue = null;
    if (preserveZoom) {
        const existingZoomValue = document.getElementById(isEditMode ? 'edit-zoom-value' : 'zoom-value');
        if (existingZoomValue) {
            zoomValue = existingZoomValue.textContent;
        }
    }
    
    targetSection.innerHTML = ''; 
    
    // ÂàõÂª∫ÊéßÂà∂Ê†è
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'canvas-controls';
    
    // Áº©ÊîæÊéßÂà∂
    const zoomControls = document.createElement('div');
    zoomControls.className = 'zoom-controls';
    
    const zoomOutBtn = document.createElement('button');
    zoomOutBtn.className = 'zoom-btn';
    zoomOutBtn.textContent = 'Ôºç';
    zoomOutBtn.onclick = () => {
        state.zoomLevel = Math.max(state.zoomState.min, state.zoomLevel - state.zoomState.step);
        updateZoomDisplay();
        applyZoom();
    };
    
    const zoomValueSpan = document.createElement('span');
    zoomValueSpan.className = 'zoom-value';
    zoomValueSpan.id = isEditMode ? 'edit-zoom-value' : 'zoom-value';
    // ÊÅ¢Â§çÁº©ÊîæÂÄºÊòæÁ§∫
    zoomValueSpan.textContent = zoomValue || (state.zoomLevel + '%');
    
    const zoomInBtn = document.createElement('button');
    zoomInBtn.className = 'zoom-btn';
    zoomInBtn.textContent = 'Ôºã';
    zoomInBtn.onclick = () => {
        state.zoomLevel = Math.min(state.zoomState.max, state.zoomLevel + state.zoomState.step);
        updateZoomDisplay();
        applyZoom();
    };
    
    const zoomResetBtn = document.createElement('button');
    zoomResetBtn.className = 'zoom-btn';
    zoomResetBtn.textContent = '‚ü≤';
    zoomResetBtn.onclick = () => {
        state.zoomLevel = 100;
        updateZoomDisplay();
        applyZoom();
    };
    
    zoomControls.appendChild(zoomOutBtn);
    zoomControls.appendChild(zoomValueSpan);
    zoomControls.appendChild(zoomInBtn);
    zoomControls.appendChild(zoomResetBtn);
    
    controlsDiv.appendChild(zoomControls);
    targetSection.appendChild(controlsDiv);
    
    // ÂàõÂª∫ËßÜÂè£ÂÆπÂô® - ‰øÆÂ§çÂÖ≥ÈîÆÈóÆÈ¢ò
    const viewport = document.createElement('div');
    viewport.className = 'canvas-viewport';
    viewport.id = isEditMode ? 'edit-canvas-viewport' : 'canvas-viewport';
    
    // ÂàõÂª∫ÂÜÖÂÆπÂÆπÂô®
    const content = document.createElement('div');
    content.className = 'canvas-content';
    content.id = isEditMode ? 'edit-canvas-content' : 'canvas-content';
    
    // Ê∑ªÂä†ÁîªÂ∏ÉÂà∞ÂÜÖÂÆπÂÆπÂô®
    content.appendChild(canvas);
    
    // Ê∑ªÂä†ÂÜÖÂÆπÂÆπÂô®Âà∞ËßÜÂè£
    viewport.appendChild(content);
    
    // Ê∑ªÂä†ËßÜÂè£Âà∞ÁõÆÊ†áÂå∫Âüü
    targetSection.appendChild(viewport);
    
    // ‰øÆÂ§çÔºöÂ∫îÁî®Áº©ÊîæÂáΩÊï∞ - Ëß£ÂÜ≥Áº©ÊîæÂíåÊãñÊãΩÈóÆÈ¢ò
    function applyZoom() {
        const viewport = document.getElementById(isEditMode ? 'edit-canvas-viewport' : 'canvas-viewport');
        const content = viewport?.querySelector('.canvas-content');
        if (!viewport || !content || !state.canvas) return;
        
        const scale = state.zoomLevel / 100;
        
        // ËÆæÁΩÆÂÜÖÂÆπÂ∞∫ÂØ∏‰∏∫ÂéüÂßãÁîªÂ∏ÉÂ∞∫ÂØ∏
        content.style.width = `${state.canvas.width}px`;
        content.style.height = `${state.canvas.height}px`;
        
        // Â∫îÁî®Áº©ÊîæÂèòÊç¢
        content.style.transform = `scale(${scale})`;
        content.style.transformOrigin = '0 0';
        
        // ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - ËÆ°ÁÆóÁº©ÊîæÂêéÁöÑÂÆûÈôÖÂÜÖÂÆπÂ∞∫ÂØ∏
        const scaledWidth = state.canvas.width * scale;
        const scaledHeight = state.canvas.height * scale;
        
        // ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - ËßÜÂè£Â∞∫ÂØ∏Â∫îËØ•Âü∫‰∫éÂÆπÂô®Â§ßÂ∞èÔºåËÄå‰∏çÊòØÁº©ÊîæÂêéÁöÑÂÜÖÂÆπ
        const containerRect = viewport.parentElement.getBoundingClientRect();
        const maxViewportWidth = containerRect.width - 40; // ÂáèÂéªpadding
        const maxViewportHeight = Math.min(600, window.innerHeight * 0.6); // ÈôêÂà∂ÊúÄÂ§ßÈ´òÂ∫¶
        
        // ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - ËßÜÂè£Â∞∫ÂØ∏Â∫îËØ•ÊòØÂÆπÂô®ÈôêÂà∂ÂíåÁº©ÊîæÂÜÖÂÆπÂ∞∫ÂØ∏ÁöÑËæÉÂ∞èÂÄº
        const viewportWidth = Math.min(maxViewportWidth, Math.max(scaledWidth + 40, 300));
        const viewportHeight = Math.min(maxViewportHeight, Math.max(scaledHeight + 40, 400));
        
        // Â∫îÁî®ËßÜÂè£Â∞∫ÂØ∏
        viewport.style.width = `${viewportWidth}px`;
        viewport.style.height = `${viewportHeight}px`;
        
        // ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - Á°Æ‰øùÊªöÂä®Êù°Ê≠£Á°ÆÊòæÁ§∫
        if (scaledWidth > viewportWidth - 40 || scaledHeight > viewportHeight - 40) {
            viewport.style.overflow = 'auto';
        } else {
            viewport.style.overflow = 'hidden';
        }
        
        // ÊÅ¢Â§çËßÜÂè£Áä∂ÊÄÅ
        if (preserveZoom && viewportState) {
            // ‰ΩøÁî®setTimeoutÁ°Æ‰øùDOMÊõ¥Êñ∞ÂêéÂÜçÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
            setTimeout(() => {
                viewport.scrollLeft = viewportState.scrollLeft;
                viewport.scrollTop = viewportState.scrollTop;
                console.log('ÊÅ¢Â§çËßÜÂè£Áä∂ÊÄÅ:', viewportState.scrollLeft, viewportState.scrollTop);
            }, 10);
        }
        
        console.log(`Áº©ÊîæÂ∫îÁî®: ${state.zoomLevel}%, ËßÜÂè£: ${viewportWidth}x${viewportHeight}, ÂÜÖÂÆπ: ${scaledWidth}x${scaledHeight}`);
    }
    
    // Êõ¥Êñ∞Áº©ÊîæÊòæÁ§∫
    function updateZoomDisplay() {
        zoomValueSpan.textContent = state.zoomLevel + '%';
    }
    
    // ‰øÆÂ§çÔºöÂè™Âú®‰∏çÈúÄË¶Å‰øùÊåÅÁº©ÊîæÊó∂Â∫îÁî®Áº©Êîæ
    if (!preserveZoom) {
        applyZoom();
    } else {
        // ‰øùÊåÅÂΩìÂâçÁº©ÊîæÁä∂ÊÄÅÔºåÂè™Êõ¥Êñ∞ÁîªÂ∏ÉÂÜÖÂÆπ
        const scale = state.zoomLevel / 100;
        
        // ËÆæÁΩÆÂÜÖÂÆπÂ∞∫ÂØ∏‰∏∫ÂéüÂßãÁîªÂ∏ÉÂ∞∫ÂØ∏
        content.style.width = `${state.canvas.width}px`;
        content.style.height = `${state.canvas.height}px`;
        
        // Â∫îÁî®Áº©ÊîæÂèòÊç¢
        content.style.transform = `scale(${scale})`;
        content.style.transformOrigin = '0 0';
        
        // ËÆ°ÁÆóÁº©ÊîæÂêéÁöÑÂÆûÈôÖÂÜÖÂÆπÂ∞∫ÂØ∏
        const scaledWidth = state.canvas.width * scale;
        const scaledHeight = state.canvas.height * scale;
        
        // ËßÜÂè£Â∞∫ÂØ∏Â∫îËØ•Âü∫‰∫éÂÆπÂô®Â§ßÂ∞è
        const containerRect = viewport.parentElement.getBoundingClientRect();
        const maxViewportWidth = containerRect.width - 40;
        const maxViewportHeight = Math.min(600, window.innerHeight * 0.6);
        
        // ËßÜÂè£Â∞∫ÂØ∏Â∫îËØ•ÊòØÂÆπÂô®ÈôêÂà∂ÂíåÁº©ÊîæÂÜÖÂÆπÂ∞∫ÂØ∏ÁöÑËæÉÂ∞èÂÄº
        const viewportWidth = Math.min(maxViewportWidth, Math.max(scaledWidth + 40, 300));
        const viewportHeight = Math.min(maxViewportHeight, Math.max(scaledHeight + 40, 400));
        
        // Â∫îÁî®ËßÜÂè£Â∞∫ÂØ∏
        viewport.style.width = `${viewportWidth}px`;
        viewport.style.height = `${viewportHeight}px`;
        
        // Á°Æ‰øùÊªöÂä®Êù°Ê≠£Á°ÆÊòæÁ§∫
        if (scaledWidth > viewportWidth - 40 || scaledHeight > viewportHeight - 40) {
            viewport.style.overflow = 'auto';
        } else {
            viewport.style.overflow = 'hidden';
        }
        
        // ÊÅ¢Â§çËßÜÂè£Áä∂ÊÄÅ
        if (viewportState) {
            // ‰ΩøÁî®setTimeoutÁ°Æ‰øùDOMÊõ¥Êñ∞ÂêéÂÜçÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
            setTimeout(() => {
                viewport.scrollLeft = viewportState.scrollLeft;
                viewport.scrollTop = viewportState.scrollTop;
                console.log('ÊÅ¢Â§çËßÜÂè£Áä∂ÊÄÅ:', viewportState.scrollLeft, viewportState.scrollTop);
            }, 10);
        }
    }
    
    // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
    attachCanvasListeners(canvas, isEditMode);
    attachViewportListeners(viewport, isEditMode);
    
    // ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - ÈáçÊñ∞ÁªëÂÆöÁºñËæëÊ®°ÂºèÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô®
    if (isEditMode) {
        setTimeout(() => {
            bindEditModeEvents();
        }, 100);
    }
};

// ‰øÆÂ§çÔºöÂÖ®Êñ∞ÁöÑËßÜÂè£‰∫ã‰ª∂ÁõëÂê¨Âô® - Ëß£ÂÜ≥ÁßªÂä®Á´ØÁº©ÊîæÂíåÊãñÊãΩÈóÆÈ¢ò
const attachViewportListeners = (viewport, isEditMode = false) => {
    let isDragging = false;
    let startX, startY;
    let scrollLeft = 0;
    let scrollTop = 0;
    let initialDistance = 0;
    let initialScale = 1;
    
    // Èº†Ê†áÊªöËΩÆÁº©Êîæ
    viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const currentScale = state.zoomLevel / 100;
        const newScale = Math.min(Math.max(state.zoomState.min / 100, currentScale * delta), state.zoomState.max / 100);
        state.zoomLevel = Math.round(newScale * 100);
        
        // ‰øùÂ≠òÂΩìÂâçÊªöÂä®‰ΩçÁΩÆ
        const x = e.clientX - viewport.getBoundingClientRect().left;
        const y = e.clientY - viewport.getBoundingClientRect().top;
        
        const scaleChange = newScale / currentScale;
        
        // Ë∞ÉÊï¥ÊªöÂä®‰ΩçÁΩÆ‰ª•‰øùÊåÅÈº†Ê†á‰ΩçÁΩÆ‰∏çÂèò
        viewport.scrollLeft = (viewport.scrollLeft + x) * scaleChange - x;
        viewport.scrollTop = (viewport.scrollTop + y) * scaleChange - y;
        
        // Â∫îÁî®Áº©Êîæ
        const content = viewport.querySelector('.canvas-content');
        if (content) {
            const scale = state.zoomLevel / 100;
            content.style.transform = `scale(${scale})`;
            content.style.width = `${state.canvas.width}px`;
            content.style.height = `${state.canvas.height}px`;
            
            // ‰øÆÂ§çÔºöÂä®ÊÄÅË∞ÉÊï¥ËßÜÂè£Â∞∫ÂØ∏
            const scaledWidth = state.canvas.width * scale;
            const scaledHeight = state.canvas.height * scale;
            viewport.style.width = `${Math.max(scaledWidth + 40, 300)}px`;
            viewport.style.height = `${Math.max(scaledHeight + 40, 400)}px`;
        }
        
        // Êõ¥Êñ∞Áº©ÊîæÊòæÁ§∫
        const zoomValue = document.getElementById(isEditMode ? 'edit-zoom-value' : 'zoom-value');
        if (zoomValue) {
            zoomValue.textContent = state.zoomLevel + '%';
        }
    });
    
    // Èº†Ê†áÊãñÊãΩ - ‰øÆÂ§çÔºöÁ°Æ‰øùÁÇπÂáªÂõæÁ∫∏‰πüËÉΩÊãñÊãΩ
    viewport.addEventListener('mousedown', (e) => {
        // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáªÂú®canvas‰∏äÊàñËÄÖÈ¢úËâ≤Êõ¥Êç¢Ê®°Âºè
        const clickedOnCanvas = e.target.dataset.isCanvas === 'true' || 
                                e.target.closest('#pattern-canvas');
        
        if (state.isReplaceMode && clickedOnCanvas) {
            // È¢úËâ≤Êõ¥Êç¢Ê®°Âºè‰∏ãÁÇπÂáªcanvas‰∏çËß¶ÂèëÊãñÊãΩ
            return;
        }
        
        isDragging = true;
        startX = e.pageX - viewport.offsetLeft;
        startY = e.pageY - viewport.offsetTop;
        scrollLeft = viewport.scrollLeft;
        scrollTop = viewport.scrollTop;
        viewport.style.cursor = 'grabbing';
        viewport.classList.add('dragging');
        e.preventDefault();
    });
    
    viewport.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - viewport.offsetLeft;
        const y = e.pageY - viewport.offsetTop;
        const walkX = (x - startX) * 2;
        const walkY = (y - startY) * 2;
        viewport.scrollLeft = scrollLeft - walkX;
        viewport.scrollTop = scrollTop - walkY;
    });
    
    viewport.addEventListener('mouseup', () => {
        isDragging = false;
        viewport.style.cursor = 'grab';
        viewport.classList.remove('dragging');
    });
    
    viewport.addEventListener('mouseleave', () => {
        isDragging = false;
        viewport.style.cursor = 'grab';
        viewport.classList.remove('dragging');
    });
    
    // Ëß¶Êë∏‰∫ã‰ª∂Â§ÑÁêÜ - ‰øÆÂ§çÁßªÂä®Á´ØÁº©ÊîæÂíåÊãñÊãΩ
    viewport.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            // ÂèåÊåáÁº©Êîæ
            e.preventDefault();
            isDragging = false;
            initialDistance = getTouchDistance(e.touches);
            initialScale = state.zoomLevel / 100;
        } else if (e.touches.length === 1) {
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáªÂú®canvas‰∏äÊàñËÄÖÈ¢úËâ≤Êõ¥Êç¢Ê®°Âºè
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            const touchedOnCanvas = element && (
                element.dataset.isCanvas === 'true' || 
                element.closest('#pattern-canvas')
            );
            
            if (state.isReplaceMode && touchedOnCanvas) {
                // È¢úËâ≤Êõ¥Êç¢Ê®°Âºè‰∏ãÁÇπÂáªcanvas‰∏çËß¶ÂèëÊãñÊãΩ
                return;
            }
            
            // ÂçïÊåáÊãñÊãΩ
            e.preventDefault();
            isDragging = true;
            startX = touch.pageX - viewport.offsetLeft;
            startY = touch.pageY - viewport.offsetTop;
            scrollLeft = viewport.scrollLeft;
            scrollTop = viewport.scrollTop;
        }
    }, { passive: false });
    
    viewport.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            // ÂèåÊåáÁº©Êîæ
            e.preventDefault();
            isDragging = false;
            
            const currentDistance = getTouchDistance(e.touches);
            if (initialDistance > 0) {
                const newScale = Math.min(Math.max(state.zoomState.min / 100, initialScale * (currentDistance / initialDistance)), state.zoomState.max / 100);
                state.zoomLevel = Math.round(newScale * 100);
                
                // ËÆ°ÁÆóÁº©Êîæ‰∏≠ÂøÉÁÇπ
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const centerX = (touch1.clientX + touch2.clientX) / 2;
                const centerY = (touch1.clientY + touch2.clientY) / 2;
                
                const rect = viewport.getBoundingClientRect();
                const x = centerX - rect.left;
                const y = centerY - rect.top;
                
                const scaleChange = newScale / (state.zoomLevel / 100);
                
                // Ë∞ÉÊï¥ÊªöÂä®‰ΩçÁΩÆ‰ª•‰øùÊåÅÁº©Êîæ‰∏≠ÂøÉ‰∏çÂèò
                viewport.scrollLeft = (viewport.scrollLeft + x) * scaleChange - x;
                viewport.scrollTop = (viewport.scrollTop + y) * scaleChange - y;
                
                // Â∫îÁî®Áº©Êîæ
                const content = viewport.querySelector('.canvas-content');
                if (content) {
                    const scale = state.zoomLevel / 100;
                    content.style.transform = `scale(${scale})`;
                    content.style.width = `${state.canvas.width}px`;
                    content.style.height = `${state.canvas.height}px`;
                    
                    // ‰øÆÂ§çÔºöÂä®ÊÄÅË∞ÉÊï¥ËßÜÂè£Â∞∫ÂØ∏
                    const scaledWidth = state.canvas.width * scale;
                    const scaledHeight = state.canvas.height * scale;
                    viewport.style.width = `${Math.max(scaledWidth + 40, 300)}px`;
                    viewport.style.height = `${Math.max(scaledHeight + 40, 400)}px`;
                }
                
                // Êõ¥Êñ∞Áº©ÊîæÊòæÁ§∫
                const zoomValue = document.getElementById(isEditMode ? 'edit-zoom-value' : 'zoom-value');
                if (zoomValue) {
                    zoomValue.textContent = state.zoomLevel + '%';
                }
            }
        } else if (e.touches.length === 1 && isDragging && !state.isReplaceMode) {
            // ÂçïÊåáÊãñÊãΩ
            e.preventDefault();
            const touch = e.touches[0];
            const x = touch.pageX - viewport.offsetLeft;
            const y = touch.pageY - viewport.offsetTop;
            const walkX = (x - startX) * 2;
            const walkY = (y - startY) * 2;
            viewport.scrollLeft = scrollLeft - walkX;
            viewport.scrollTop = scrollTop - walkY;
        }
    }, { passive: false });
    
    viewport.addEventListener('touchend', () => {
        isDragging = false;
    });
    
    viewport.addEventListener('touchcancel', () => {
        isDragging = false;
    });
};

const getTouchDistance = (touches) => {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
};

// ‰øÆÂ§çÔºöÂùêÊ†áËÆ°ÁÆóÂáΩÊï∞ - ÈÄÇÈÖçÊñ∞ÁöÑUIÁªìÊûÑ
const getCanvasCoordinates = (canvas, event) => {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    // Ëé∑ÂèñÈº†Ê†áÂú®ÁîªÂ∏É‰∏≠ÁöÑÂÆûÈôÖÂùêÊ†á
    let clientX, clientY;
    if (event.touches && event.touches.length > 0) {
        clientX = event.touches[0].clientX;
        clientY = event.touches[0].clientY;
    } else if (event.changedTouches && event.changedTouches.length > 0) {
        clientX = event.changedTouches[0].clientX;
        clientY = event.changedTouches[0].clientY;
    } else {
        clientX = event.clientX;
        clientY = event.clientY;
    }
    
    // ËÆ°ÁÆóÁõ∏ÂØπ‰∫éÁîªÂ∏ÉÁöÑÂùêÊ†áÔºåËÄÉËôëÁº©Êîæ
    const canvasX = (clientX - rect.left) * scaleX;
    const canvasY = (clientY - rect.top) * scaleY;
    
    // ‰ΩøÁî®Âü∫Á°ÄcellSizeËÆ°ÁÆóÊ†ºÂ≠êÂùêÊ†á
    const baseCellSize = 25; // Âü∫Á°ÄÂçïÂÖÉÊ†ºÂ§ßÂ∞èÔºå‰∏çÈöèÁº©ÊîæÂèòÂåñ
    
    // ËÆ°ÁÆóÊ†ºÂ≠êÂùêÊ†áÔºå‰ΩøÁî®Âü∫Á°ÄcellSize
    const coordX = Math.floor((canvasX - 20) / baseCellSize) + state.minX;
    const coordY = Math.floor((canvasY - 20) / baseCellSize) + state.minY;
    
    return { x: coordX, y: coordY, canvasX, canvasY };
};

// ‰ºòÂåñÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô® - ÁßªÈô§ÈùûÈ¢úËâ≤Êõ¥Êç¢Ê®°Âºè‰∏ãÁöÑÁÇπÂáªÈÄâÊã©È¢úËâ≤ÂäüËÉΩ
const attachCanvasListeners = (canvas, isEditMode = false) => {
    // Â≠òÂÇ®canvasÂºïÁî®‰ª•‰æøÂú®ÊãñÊãΩ‰∫ã‰ª∂‰∏≠‰ΩøÁî®
    canvas.dataset.isCanvas = 'true';
    
    // Âè™Âú®È¢úËâ≤Êõ¥Êç¢Ê®°Âºè‰∏ãÂêØÁî®ÁÇπÂáª‰∫ã‰ª∂
    if (state.isReplaceMode) {
        canvas.style.cursor = 'pointer';
        
        canvas.onclick = (e) => {
            e.stopPropagation();
            const coords = getCanvasCoordinates(canvas, e);
            
            if (coords.x >= state.minX && coords.x <= state.maxX && 
                coords.y >= state.minY && coords.y <= state.maxY) {
                const key = state.colorData[coords.y][coords.x];
                if (key) {
                    state.selectedColor = key;
                    state.selectedCell = { x: coords.x, y: coords.y, color: key };
                    showColorPicker();
                }
            }
        };
        
        canvas.ontouchstart = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const coords = getCanvasCoordinates(canvas, e);
            
            if (coords.x >= state.minX && coords.x <= state.maxX && 
                coords.y >= state.minY && coords.y <= state.maxY) {
                const key = state.colorData[coords.y][coords.x];
                if (key) {
                    state.selectedColor = key;
                    state.selectedCell = { x: coords.x, y: coords.y, color: key };
                    showColorPicker();
                }
            }
        };
    } else {
        // ÈùûÈ¢úËâ≤Êõ¥Êç¢Ê®°Âºè‰∏ãÁöÑÈªòËÆ§Ê†∑Âºè - ÁßªÈô§ÁÇπÂáªÈÄâÊã©È¢úËâ≤ÂäüËÉΩ
        canvas.style.cursor = 'default';
        
        // ÁßªÈô§ÈùûÈ¢úËâ≤Êõ¥Êç¢Ê®°Âºè‰∏ãÁöÑÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
        // ‰∏çÂÜçËÆæÁΩÆcanvas.onclickÂíåcanvas.ontouchstart
    }
};

// ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - ÈáçÊñ∞ÁªëÂÆöÁºñËæëÊ®°ÂºèÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô®
const bindEditModeEvents = () => {
    console.log('ÈáçÊñ∞ÁªëÂÆöÁºñËæëÊ®°Âºè‰∫ã‰ª∂ÁõëÂê¨Âô®');
    
    // È¢úËâ≤Êõ¥Êç¢ÂäüËÉΩÂºÄÂÖ≥
    const colorReplaceToggle = document.getElementById('color-replace-toggle');
    const colorReplaceSwitch = document.getElementById('color-replace-switch');
    if (colorReplaceToggle && colorReplaceSwitch) {
        // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const newToggle = colorReplaceToggle.cloneNode(true);
        colorReplaceToggle.parentNode.replaceChild(newToggle, colorReplaceToggle);
        
        newToggle.addEventListener('click', function() {
            state.isReplaceMode = !state.isReplaceMode;
            const switchElement = this.querySelector('.toggle-switch');
            const labels = this.querySelectorAll('.toggle-label');
            
            switchElement.classList.toggle('active');
            
            // Êõ¥Êñ∞ÂºÄÂÖ≥ÊòæÁ§∫
            if (state.isReplaceMode) {
                labels[0].style.opacity = '0.5';
                labels[1].style.opacity = '1';
                labels[0].style.fontWeight = 'normal';
                labels[1].style.fontWeight = 'bold';
            } else {
                labels[0].style.opacity = '1';
                labels[1].style.opacity = '0.5';
                labels[0].style.fontWeight = 'bold';
                labels[1].style.fontWeight = 'normal';
            }
            
            console.log('È¢úËâ≤Êõ¥Êç¢ÂäüËÉΩ:', state.isReplaceMode ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠');
            
            // ‰øÆÂ§çÔºöÈáçÊñ∞Ê∏≤ÊüìÁîªÂ∏É‰ª•Â∫îÁî®ÊàñÁßªÈô§ÁÇπÂáª‰∫ã‰ª∂Ôºå‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
            renderCanvas(state.isEditMode, true);
        });
    }
    
    // È¢úËâ≤Êìç‰ΩúÊåâÈíÆ
    const highlightBtn = document.getElementById('edit-highlight-btn');
    const hideBtn = document.getElementById('edit-hide-btn');
    const clearBtn = document.getElementById('edit-clear-highlight-btn');
    
    if (highlightBtn) {
        highlightBtn.onclick = () => {
            if (state.selectedColor) {
                state.highlightedColor = state.highlightedColor === state.selectedColor ? null : state.selectedColor;
                renderCanvas(true, true); // ‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
            } else {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™È¢úËâ≤');
            }
        };
    }
    
    if (hideBtn) {
        hideBtn.onclick = () => {
            if (state.selectedColor) {
                if (state.hiddenColors.has(state.selectedColor)) {
                    state.hiddenColors.delete(state.selectedColor);
                } else {
                    state.hiddenColors.add(state.selectedColor);
                }
                renderCanvas(true, true); // ‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
            } else {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™È¢úËâ≤');
            }
        };
    }
    
    if (clearBtn) {
        clearBtn.onclick = () => {
            state.highlightedColor = null;
            state.hiddenColors.clear();
            renderCanvas(true, true); // ‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
        };
    }
    
    // ÊòæÁ§∫ÈÄâÈ°πÂ§çÈÄâÊ°Ü
    const showGridCheckbox = document.getElementById('edit-show-grid');
    const showCoordsCheckbox = document.getElementById('edit-show-coords');
    const showColorsCheckbox = document.getElementById('edit-show-colors');
    
    if (showGridCheckbox) {
        showGridCheckbox.onchange = (e) => {
            state.showGrid = e.target.checked;
            renderCanvas(true, true); // ‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
        };
    }
    
    if (showCoordsCheckbox) {
        showCoordsCheckbox.onchange = (e) => {
            state.showCoords = e.target.checked;
            renderCanvas(true, true); // ‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
        };
    }
    
    if (showColorsCheckbox) {
        showColorsCheckbox.onchange = (e) => {
            state.showColors = e.target.checked;
            renderCanvas(true, true); // ‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
        };
    }
    
    // ‰∏ãËΩΩÊåâÈíÆ
    const downloadBtn = document.getElementById('edit-download-btn');
    if (downloadBtn) {
        downloadBtn.onclick = () => {
            downloadPattern(true);
        };
    }
    
    console.log('ÁºñËæëÊ®°Âºè‰∫ã‰ª∂ÁõëÂê¨Âô®ÁªëÂÆöÂÆåÊàê');
};

const renderShoppingList = () => {
    const listItems = document.getElementById('list-items');
    listItems.innerHTML = '';
    const sorted = Object.entries(state.colorCounts).sort((a,b)=>b[1]-a[1]);
    sorted.forEach(([key, count]) => {
        const item = document.createElement('div'); 
        item.className = 'list-item';
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <div class="list-swatch" style="background:${BRAND_COLORS[state.currentBrand][key]}"></div>
            <span><strong>${key}</strong></span>
            <span style="margin-left:auto; font-weight:600;">√ó${count}</span>
        `;
        item.onclick = () => {
            state.selectedColor = key;
        };
        listItems.appendChild(item);
    });
};

// --- Color Picker Functions ---
const showColorPicker = () => {
    const colorPickerGrid = document.getElementById('color-picker-grid');
    colorPickerGrid.innerHTML = '';
    
    // Sort colors by name for better organization
    const sortedColors = Object.entries(BRAND_COLORS[state.currentBrand]);
    
    sortedColors.forEach(([key, color]) => {
        const item = document.createElement('div');
        item.className = 'color-picker-item';
        item.dataset.color = key;
        
        // Create color preview
        const colorDiv = document.createElement('div');
        colorDiv.className = 'color-picker-color';
        colorDiv.style.backgroundColor = color;
        
        // Create color label
        const label = document.createElement('div');
        label.className = 'color-picker-label';
        label.textContent = key;
        
        item.appendChild(colorDiv);
        item.appendChild(label);
        
        if (key === state.selectedCell?.color) {
            item.classList.add('selected');
        }
        
        item.onclick = () => {
            // Update selected cell with new color
            if (state.selectedCell) {
                const oldColor = state.colorData[state.selectedCell.y][state.selectedCell.x];
                state.colorData[state.selectedCell.y][state.selectedCell.x] = key;
                
                // Update color counts
                state.colorCounts[oldColor]--;
                state.colorCounts[key] = (state.colorCounts[key] || 0) + 1;
                
                // Clean up zero counts
                if (state.colorCounts[oldColor] <= 0) {
                    delete state.colorCounts[oldColor];
                }
                
                // ‰øÆÂ§çÔºöÂÖ≥ÈîÆ - ‰ΩøÁî® preserveZoom=true ‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅ
                renderCanvas(state.isEditMode, true);
                renderShoppingList();
                document.getElementById('color-picker-modal').style.display = 'none';
            }
        };
        
        colorPickerGrid.appendChild(item);
    });
    
    document.getElementById('color-picker-modal').style.display = 'flex';
};

// --- UI & Event Handlers ---
const updateStatus = () => {
    const processingModeEl = document.getElementById('processing-mode');
    const mergedRegionsEl = document.getElementById('merged-regions');
    const backgroundRemovedEl = document.getElementById('background-removed');
    
    if (processingModeEl) processingModeEl.textContent = state.processingMode;
    if (mergedRegionsEl) mergedRegionsEl.textContent = state.mergedRegions + '‰∏™Âå∫Âüü';
    if (backgroundRemovedEl) backgroundRemovedEl.textContent = state.backgroundRemoved;
};

const initializeUI = () => {
    // Brand buttons
    Object.keys(BRAND_COLORS).forEach(brand => {
        const btn = document.createElement('button'); 
        btn.className = 'brand-btn'; 
        btn.textContent = brand;
        btn.onclick = () => { 
            state.currentBrand = brand;
            state.activePalette = ALL_COLOR_KEYS[brand]; // ÈªòËÆ§‰ΩøÁî®ÂÖ®Ëâ≤Á≥ª
            document.querySelectorAll('.brand-btn').forEach(b=>b.classList.remove('active')); 
            btn.classList.add('active');
            
            // Êõ¥Êñ∞È¢ÑËÆæÊåâÈíÆÂå∫Âüü
            updatePresetButtons();
            
            // Auto process if image is loaded
            if (state.originalImage) {
                processImage();
            }
        };
        if (brand === 'MARD') btn.classList.add('active');
        document.getElementById('brand-buttons').appendChild(btn);
    });
    
    // ÂàùÂßãÂåñÈ¢ÑËÆæÊåâÈíÆ
    updatePresetButtons();
};

const updatePresetButtons = () => {
    const presetButtons = document.getElementById('preset-buttons');
    presetButtons.innerHTML = '';
    
    if (state.currentBrand === 'MARD') {
        // ÊòæÁ§∫MARDÈ¢ÑËÆæ
        Object.keys(MARD_COLOR_PRESETS).forEach(name => {
            const btn = document.createElement('button'); 
            btn.className = 'preset-btn'; 
            btn.textContent = name;
            btn.onclick = () => { 
                state.activePalette = MARD_COLOR_PRESETS[name]; 
                document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active')); 
                btn.classList.add('active'); 
                // Auto process if image is loaded
                if (state.originalImage) {
                    processImage();
                }
            };
            if (name === 'ÂÖ®Ëâ≤Á≥ª291Ëâ≤') btn.classList.add('active');
            presetButtons.appendChild(btn);
        });
    } else {
        // ÂÖ∂‰ªñÂìÅÁâåÂè™ÊòæÁ§∫ÂÖ®Ëâ≤Á≥ª
        const btn = document.createElement('button'); 
        btn.className = 'preset-btn'; 
        btn.textContent = 'ÂÖ®Ëâ≤Á≥ª';
        btn.classList.add('active');
        presetButtons.appendChild(btn);
    }
    
    // Ê∑ªÂä†Ëá™ÂÆö‰πâÊåâÈíÆ
    const customBtn = document.createElement('button'); 
    customBtn.className = 'preset-btn'; 
    customBtn.textContent = 'Ëá™ÂÆö‰πâ';
    customBtn.onclick = () => {
        const customColorSection = document.getElementById('custom-color-section');
        customColorSection.style.display = customColorSection.style.display === 'none' ? 'block' : 'none';
        if(customColorSection.style.display === 'block') renderCustomColorGrid();
    };
    presetButtons.appendChild(customBtn);
};

const renderCustomColorGrid = () => {
    const customColorGrid = document.getElementById('custom-color-grid');
    customColorGrid.innerHTML = '';
    ALL_COLOR_KEYS[state.currentBrand].forEach(key => {
        const swatch = document.createElement('div'); 
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = BRAND_COLORS[state.currentBrand][key];
        swatch.dataset.key = key;
        
        // Add tooltip
        const tooltip = document.createElement('span');
        tooltip.textContent = key;
        swatch.appendChild(tooltip);
        
        if (state.customPalette.has(key)) swatch.classList.add('active');
        swatch.onclick = () => {
            if(state.customPalette.has(key)) state.customPalette.delete(key);
            else state.customPalette.add(key);
            renderCustomColorGrid();
        };
        customColorGrid.appendChild(swatch);
    });
};

// --- File Handling ---
const handleFile = (file) => {
    if (!file) return;
    
    console.log('Â§ÑÁêÜÊñá‰ª∂:', file.name, file.type, file.size);
    
    // È™åËØÅÊñá‰ª∂Á±ªÂûã
    if (!file.type.match(/image\/(jpeg|jpg|png|gif)/i)) {
        alert('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂ (JPG, PNG, GIF)');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        console.log('Êñá‰ª∂ËØªÂèñÂÆåÊàê');
        const img = new Image();
        img.onload = () => { 
            console.log('ÂõæÁâáÂä†ËΩΩÊàêÂäüÔºåÂ∞∫ÂØ∏:', img.width, 'x', img.height);
            state.originalImage = img;
            
            // ÂàáÊç¢Âà∞‰∏ªÂ∫îÁî®ÁïåÈù¢
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            
            // Auto update dimensions based on aspect ratio
            if (img.width && img.height) {
                const aspectRatio = img.height / img.width;
                const widthInput = document.getElementById('width-input');
                const heightInput = document.getElementById('height-input');
                
                heightInput.value = Math.round(widthInput.value * aspectRatio);
            }
            
            // Auto process image
            processImage();
        };
        img.onerror = () => {
            console.error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•');
            alert('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
        };
        img.src = e.target.result;
    };
    reader.onerror = () => {
        console.error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
        alert('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    };
    reader.readAsDataURL(file);
};

// --- Event Listeners ---

// Êñ∞Â¢ûÔºöÂ∞∫ÂØ∏ËæìÂÖ•Ê°ÜÂ§ÑÁêÜÂô® - ‰øÆÂ§çÊ†∏ÂøÉÈóÆÈ¢ò
function initializeSizeInputs() {
    console.log('ÂàùÂßãÂåñÂ∞∫ÂØ∏ËæìÂÖ•Ê°ÜÂ§ÑÁêÜÂô®');
    
    const widthInput = document.getElementById('width-input');
    const heightInput = document.getElementById('height-input');
    const generateBtn = document.getElementById('generate-btn');
    
    if (!widthInput || !heightInput || !generateBtn) {
        console.warn('Â∞∫ÂØ∏ËæìÂÖ•Ê°ÜÊàñÁîüÊàêÊåâÈíÆÊú™ÊâæÂà∞');
        return;
    }
    
    // È™åËØÅËæìÂÖ•ÂÄº
    function validateSizeValue(value, min = 10, max = 200) {
        const numValue = parseInt(value);
        if (isNaN(numValue) || numValue < min) {
            return min;
        }
        if (numValue > max) {
            return max;
        }
        return numValue;
    }
    
    // Â§ÑÁêÜÂ∞∫ÂØ∏ÂèòÂåñ
    function handleSizeChange() {
        console.log('Â∞∫ÂØ∏ËæìÂÖ•ÂèòÂåñ');
        
        // È™åËØÅÂπ∂‰øÆÊ≠£ÂÄº
        widthInput.value = validateSizeValue(widthInput.value);
        heightInput.value = validateSizeValue(heightInput.value);
        
        console.log(`Êñ∞Â∞∫ÂØ∏: ${widthInput.value} x ${heightInput.value}`);
        
        // Â¶ÇÊûúÊúâÂõæÁâáÔºåËá™Âä®ÈáçÊñ∞Â§ÑÁêÜ
        if (state.originalImage) {
            processImage();
        }
    }
    
    // ‰∏∫ÂÆΩÂ∫¶ËæìÂÖ•Ê°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
    widthInput.addEventListener('input', function() {
        console.log('ÂÆΩÂ∫¶ËæìÂÖ•:', this.value);
        // Âª∂ËøüÂ§ÑÁêÜÔºåÈÅøÂÖçÈ¢ëÁπÅËß¶Âèë
        clearTimeout(widthInput.dataset.timeout);
        widthInput.dataset.timeout = setTimeout(handleSizeChange, 500);
    });
    
    widthInput.addEventListener('change', function() {
        console.log('ÂÆΩÂ∫¶Á°ÆËÆ§:', this.value);
        clearTimeout(widthInput.dataset.timeout);
        handleSizeChange();
    });
    
    widthInput.addEventListener('blur', function() {
        console.log('ÂÆΩÂ∫¶Â§±ÂéªÁÑ¶ÁÇπ:', this.value);
        clearTimeout(widthInput.dataset.timeout);
        handleSizeChange();
    });
    
    // ‰∏∫È´òÂ∫¶ËæìÂÖ•Ê°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
    heightInput.addEventListener('input', function() {
        console.log('È´òÂ∫¶ËæìÂÖ•:', this.value);
        // Âª∂ËøüÂ§ÑÁêÜÔºåÈÅøÂÖçÈ¢ëÁπÅËß¶Âèë
        clearTimeout(heightInput.dataset.timeout);
        heightInput.dataset.timeout = setTimeout(handleSizeChange, 500);
    });
    
    heightInput.addEventListener('change', function() {
        console.log('È´òÂ∫¶Á°ÆËÆ§:', this.value);
        clearTimeout(heightInput.dataset.timeout);
        handleSizeChange();
    });
    
    heightInput.addEventListener('blur', function() {
        console.log('È´òÂ∫¶Â§±ÂéªÁÑ¶ÁÇπ:', this.value);
        clearTimeout(heightInput.dataset.timeout);
        handleSizeChange();
    });
    
    // ‰∏∫ÁîüÊàêÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºàÁ°Æ‰øùÂÆÉÂ≠òÂú®Ôºâ
    generateBtn.onclick = function() {
        console.log('ÁîüÊàêÊåâÈíÆË¢´ÁÇπÂáª');
        
        // È™åËØÅÂ∞∫ÂØ∏
        widthInput.value = validateSizeValue(widthInput.value);
        heightInput.value = validateSizeValue(heightInput.value);
        
        if (!state.originalImage) {
            alert('ËØ∑ÂÖà‰∏ä‰º†ÂõæÁâáÔºÅ');
            return;
        }
        
        console.log('ÂºÄÂßãÁîüÊàêÂõæÁ∫∏ÔºåÂ∞∫ÂØ∏:', widthInput.value, 'x', heightInput.value);
        processImage();
    };
    
    // ÁßªÂä®Á´ØÁâπÊÆäÂ§ÑÁêÜ
    if ('ontouchstart' in window) {
        // Èò≤Ê≠¢iOSÁº©Êîæ
        widthInput.style.fontSize = '16px';
        heightInput.style.fontSize = '16px';
        
        // Ëß¶Êë∏‰∫ã‰ª∂
        widthInput.addEventListener('touchstart', function(e) {
            // Âª∂Ëøü‰∏Ä‰∏ãÈò≤Ê≠¢‰∏éÊªëÂä®Êù°ÂÜ≤Á™Å
            setTimeout(() => {
                this.select();
            }, 100);
        }, { passive: true });
        
        heightInput.addEventListener('touchstart', function(e) {
            setTimeout(() => {
                this.select();
            }, 100);
        }, { passive: true });
        
        // Â§ÑÁêÜÁßªÂä®Á´ØËæìÂÖ•Ê≥ï
        widthInput.addEventListener('compositionstart', function() {
            this.dataset.composing = 'true';
        });
        
        widthInput.addEventListener('compositionend', function() {
            this.dataset.composing = 'false';
            setTimeout(handleSizeChange, 100);
        });
        
        heightInput.addEventListener('compositionstart', function() {
            this.dataset.composing = 'true';
        });
        
        heightInput.addEventListener('compositionend', function() {
            this.dataset.composing = 'false';
            setTimeout(handleSizeChange, 100);
        });
    }
    
    // ËæìÂÖ•È™åËØÅ - Âè™ÂÖÅËÆ∏Êï∞Â≠ó
    widthInput.addEventListener('keydown', function(e) {
        // ÂÖÅËÆ∏Êï∞Â≠ó„ÄÅÈÄÄÊ†º„ÄÅÂà†Èô§„ÄÅÊñπÂêëÈîÆ„ÄÅTabÈîÆ
        const allowedKeys = [
            '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
            'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
            'Tab', 'Home', 'End'
        ];
        
        if (!allowedKeys.includes(e.key)) {
            e.preventDefault();
        }
    });
    
    heightInput.addEventListener('keydown', function(e) {
        const allowedKeys = [
            '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
            'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
            'Tab', 'Home', 'End'
        ];
        
        if (!allowedKeys.includes(e.key)) {
            e.preventDefault();
        }
    });
    
    // Èò≤Ê≠¢Á≤òË¥¥ÈùûÊï∞Â≠óÂÜÖÂÆπ
    widthInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = pasteData.replace(/[^0-9]/g, '');
        document.execCommand('insertText', false, numbers);
    });
    
    heightInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = pasteData.replace(/[^0-9]/g, '');
        document.execCommand('insertText', false, numbers);
    });
    
    console.log('Â∞∫ÂØ∏ËæìÂÖ•Ê°ÜÂ§ÑÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàê');
}

// ‰øÆÂ§çÔºöÂ¢ûÂº∫ÁöÑÊªëÂä®Êù°Â§ÑÁêÜÂáΩÊï∞ - ÂÆåÂÖ®Ëß£ÂÜ≥ÁßªÂä®Á´ØËæìÂÖ•ÈóÆÈ¢ò
function createSliderHandler(sliderId, valueDisplayId, inputId, callback) {
    const slider = document.getElementById(sliderId);
    const valueDisplay = document.getElementById(valueDisplayId);
    const input = document.getElementById(inputId);
    
    if (!slider || !valueDisplay || !input) return null;
    
    let isInputting = false;
    let lastValidValue = parseInt(slider.value);
    let inputTimer = null;
    
    // È™åËØÅÂπ∂ËßÑËåÉÂåñÊï∞ÂÄº
    function validateValue(value) {
        if (value === '' || value === null || value === undefined) {
            return null;
        }
        
        // ÁßªÈô§ÈùûÊï∞Â≠óÂ≠óÁ¨¶ÔºåÂÖÅËÆ∏Ë¥üÂè∑ÔºàËôΩÁÑ∂Êàë‰ª¨‰∏çÈúÄË¶ÅÔºâ
        let cleanValue = String(value).replace(/[^\d-]/g, '');
        
        if (cleanValue === '' || cleanValue === '-') {
            return null;
        }
        
        let numValue = parseInt(cleanValue);
        
        if (isNaN(numValue)) {
            return null;
        }
        
        const min = parseInt(slider.min);
        const max = parseInt(slider.max);
        
        return Math.max(min, Math.min(max, numValue));
    }
    
    // Êõ¥Êñ∞ÊâÄÊúâUIÂÖÉÁ¥†
    function updateUI(value) {
        if (value !== null) {
            slider.value = value;
            input.value = value;
            if (valueDisplay) {
                valueDisplay.textContent = value;
            }
            lastValidValue = value;
        }
    }
    
    // ÊâßË°åÂõûË∞ÉÔºàÂ¶ÇÊûúÊúâÊúâÊïàÂÄºÔºâ
    function executeCallback(value) {
        if (value !== null && callback) {
            callback(value);
        }
    }
    
    // Â§ÑÁêÜÂÄºÊõ¥Êñ∞
    function handleValueUpdate(value, immediate = false) {
        const validatedValue = validateValue(value);
        
        if (isInputting && !immediate) {
            // ËæìÂÖ•ËøáÁ®ã‰∏≠ÔºåÂè™Êõ¥Êñ∞UIÊòæÁ§∫Ôºå‰∏çÊâßË°åÂõûË∞É
            updateUI(validatedValue);
        } else {
            // ÈùûËæìÂÖ•Áä∂ÊÄÅÊàñÁ´ãÂç≥Êõ¥Êñ∞ÔºåÊõ¥Êñ∞UIÂπ∂ÊâßË°åÂõûË∞É
            updateUI(validatedValue);
            executeCallback(validatedValue);
        }
    }
    
    // ÊªëÂä®Êù°‰∫ã‰ª∂
    slider.addEventListener('input', function(e) {
        isInputting = false;
        handleValueUpdate(e.target.value, true);
    });
    
    slider.addEventListener('change', function(e) {
        isInputting = false;
        handleValueUpdate(e.target.value, true);
    });
    
    // ËæìÂÖ•Ê°Ü‰∫ã‰ª∂ - ÂÆåÂÖ®ÈáçÂÜô
    input.addEventListener('focus', function(e) {
        isInputting = true;
        // ÈÄâ‰∏≠ÊâÄÊúâÊñáÊú¨Êñπ‰æø‰øÆÊîπ
        e.target.select();
        
        // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
        if (inputTimer) {
            clearTimeout(inputTimer);
            inputTimer = null;
        }
        
        console.log('ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπ');
    });
    
    input.addEventListener('keydown', function(e) {
        // ÂÖÅËÆ∏ÊâÄÊúâÊï∞Â≠óÈîÆ„ÄÅÂà†Èô§ÈîÆ„ÄÅÊñπÂêëÈîÆ„ÄÅTabÈîÆ
        const allowedKeys = [
            '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
            'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
            'Tab', 'Home', 'End'
        ];
        
        // ÂÖÅËÆ∏Ë¥üÂè∑ÔºàËôΩÁÑ∂Êàë‰ª¨‰∏çÈúÄË¶ÅÔºâ
        if (e.key === '-') {
            // Âè™ÂÖÅËÆ∏Âú®ÂºÄÂ§¥ËæìÂÖ•Ë¥üÂè∑
            if (e.target.selectionStart !== 0 || e.target.value.includes('-')) {
                e.preventDefault();
            }
            return;
        }
        
        if (!allowedKeys.includes(e.key)) {
            e.preventDefault();
        }
    });
    
    input.addEventListener('input', function(e) {
        isInputting = true;
        
        // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
        if (inputTimer) {
            clearTimeout(inputTimer);
        }
        
        const value = e.target.value;
        console.log('ËæìÂÖ•‰∫ã‰ª∂:', value);
        
        // Â§ÑÁêÜÁ©∫ÂÄº
        if (value === '' || value === '-') {
            if (valueDisplay) {
                valueDisplay.textContent = '';
            }
            // ‰∏çÊõ¥Êñ∞ÊªëÂä®Êù°Ôºå‰øùÊåÅÂéüÂÄº
            console.log('ËæìÂÖ•‰∏∫Á©∫Ôºå‰øùÊåÅÂéüÂÄº');
            return;
        }
        
        // È™åËØÅÂπ∂Êõ¥Êñ∞ÊòæÁ§∫
        const validatedValue = validateValue(value);
        if (validatedValue !== null) {
            if (valueDisplay) {
                valueDisplay.textContent = validatedValue;
            }
            // ÂÆûÊó∂Êõ¥Êñ∞ÊªëÂä®Êù°‰ΩçÁΩÆÔºå‰ΩÜ‰∏çËß¶ÂèëÂõûË∞É
            slider.value = validatedValue;
            lastValidValue = validatedValue;
        }
    });
    
    input.addEventListener('keyup', function(e) {
        // Êüê‰∫õÁßªÂä®ËÆæÂ§áÂú®keyupÊó∂ÊâçÊõ¥Êñ∞ËæìÂÖ•Ê°ÜÂÄº
        const value = e.target.value;
        if (value === '' || value === '-') {
            return;
        }
        
        const validatedValue = validateValue(value);
        if (validatedValue !== null) {
            if (valueDisplay) {
                valueDisplay.textContent = validatedValue;
            }
            slider.value = validatedValue;
        }
    });
    
    input.addEventListener('change', function(e) {
        isInputting = false;
        console.log('ËæìÂÖ•ÂÆåÊàê:', e.target.value);
        handleValueUpdate(e.target.value, true);
    });
    
    input.addEventListener('blur', function(e) {
        isInputting = false;
        const value = e.target.value;
        
        if (value === '' || value === '-') {
            // ÊÅ¢Â§çÂà∞ÊúÄÂêéÁöÑÊúâÊïàÂÄº
            e.target.value = lastValidValue;
            updateUI(lastValidValue);
            console.log('ËæìÂÖ•‰∏∫Á©∫ÔºåÊÅ¢Â§çÂà∞:', lastValidValue);
        } else {
            console.log('Â§±ÂéªÁÑ¶ÁÇπÔºåÊõ¥Êñ∞ÂÄº:', value);
            handleValueUpdate(value, true);
        }
    });
    
    // ÁßªÂä®Á´ØÁâπÊÆäÂ§ÑÁêÜ
    if ('ontouchstart' in window) {
        // Ëß¶Êë∏ÂºÄÂßã
        input.addEventListener('touchstart', function(e) {
            isInputting = true;
            // Âª∂Ëøü‰∏Ä‰∏ãÈò≤Ê≠¢‰∏éÊªëÂä®Êù°ÂÜ≤Á™Å
            setTimeout(() => {
                e.target.focus();
                e.target.select();
            }, 100);
        }, { passive: true });
        
        // Â§ÑÁêÜÁßªÂä®Á´ØËæìÂÖ•Ê≥ï
        input.addEventListener('compositionstart', function(e) {
            isInputting = true;
            console.log('ËæìÂÖ•Ê≥ïÂºÄÂßã');
        });
        
        input.addEventListener('compositionupdate', function(e) {
            // ËæìÂÖ•Ê≥ïÊõ¥Êñ∞Êó∂‰∏çÂ§ÑÁêÜ
        });
        
        input.addEventListener('compositionend', function(e) {
            // ËæìÂÖ•Ê≥ïÁªìÊùüÂêéÂ§ÑÁêÜ
            setTimeout(() => {
                const value = e.target.value;
                if (value !== '' && value !== '-') {
                    handleValueUpdate(value, true);
                }
            }, 100);
        });
        
        // Èò≤Ê≠¢ÁßªÂä®Á´ØÁº©Êîæ
        input.style.fontSize = '16px'; // Èò≤Ê≠¢iOSÁº©Êîæ
    }
    
    // ÂàõÂª∫ÊéßÂà∂ÂØπË±°
    return {
        syncValue: (value) => {
            isInputting = false;
            handleValueUpdate(value, true);
        },
        forceUpdate: () => {
            const currentValue = input.value;
            if (currentValue !== '' && currentValue !== '-') {
                isInputting = false;
                handleValueUpdate(currentValue, true);
            }
        },
        getCurrentValue: () => lastValidValue,
        isInputting: () => isInputting,
        reset: () => {
            isInputting = false;
            updateUI(lastValidValue);
        }
    };
}

// Êñ∞Â¢ûÔºöÂàùÂßãÂåñÊâÄÊúâÂ¢ûÂº∫ÁöÑÊªëÂä®Êù°
function initializeEnhancedSliders() {
    console.log('ÂàùÂßãÂåñÂ¢ûÂº∫ÁöÑÊªëÂä®Êù°');
    
    // ‰∏ªÁïåÈù¢Áõ∏‰ººÂ∫¶ÈòàÂÄº
    const similarityHandler = createSliderHandler(
        'similarity-threshold', 
        'threshold-display', 
        'similarityThresholdInput', 
        (value) => {
            state.similarityThreshold = value;
            console.log('Áõ∏‰ººÂ∫¶ÈòàÂÄºÊõ¥Êñ∞:', value);
            if (state.originalImage) {
                processImage();
            }
        }
    );
    
    // ‰∏ªÁïåÈù¢Á∫øÊù°Âº∫Â∫¶
    const lineStrengthHandler = createSliderHandler(
        'lineStrength', 
        'lineStrengthDisplay', 
        'lineStrengthInput', 
        (value) => {
            state.lineStrength = value;
            document.getElementById('lineStrengthValue').textContent = value;
            console.log('Á∫øÊù°Âº∫Â∫¶Êõ¥Êñ∞:', value);
            if (state.originalImage && state.lineEnhance) {
                processImage();
            }
        }
    );
    
    // ÁºñËæëÊ®°ÂºèÁõ∏‰ººÂ∫¶ÈòàÂÄº
    const editSimilarityHandler = createSliderHandler(
        'edit-similarity-threshold', 
        'edit-threshold-display', 
        'edit-similarityThresholdInput', 
        (value) => {
            state.similarityThreshold = value;
            console.log('ÁºñËæëÊ®°ÂºèÁõ∏‰ººÂ∫¶ÈòàÂÄºÊõ¥Êñ∞:', value);
            
            if (state.initialMappedData && state.initialMappedData.length > 0) {
                // ÈáçÊñ∞ÊâßË°åÂå∫ÂüüÂêàÂπ∂
                const { result } = mergeSimilarRegions(
                    state.initialMappedData, 
                    state.initialMappedData[0].length, 
                    state.initialMappedData.length, 
                    value
                );
                
                state.mergedData = result;
                state.processingMode = 'Âå∫ÂüüÂêàÂπ∂';
                state.mergedRegions = countMergedRegions(state.initialMappedData, result);
                updateStatus();
                
                // ÊâßË°åËÉåÊôØÁßªÈô§
                state.externalBackground = performBackgroundRemoval(state.mergedData);
                
                // ÊâßË°åÈ¢úËâ≤ÊéíÈô§
                state.colorData = performColorExclusion(state.mergedData, state.excludedColors);
                
                // ÈáçÊñ∞ËÆ°ÁÆóÈ¢úËâ≤ËÆ°Êï∞
                state.colorCounts = {};
                for (let y = 0; y < state.colorData.length; y++) {
                    for (let x = 0; x < state.colorData[y].length; x++) {
                        if (!state.externalBackground[y][x]) {
                            const key = state.colorData[y][x];
                            state.colorCounts[key] = (state.colorCounts[key] || 0) + 1;
                        }
                    }
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìÁîªÂ∏ÉÔºà‰øùÊåÅÁº©ÊîæÁä∂ÊÄÅÔºâ
                renderCanvas(true, true);
                renderShoppingList();
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂàùÂßãÊò†Â∞ÑÊï∞ÊçÆÔºåÂàôÈáçÊñ∞Â§ÑÁêÜÊï¥‰∏™ÂõæÂÉè
                processImage();
            }
        }
    );
    
    // ÁºñËæëÊ®°ÂºèÁ∫øÊù°Âº∫Â∫¶
    const editLineStrengthHandler = createSliderHandler(
        'edit-lineStrength', 
        'edit-lineStrengthDisplay', 
        'edit-lineStrengthInput', 
        (value) => {
            state.lineStrength = value;
            document.getElementById('edit-lineStrengthValue').textContent = value;
            console.log('ÁºñËæëÊ®°ÂºèÁ∫øÊù°Âº∫Â∫¶Êõ¥Êñ∞:', value);
            
            if (state.originalImage && state.lineEnhance) {
                processImage().then(() => {
                    if (state.isEditMode) {
                        renderCanvas(true, true);
                    }
                });
            }
        }
    );
    
    // ‰øùÂ≠òÂ§ÑÁêÜÂô®ÂºïÁî®‰ª•‰æøÂÖ®Â±ÄËÆøÈóÆ
    window.sliderHandlers = {
        similarity: similarityHandler,
        lineStrength: lineStrengthHandler,
        editSimilarity: editSimilarityHandler,
        editLineStrength: editLineStrengthHandler
    };
    
    console.log('ÊªëÂä®Êù°ÂàùÂßãÂåñÂÆåÊàê');
}

// Êñ∞Â¢ûÔºöÁßªÂä®ËÆæÂ§á‰ºòÂåñÂàùÂßãÂåñ
const initializeMobileOptimizations = () => {
    // Ê£ÄÊµãÁßªÂä®ËÆæÂ§á
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        console.log('Ê£ÄÊµãÂà∞ÁßªÂä®ËÆæÂ§áÔºåÂ∫îÁî®‰ºòÂåñ');
        
        // Ë∞ÉÊï¥Áº©ÊîæÊ≠•Èïø‰ª•Êõ¥ÈÄÇÂêàÁßªÂä®ËÆæÂ§á
        state.zoomState.step = 5;
    }
};

// Êñ∞Â¢ûÔºöÁ∫øÊù°Â¢ûÂº∫ÂäüËÉΩÂàùÂßãÂåñ
const initializeLineEnhancement = () => {
    // ‰∏ªÁïåÈù¢Á∫øÊù°Â¢ûÂº∫
    const useLineEnhance = document.getElementById('useLineEnhance');
    const lineStrengthSection = document.getElementById('lineStrengthSection');
    
    if (useLineEnhance) {
        useLineEnhance.addEventListener('change', function() {
            state.lineEnhance = this.checked;
            lineStrengthSection.style.display = this.checked ? 'block' : 'none';
            
            // Â¶ÇÊûúÊúâÂõæÁâáÔºåÈáçÊñ∞Â§ÑÁêÜ
            if (state.originalImage) {
                processImage();
            }
        });
    }
    
    // ÁºñËæëÊ®°ÂºèÁ∫øÊù°Â¢ûÂº∫
    const editUseLineEnhance = document.getElementById('edit-useLineEnhance');
    const editLineStrengthSection = document.getElementById('edit-lineStrengthSection');
    
    if (editUseLineEnhance) {
        editUseLineEnhance.addEventListener('change', function() {
            state.lineEnhance = this.checked;
            editLineStrengthSection.style.display = this.checked ? 'block' : 'none';
            
            // Â¶ÇÊûúÊúâÂõæÁâáÔºåÈáçÊñ∞Â§ÑÁêÜ
            if (state.originalImage) {
                processImage().then(() => {
                    if (state.isEditMode) {
                        renderCanvas(true, true);
                    }
                });
            }
        });
    }
};

// ‰øÆÂ§ç‰∏ãËΩΩÂäüËÉΩ - iOSÂÖºÂÆπÁâàÊú¨
const downloadPattern = (isEditMode = false) => {
    if (!state.colorData || state.colorData.length === 0) {
        alert('ËØ∑ÂÖàÁîüÊàêÂõæÁ∫∏');
        return;
    }
    
    console.log('ÂºÄÂßã‰∏ãËΩΩÂõæÁ∫∏...');
    
    try {
        // ÂàõÂª∫È´òÂàÜËæ®ÁéáÁîªÂ∏É - ‰ºòÂåñiOSÂÜÖÂ≠ò‰ΩøÁî®
        const canvas = document.createElement('canvas'); 
        const ctx = canvas.getContext('2d');
        
        // ÂØπ‰∫éiOSÔºåÈôç‰ΩéÂàÜËæ®Áéá‰ª•ÈÅøÂÖçÂÜÖÂ≠òÈóÆÈ¢ò
        const isIOSDevice = isIOS();
        const hdCellSize = isIOSDevice ? 30 : 50; // iOS‰ΩøÁî®Êõ¥Â∞èÁöÑÂçïÂÖÉÊ†ºÂ§ßÂ∞è
        const coordSize = state.showCoords ? 120 : 30; // iOSÂáèÂ∞èÂùêÊ†áÂ∞∫ÂØ∏
        const padding = state.showCoords ? 150 : 40; // iOSÂáèÂ∞èÂÜÖËæπË∑ù
        
        // ËÆ°ÁÆóÂÆûÈôÖÂÜÖÂÆπËæπÁïå
        let minX = state.colorData[0].length;
        let maxX = 0;
        let minY = state.colorData.length;
        let maxY = 0;
        
        for(let y = 0; y < state.colorData.length; y++) {
            for(let x = 0; x < state.colorData[y].length; x++) {
                const key = state.colorData[y][x];
                if (!key) continue;
                
                // Âè™ÊúâÈùûËÉåÊôØÈ¢úËâ≤ËÆ°ÂÖ•ËæπÁïå
                if (!(state.externalBackground[y] && state.externalBackground[y][x])) {
                    minX = Math.min(minX, x);
                    maxX = Math.max(maxX, x);
                    minY = Math.min(minY, y);
                    maxY = Math.max(maxY, y);
                }
            }
        }
        
        // Êâ©Â±ïËæπÁïå‰ª•Á°Æ‰øùËæπÁºòÂèØËßÅ
        minX = Math.max(0, minX - 1);
        minY = Math.max(0, minY - 1);
        maxX = Math.min(state.colorData[0].length - 1, maxX + 1);
        maxY = Math.min(state.colorData.length - 1, maxY + 1);
        
        const actualWidth = maxX - minX + 1;
        const actualHeight = maxY - minY + 1;
        
        // ËÆ°ÁÆóÊùêÊñôË°®ÊâÄÈúÄÁ©∫Èó¥
        const sorted = Object.entries(state.colorCounts).sort((a,b)=>b[1]-a[1]);
        const itemsPerRow = Math.floor(isIOSDevice ? 800 / 120 : 1080 / 150); // iOSÂáèÂ∞èÂ∞∫ÂØ∏
        const rowsNeeded = Math.ceil(sorted.length / itemsPerRow);
        const listHeight = rowsNeeded * (isIOSDevice ? 80 : 110) + (isIOSDevice ? 80 : 100);
        
        // ÈáçÊñ∞ËÆ°ÁÆóÁîªÂ∏ÉÈ´òÂ∫¶ - iOS‰ΩøÁî®Êõ¥Â∞èÁöÑÂ∞∫ÂØ∏
        canvas.width = Math.min(isIOSDevice ? 800 : 1080, Math.max(actualWidth * hdCellSize + padding, 300));
        canvas.height = actualHeight * hdCellSize + padding + listHeight + (isIOSDevice ? 150 : 200);
        
        console.log(`ÁîªÂ∏ÉÂ∞∫ÂØ∏ (iOS: ${isIOSDevice}): ${canvas.width} x ${canvas.height}`);
        
        // ËÆæÁΩÆËÉåÊôØ
        ctx.imageSmoothingEnabled = false;
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ÁªòÂà∂ÂùêÊ†áÊ†áÁ≠æ
        if (state.showCoords) {
            ctx.font = `bold ${isIOSDevice ? 24 : 32}px Arial`; 
            ctx.textAlign = 'center'; 
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#333';
            
            for(let x = minX; x <= maxX; x++) {
                const label = (x + 1).toString();
                const xPos = (x - minX) * hdCellSize + hdCellSize/2 + padding/2;
                ctx.fillText(label, xPos, padding/2 - (isIOSDevice ? 30 : 40));
            }
            
            for(let y = minY; y <= maxY; y++) {
                const label = (y + 1).toString();
                const yPos = (y - minY) * hdCellSize + hdCellSize/2 + padding/2;
                ctx.fillText(label, padding/2 - (isIOSDevice ? 30 : 40), yPos);
            }
        }

        // ÁªòÂà∂ÂõæÊ°à
        const offsetX = state.showCoords ? padding/2 : 20;
        const offsetY = state.showCoords ? padding/2 : 20;
        
        for(let y = minY; y <= maxY; y++) {
            for(let x = minX; x <= maxX; x++) {
                const key = state.colorData[y][x];
                if (!key) continue;
                
                const px = (x - minX) * hdCellSize + offsetX;
                const py = (y - minY) * hdCellSize + offsetY;
                
                // Ë∑≥ËøáÈöêËóèÁöÑÈ¢úËâ≤
                if (state.hiddenColors.has(key)) {
                    ctx.fillStyle = '#f8f8f8';
                    ctx.fillRect(px, py, hdCellSize, hdCellSize);
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(px, py, hdCellSize, hdCellSize);
                    continue;
                }
                
                // Ë∑≥ËøáÂ§ñÈÉ®ËÉåÊôØÔºàÂ¶ÇÊûú‰∏çÊòæÁ§∫ËÉåÊôØÔºâ
                if (!state.showBackground && state.externalBackground[y] && state.externalBackground[y][x]) {
                    continue;
                }
                
                // ÁªòÂà∂Áè†Â≠ê
                if (state.externalBackground[y] && state.externalBackground[y][x]) {
                    ctx.fillStyle = '#f0f0f0';
                } else {
                    const color = BRAND_COLORS[state.currentBrand][key];
                    if (!color) {
                        console.warn(`È¢úËâ≤ ${key} Âú®ÂìÅÁâå ${state.currentBrand} ‰∏≠‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®ÈªòËÆ§È¢úËâ≤`);
                        ctx.fillStyle = '#ccc';
                    } else {
                        ctx.fillStyle = color;
                    }
                }
                ctx.fillRect(px, py, hdCellSize, hdCellSize);
                
                // ÁªòÂà∂ÁΩëÊ†º
                if (state.showGrid) {
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(px, py, hdCellSize, hdCellSize);
                }
                
                // È´ò‰∫ÆÁõ∏ÂêåÈ¢úËâ≤
                if (state.highlightedColor === key) {
                    ctx.fillStyle = 'rgba(255, 200, 0, 0.4)';
                    ctx.fillRect(px, py, hdCellSize, hdCellSize);
                    ctx.strokeStyle = '#ff9500';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(px, py, hdCellSize, hdCellSize);
                    ctx.lineWidth = 1;
                }
                
                // ÁªòÂà∂Ëâ≤Âè∑ - iOSÂáèÂ∞èÂ≠ó‰Ωì
                if (state.showColors && !(state.externalBackground[y] && state.externalBackground[y][x]) && !state.hiddenColors.has(key)) {
                    const color = BRAND_COLORS[state.currentBrand][key];
                    if (color) {
                        const rgb = hexToRgb(color);
                        const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                        ctx.fillStyle = brightness > 140 ? '#000' : '#fff';
                        
                        const fontSize = Math.min(hdCellSize * 0.4, isIOSDevice ? 14 : 18);
                        ctx.font = `bold ${fontSize}px Arial`;
                        ctx.textAlign = 'center'; 
                        ctx.textBaseline = 'middle';
                        
                        const text = key;
                        ctx.fillText(text, px + hdCellSize/2, py + hdCellSize/2);
                    }
                }
            }
        }
        
        // ÁªòÂà∂ÊùêÊñôÊ∏ÖÂçï - iOS‰ºòÂåñ
        const listY = actualHeight * hdCellSize + offsetY + (isIOSDevice ? 30 : 50);
        ctx.font = `bold ${isIOSDevice ? 18 : 24}px Arial`;
        ctx.fillStyle = '#333';
        ctx.textAlign = 'left';
        ctx.fillText('üì¶ ÊùêÊñôÊ∏ÖÂçï:', 30, listY);
        
        // iOS‰ºòÂåñÊùêÊñôË°®Â∏ÉÂ±Ä
        const itemWidth = isIOSDevice ? 100 : 140;
        const itemHeight = isIOSDevice ? 60 : 90;
        const itemsPerRowFixed = Math.floor((canvas.width - 60) / (itemWidth + 20));
        
        sorted.forEach(([key, count], index) => {
            const col = index % itemsPerRowFixed;
            const row = Math.floor(index / itemsPerRowFixed);
            const itemX = 30 + col * (itemWidth + 20);
            const itemY = listY + (isIOSDevice ? 30 : 50) + row * (itemHeight + 20);
            
            // Á°Æ‰øù‰∏ç‰ºöË∂ÖÂá∫ÁîªÂ∏ÉÂ∫ïÈÉ®
            if (itemY + itemHeight > canvas.height - 50) {
                console.warn(`ÊùêÊñôË°®È°πÁõÆ ${key} Ë∂ÖÂá∫ÁîªÂ∏ÉËæπÁïå`);
                return;
            }
            
            const color = BRAND_COLORS[state.currentBrand][key];
            if (color) {
                ctx.fillStyle = color;
                const swatchSize = isIOSDevice ? 30 : 45;
                ctx.fillRect(itemX, itemY, swatchSize, swatchSize);
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(itemX, itemY, swatchSize, swatchSize);
            }
            
            ctx.fillStyle = '#333';
            ctx.font = `bold ${isIOSDevice ? 14 : 18}px Arial`;
            ctx.textAlign = 'left';
            ctx.fillText(key, itemX + (isIOSDevice ? 40 : 55), itemY + (isIOSDevice ? 15 : 20));
            ctx.font = `bold ${isIOSDevice ? 12 : 16}px Arial`;
            ctx.fillText(`√ó${count}`, itemX + (isIOSDevice ? 40 : 55), itemY + (isIOSDevice ? 30 : 45));
        });
        
        // ÁªòÂà∂ÁâàÊùÉ‰ø°ÊÅØ - iOS‰ºòÂåñ
        ctx.font = `${isIOSDevice ? 12 : 14}px Arial`;
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('ÊãºË±ÜÂõæÁ∫∏ÁîüÊàêÂô®-Ë•øÁìúÂì•Âà∂‰Ωú', canvas.width/2, canvas.height - (isIOSDevice ? 40 : 60));
        ctx.fillText('ÁâàÊùÉÂ∑≤ÁôªËÆ∞Ôºå‰ªÖÊéàÊùÉ‰∫éÊ∑òÂÆùÂ∫óÈì∫ÔºöÂ§ßÂ∏àÁ≤æÂìÅËµÑÊñô', canvas.width/2, canvas.height - (isIOSDevice ? 20 : 35));
        
        // ‰ΩøÁî®iOSÂÖºÂÆπÁöÑ‰∏ãËΩΩÊñπÊ≥ï
        downloadPatternUniversal(canvas, `ÊãºË±ÜÂõæÁ∫∏_${state.currentBrand}_${new Date().getTime()}.png`);
        
        console.log('ÂõæÁ∫∏‰∏ãËΩΩÂÆåÊàê');
        
    } catch (error) {
        console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
        alert('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
};

// Ê∑ªÂä†ËæÖÂä©ÂáΩÊï∞ËÆ°ÁÆóÂêàÂπ∂Âå∫ÂüüÊï∞
function countMergedRegions(originalData, mergedData) {
    let count = 0;
    for (let y = 0; y < originalData.length; y++) {
        for (let x = 0; x < originalData[y].length; x++) {
            if (originalData[y][x] !== mergedData[y][x]) {
                count++;
            }
        }
    }
    return count;
}

// ‰øÆÂ§çÔºöÁ°Æ‰øùËæìÂÖ•Ê°ÜÊ†∑ÂºèÊîØÊåÅÁßªÂä®Á´Ø
function fixInputStyles() {
    const inputs = document.querySelectorAll('.slider-input');
    inputs.forEach(input => {
        // Èò≤Ê≠¢iOSËá™Âä®Áº©Êîæ
        input.style.fontSize = '16px';
        
        // Á°Æ‰øùËæìÂÖ•Ê°ÜÂèØ‰ª•Ëé∑ÂæóÁÑ¶ÁÇπ
        input.setAttribute('autocomplete', 'off');
        input.setAttribute('autocorrect', 'off');
        input.setAttribute('autocapitalize', 'off');
        input.setAttribute('spellcheck', 'false');
        
        // ËÆæÁΩÆinputÁ±ªÂûã‰∏∫telÔºåÂú®ÁßªÂä®Á´Ø‰ºöÂºπÂá∫Êï∞Â≠óÈîÆÁõò
        if (input.type !== 'number') {
            input.type = 'tel';
        }
        
        // ÁßªÈô§ÂèØËÉΩÂπ≤Êâ∞ÁöÑpatternÂ±ûÊÄß
        input.removeAttribute('pattern');
    });
}

// Âú®DOMÂä†ËΩΩÂÆåÊàêÂêé‰øÆÂ§çËæìÂÖ•Ê°ÜÊ†∑Âºè
document.addEventListener('DOMContentLoaded', function() {
    // Âª∂Ëøü‰∏Ä‰∏ãÁ°Æ‰øùÊâÄÊúâÂÖÉÁ¥†ÈÉΩÂ∑≤Âä†ËΩΩ
    setTimeout(fixInputStyles, 500);
});

// Âú®ÂàùÂßãÂåñÂ¢ûÂº∫ÊªëÂä®Êù°Âêé‰πü‰øÆÂ§çÊ†∑Âºè
window.addEventListener('load', function() {
    setTimeout(fixInputStyles, 100);
});

// ÂàùÂßãÂåñ‰∏ª‰∫ã‰ª∂ÁõëÂê¨Âô®
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂàùÂßãÂåñ ===');
    
    // È¶ñÂÖàÂàùÂßãÂåñÊøÄÊ¥ªÁ≥ªÁªü
    initializeActivation();
    
    // Ê∑ªÂä†Â∞∫ÂØ∏ËæìÂÖ•Ê°ÜÂàùÂßãÂåñ - ‰øÆÂ§çÊ†∏ÂøÉÈóÆÈ¢ò
    initializeSizeInputs();
    
    // ÂàùÂßãÂåñÁßªÂä®ËÆæÂ§á‰ºòÂåñ
    initializeMobileOptimizations();
    
    // ÂàùÂßãÂåñÁ∫øÊù°Â¢ûÂº∫ÂäüËÉΩ
    initializeLineEnhancement();
    
    // ÂàùÂßãÂåñÂ¢ûÂº∫ÁöÑÊªëÂä®Êù°
    initializeEnhancedSliders();
    
    // Home screen upload
    const homeUploadArea = document.getElementById('home-upload-area');
    const homeFileInput = document.getElementById('home-file-input');
    
    if (homeUploadArea && homeFileInput) {
        // ÁÇπÂáª‰∏ä‰º†
        homeUploadArea.addEventListener('click', () => {
            console.log('ÁÇπÂáª‰∏ä‰º†Âå∫Âüü');
            homeFileInput.click();
        });
        
        // Êñá‰ª∂ÈÄâÊã©
        homeFileInput.addEventListener('change', (e) => {
            console.log('Êñá‰ª∂ÈÄâÊã©ÂèòÂåñ', e.target.files);
            if (e.target.files && e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });
        
        // ÊãñÊãΩ‰∏ä‰º†
        homeUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            homeUploadArea.classList.add('dragover');
        });
        
        homeUploadArea.addEventListener('dragleave', () => {
            homeUploadArea.classList.remove('dragover');
        });
        
        homeUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            homeUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
    }
    
    // App screen upload
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    
    if (uploadArea && fileInput) {
        // ÁÇπÂáª‰∏ä‰º†
        uploadArea.addEventListener('click', () => {
            console.log('ÁÇπÂáªÂ∫îÁî®ÂÜÖ‰∏ä‰º†Âå∫Âüü');
            fileInput.click();
        });
        
        // Êñá‰ª∂ÈÄâÊã©
        fileInput.addEventListener('change', (e) => {
            console.log('Â∫îÁî®ÂÜÖÊñá‰ª∂ÈÄâÊã©ÂèòÂåñ', e.target.files);
            if (e.target.files && e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });
        
        // ÊãñÊãΩ‰∏ä‰º†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
    }
    
    // New image button
    const newImageBtn = document.getElementById('new-image-btn');
    if (newImageBtn) {
        newImageBtn.addEventListener('click', () => {
            // ËøîÂõûÈ¶ñÈ°µ
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('edit-mode-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
            
            // Ê∏ÖÁ©∫Áä∂ÊÄÅ
            state.originalImage = null;
            state.colorData = [];
            state.initialMappedData = [];
            state.mergedData = [];
            state.externalBackground = [];
            state.colorCounts = {};
            state.highlightedColor = null;
            state.hiddenColors.clear();
            state.selectedColor = null;
            state.selectedCell = null;
            state.zoomLevel = 100;
            state.isEditMode = false;
            state.isReplaceMode = false;
            
            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
            if (homeFileInput) homeFileInput.value = '';
            if (fileInput) fileInput.value = '';
        });
    }
    
    // Edit mode button
    const editModeBtn = document.getElementById('edit-mode-btn');
    const editModeScreen = document.getElementById('edit-mode-screen');
    if (editModeBtn && editModeScreen) {
        editModeBtn.addEventListener('click', () => {
            if (!state.colorData || state.colorData.length === 0) {
                alert('ËØ∑ÂÖàÂú®‰∏ªÁïåÈù¢ÁîüÊàêÂõæÁ∫∏');
                return;
            }
            
            state.isEditMode = true;
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('edit-mode-screen').style.display = 'flex';
            renderCanvas(true);
        });
    }
    
    // Back to main button - ‰øÆÂ§çËØ≠Ê≥ïÈîôËØØ
    const backToMainBtn = document.getElementById('back-to-main-btn');
    if (backToMainBtn) {
        backToMainBtn.addEventListener('click', () => {
            state.isEditMode = false;
            state.isReplaceMode = false;
            document.getElementById('edit-mode-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('home-screen').style.display = 'none';
        });
    }
    
    // iOS‰∏ãËΩΩÊèêÁ§∫ÂºπÁ™ó‰∫ã‰ª∂ÁªëÂÆö
    const iosHintClose = document.getElementById('ios-hint-close');
    const iosHintView = document.getElementById('ios-hint-view');
    
    if (iosHintClose) {
        iosHintClose.addEventListener('click', () => {
            document.getElementById('ios-download-hint').classList.remove('visible');
        });
    }
    
    if (iosHintView) {
        iosHintView.addEventListener('click', () => {
            // ËøôÈáå‰ºöË¢´Âä®ÊÄÅËÆæÁΩÆ
        });
    }
    
    // Initialize UI
    initializeUI();
});

// È¢ùÂ§ñÁöÑÂ§áÁî®ÂàùÂßãÂåñ
window.addEventListener('load', function() {
    console.log('=== È°µÈù¢ÂÆåÂÖ®Âä†ËΩΩÂÆåÊàê ===');
    // ÂÜçÊ¨°Ê£ÄÊü•ÊøÄÊ¥ªÁ≥ªÁªüÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú
    const activateBtn = document.getElementById('activate-btn');
    const activationInput = document.getElementById('activation-code');
    
    if (activateBtn && activationInput) {
        // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const hasClickListener = activateBtn.onclick || activateBtn.hasAttribute('data-click-bound');
        if (!hasClickListener) {
            console.log('Â§áÁî®ÂàùÂßãÂåñÊøÄÊ¥ªÁ≥ªÁªü');
            initializeActivation();
            activateBtn.setAttribute('data-click-bound', 'true');
        }
    }
});

</script>
</body>
</html>
